# ä»Šæ™šæŠ€æœ¯æ€»ç»“ - å®šä»·ç³»ç»Ÿå®ç°

## ğŸ“… æ—¥æœŸ
2026-01-07

## ğŸ¯ æ ¸å¿ƒç›®æ ‡
å®ç°å®Œæ•´çš„ç§¯åˆ†åˆ¶å®šä»·ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ¡£ä½å……å€¼ã€æ°¸ä¹…ç§¯åˆ† + Bonus ç§¯åˆ†ã€Stripe æ”¯ä»˜é›†æˆã€é˜²è–…æœºåˆ¶

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### 1. å®šä»·é…ç½®ç³»ç»Ÿ

#### 1.1 è®¡åˆ’é…ç½® (`lib/billing/planConfig.ts`)

**å››æ¡£å®šä»·è®¡åˆ’**ï¼š

| è®¡åˆ’ | ä»·æ ¼ | æ°¸ä¹…ç§¯åˆ† | Bonusç§¯åˆ† | Bonusè¿‡æœŸ | Payment Link ID |
|------|------|---------|-----------|-----------|----------------|
| **Starter** | $4.9 | 0 | 200 | 7å¤© | `plink_1SjMNLDqGbi6No9vUku66neA` |
| **Creator** | $39 | 2000 | 600 | 14å¤© | `plink_1SRxHLDqGbi6No9vhu7i5iud` |
| **Studio** | $99 | 6000 | 1500 | 30å¤© | `plink_1SmxBiDqGbi6No9v4L6dFvvK` |
| **Pro** | $299 | 20000 | 4000 | 60å¤© | `plink_1SNF1zDqGbi6No9vqtJXYMhQ` |

**æ¨¡å‹æ¶ˆè€—æˆæœ¬**ï¼š
- Sora: **10 credits**
- Veo Fast: **50 credits**
- Veo Pro: **250 credits**

**Starter é˜²è–…è§„åˆ™**ï¼š
- æ—¥é™é¢ï¼šSora 6æ¬¡/å¤©ï¼ŒVeo Fast 1æ¬¡/å¤©
- Veo Pro é”å®šï¼ˆä¸å…è®¸ä½¿ç”¨ï¼‰
- é™è´­ï¼šæ¯è´¦å·/è®¾å¤‡ä»…é™ä¸€æ¬¡ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
- IP /24 æ®µæ¯å¤©æœ€å¤š 3 ä¸ª Starter è´­ä¹°
- âš ï¸ **å½“å‰ç‰ˆæœ¬**ï¼šåªä½¿ç”¨ device_id + IPï¼Œpayment_fingerprint å¾…è¡¥ï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼‰

#### 1.2 ç»Ÿä¸€é…ç½® (`lib/billing/config.ts`)

**âš ï¸ é‡è¦**ï¼š`config.ts` åº”è¯¥ä» `planConfig.ts` å¯¼å…¥ç§¯åˆ†æ•°æ®ï¼Œä¸è¦é‡å¤å®šä¹‰ã€‚

**å½“å‰é—®é¢˜**ï¼š`config.ts` ä¸­æœ‰å¦ä¸€å¥—ç§¯åˆ†æ•°å­—ï¼ˆStarter 120 vs planConfig 200ï¼‰ï¼Œä¼šå¯¼è‡´å‘å¸ä¸ä¸€è‡´ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š`config.ts` çš„ `plans` åº”è¯¥ç›´æ¥å¼•ç”¨ `PLAN_CONFIGS`ï¼Œåªä¿ç•™ UI é…ç½®ã€‚

**å•ä¸€æ•°æ®æºè®¾è®¡**ï¼š
- âœ… `planConfig.ts` æ˜¯å”¯ä¸€çœŸç›¸ï¼ˆç§¯åˆ†æ•°å­—ã€Payment Link IDï¼‰
- âœ… `config.ts` ä» `planConfig.ts` å¯¼å…¥ï¼Œåªæ·»åŠ  UI é…ç½®
- âš ï¸ **å¿…é¡»ä¿®å¤**ï¼šåˆ é™¤ `config.ts` ä¸­é‡å¤çš„ç§¯åˆ†æ•°å­—

**æ ¸å¿ƒé…ç½®é¡¹**ï¼ˆä¿®å¤åï¼‰ï¼š
```typescript
import { PLAN_CONFIGS } from './planConfig';

export const PRICING_CONFIG = {
  currency: "USD",
  modelCosts: { sora: 10, veo_fast: 50, veo_pro: 250 },
  plans: {
    starter: {
      ...PLAN_CONFIGS.starter, // ä» planConfig å¯¼å…¥
      ui: { /* UI é…ç½® */ },
    creator: { priceUsd: 39, permanentCredits: 600, bonusCredits: 60, ... },
    studio: { priceUsd: 99, permanentCredits: 1800, bonusCredits: 270, ... },
    pro: { priceUsd: 299, permanentCredits: 6000, bonusCredits: 1200, ... }
  }
}
```

---

### 2. æ•°æ®åº“ç³»ç»Ÿ

#### 2.1 æ ¸å¿ƒè¡¨ç»“æ„ (`supabase/migrations/0001_billing.sql`)

**`profiles` è¡¨**ï¼š
- ç”¨é€”ï¼šWebhook é€šè¿‡ email æŸ¥æ‰¾ user_id
- å­—æ®µï¼š`id` (uuid), `email` (unique), `created_at`

**`wallets` è¡¨**ï¼š
- ç”¨é€”ï¼šç”¨æˆ·é’±åŒ…ï¼Œå­˜å‚¨æ°¸ä¹…ç§¯åˆ†å’Œ Bonus ç§¯åˆ†
- å­—æ®µï¼š
  - `user_id` (primary key)
  - `permanent_credits` (bigint, default 0)
  - `bonus_credits` (bigint, default 0)
  - `bonus_expires_at` (timestamptz, nullable)
  - `updated_at` (timestamptz)

**`wallet_ledger` è¡¨**ï¼š
- ç”¨é€”ï¼šå®¡è®¡è´¦æœ¬ï¼Œè®°å½•æ‰€æœ‰ç§¯åˆ†å˜åŠ¨
- å­—æ®µï¼š
  - `id` (bigserial)
  - `user_id` (uuid)
  - `delta_permanent` (bigint)
  - `delta_bonus` (bigint)
  - `reason` (text)
  - `ref_type`, `ref_id` (ç”¨äºå…³è”ä¸šåŠ¡å¯¹è±¡)
  - `created_at` (timestamptz)

**`purchases` è¡¨**ï¼š
- ç”¨é€”ï¼šè´­ä¹°è®°å½•ï¼Œå¹‚ç­‰æ€§é”šç‚¹
- å­—æ®µï¼š
  - `id` (bigserial)
  - `user_id` (uuid)
  - `plan_id` (text)
  - `payment_link_id` (text)
  - `stripe_event_id` (text, unique) â­ **å¹‚ç­‰æ€§å…³é”®**
  - `stripe_session_id` (text, unique)
  - `stripe_payment_intent_id` (text, unique)
  - `email`, `amount_total`, `currency`, `status`
  - `created_at` (timestamptz)

**`pending_credit_grants` è¡¨**ï¼š
- ç”¨é€”ï¼šæ‰¾ä¸åˆ°ç”¨æˆ·æ—¶æš‚å­˜è´­ä¹°è®°å½•
- å­—æ®µï¼šä¸ `purchases` ç±»ä¼¼ï¼Œç”¨äºåç»­å¤„ç†

**`starter_purchase_guards` è¡¨**ï¼š
- ç”¨é€”ï¼šStarter é˜²è–…æœºåˆ¶
- å­—æ®µï¼š`user_id`, `device_id`, `ip`, `email`, `created_at`
- âš ï¸ **å½“å‰ç‰ˆæœ¬**ï¼šæ²¡æœ‰ `payment_fingerprint`, `payment_last4` å­—æ®µï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼Œå¾…è¡¥ï¼‰
- ç´¢å¼•ï¼š`(ip, created_at)`, `(device_id, created_at)`

#### 2.2 æ ¸å¿ƒ SQL å‡½æ•°

**`ensure_wallet(p_user_id)`**ï¼š
- ç¡®ä¿ç”¨æˆ·é’±åŒ…å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰

**`grant_credits_for_purchase(...)`**ï¼š
- åŸå­æ€§å‘å¸å‡½æ•° âœ…ï¼ˆSQLä¸­å­˜åœ¨ï¼‰
- å¹‚ç­‰æ€§ï¼šé€šè¿‡ `stripe_event_id` unique çº¦æŸä¿è¯
- åŠŸèƒ½ï¼š
  1. æ’å…¥è´­ä¹°è®°å½•ï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™è·³è¿‡ï¼‰
  2. æ ¹æ® `plan_id` è®¡ç®—æ°¸ä¹…ç§¯åˆ†å’Œ Bonus ç§¯åˆ†ï¼ˆä½¿ç”¨ planConfig.ts çš„å€¼ï¼‰
  3. æ›´æ–°é’±åŒ…ä½™é¢
  4. è®°å½•è´¦æœ¬
- âš ï¸ **æ³¨æ„**ï¼šä»£ç ä¸­æœ‰äº›åœ°æ–¹è°ƒç”¨ `apply_purchase`ï¼Œéœ€è¦æ”¹ä¸º `grant_credits_for_purchase`

**`deduct_credits_from_wallet(p_user_id, p_model_id, p_cost, p_ref_id)`**ï¼š
- æ‰£é™¤ç§¯åˆ†å‡½æ•°
- è§„åˆ™ï¼š
  - **è‡ªåŠ¨è¿‡æœŸæ£€æŸ¥**ï¼šBonus ç§¯åˆ†è¿‡æœŸè‡ªåŠ¨æ¸…é›¶
  - **Veo Pro ç‰¹æ®Šè§„åˆ™**ï¼šåªä½¿ç”¨æ°¸ä¹…ç§¯åˆ†ï¼ˆä¿æŠ¤ç°é‡‘æµï¼‰
  - **å…¶ä»–æ¨¡å‹**ï¼šBonus ä¼˜å…ˆï¼Œä¸è¶³å†ç”¨æ°¸ä¹…ç§¯åˆ†
- è¿”å›ï¼š`(permanent_spent, bonus_spent)`

---

### 3. API å®ç°

#### 3.1 æ”¯ä»˜ Webhook

**âš ï¸ é‡è¦**ï¼šä»£ç ä¸­æœ‰ä¸¤ä¸ª webhook æ–‡ä»¶ï¼Œéœ€è¦ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªï¼š

- `app/api/stripe/webhook/route.ts` - âœ… ä½¿ç”¨ `grant_credits_for_purchase`ï¼ˆä¸SQLåŒ¹é…ï¼‰
- `app/api/payment/webhook/route.ts` - âŒ ä½¿ç”¨ `apply_purchase`ï¼ˆSQLä¸­æ²¡æœ‰æ­¤å‡½æ•°ï¼‰

**å¿…é¡»ç¡®è®¤**ï¼šStripe Dashboard é…ç½®çš„ endpoint URL æŒ‡å‘å“ªä¸ªæ–‡ä»¶ã€‚

**åŠŸèƒ½**ï¼šå¤„ç† Stripe Checkout Session å®Œæˆäº‹ä»¶

**æµç¨‹**ï¼š
1. **éªŒè¯ç­¾å**ï¼šä½¿ç”¨ `STRIPE_WEBHOOK_SECRET` éªŒè¯è¯·æ±‚
2. **å¹‚ç­‰æ€§æ£€æŸ¥**ï¼šæŸ¥è¯¢ `purchases` è¡¨ï¼Œæ£€æŸ¥ `stripe_event_id` æ˜¯å¦å·²å¤„ç†
3. **è®¡åˆ’è¯†åˆ«**ï¼ˆç»Ÿä¸€ç­–ç•¥ï¼‰ï¼š
   - âœ… ä¼˜å…ˆï¼šä» `metadata.plan_id` è·å–ï¼ˆæœ€ç¨³å®šï¼‰
   - âœ… å›é€€ï¼šä» `payment_link_id` â†’ `planFromPaymentLink()` è¯†åˆ«
   - âŒ **ä¸è¦ç”¨é‡‘é¢å…œåº•**ï¼šå®¹æ˜“è¯¯åˆ¤ï¼Œå¿…é¡»ç”¨ metadata æˆ– payment_link
4. **ç”¨æˆ·è¯†åˆ«**ï¼š
   - ä¼˜å…ˆï¼š`metadata.user_id`
   - å›é€€ï¼š`client_reference_id`
   - å…œåº•ï¼šé€šè¿‡ `customer_email` æŸ¥æ‰¾ç”¨æˆ·
5. **åº”ç”¨è´­ä¹°**ï¼š
   - è°ƒç”¨ `grant_credits_for_purchase` RPC å‡½æ•°ï¼ˆåŸå­æ€§ï¼‰âš ï¸ **æ³¨æ„**ï¼šä¸æ˜¯ `apply_purchase`
   - è®°å½•è´­ä¹°åˆ° `purchases` è¡¨
   - âš ï¸ **å½“å‰ç‰ˆæœ¬**ï¼šé£æ§ä¿¡æ¯åªè®°å½• `ip_prefix`ï¼Œ`payment_fingerprint` éœ€è¦ä» PaymentIntent è·å–ï¼ˆå¾…è¡¥ï¼‰

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… å¹‚ç­‰æ€§ä¿è¯ï¼ˆåŒä¸€ event ä¸é‡å¤å¤„ç†ï¼‰
- âœ… åŸå­æ€§æ“ä½œï¼ˆRPC å‡½æ•°ï¼‰
- âš ï¸ **å½“å‰ç‰ˆæœ¬**ï¼šåªæ”¯æŒä¸€ç§æ–¹å¼ï¼ˆPayment Link æˆ– Checkout Sessionï¼‰ï¼Œéœ€è¦ç»Ÿä¸€
- âš ï¸ **é£æ§ä¿¡æ¯**ï¼šå½“å‰åªè®°å½• IPï¼Œpayment_fingerprint å¾…è¡¥

#### 3.2 åˆ›å»º Checkout Session (`app/api/checkout/create/route.ts`)

**åŠŸèƒ½**ï¼šåˆ›å»º Stripe Checkout Session

**æµç¨‹**ï¼š
1. éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆJWT tokenï¼‰
2. éªŒè¯è®¡åˆ’ ID
3. Starter é£æ§æ£€æŸ¥ï¼ˆè°ƒç”¨ `can_purchase_starter` RPCï¼‰
4. åˆ›å»º Checkout Sessionï¼š
   - ä½¿ç”¨ `line_items` è®¾ç½®ä»·æ ¼ï¼ˆä¸æ”¯æŒ `payment_link` å‚æ•°ï¼‰
   - è®¾ç½® `metadata` ä¼ é€’ `user_id`, `plan_id`, `amount_usd`
   - è®¾ç½®æˆåŠŸ/å–æ¶ˆ URL

**ä¿®å¤**ï¼š
- âŒ åŸé—®é¢˜ï¼š`payment_link` ä¸æ˜¯ `checkout.sessions.create` çš„æœ‰æ•ˆå‚æ•°
- âœ… ä¿®å¤ï¼šä½¿ç”¨ `line_items` åŠ¨æ€åˆ›å»ºä»·æ ¼

#### 3.3 åˆ›å»ºè®¡åˆ’ Checkout (`app/api/payment/create-plan-checkout/route.ts`)

**åŠŸèƒ½**ï¼šä¸ºç‰¹å®šè®¡åˆ’åˆ›å»º Checkout Session

**ç‰¹æ€§**ï¼š
- Starter é£æ§æ£€æŸ¥ï¼ˆè®¾å¤‡ã€IPã€æ”¯ä»˜æŒ‡çº¹ï¼‰
- æ”¯æŒ `deviceId` å‚æ•°
- å®Œæ•´çš„é”™è¯¯å¤„ç†

#### 3.4 æ‰£å¸é€»è¾‘ (`lib/billing/charge.ts`)

**åŠŸèƒ½**ï¼šåœ¨è§†é¢‘ç”Ÿæˆå‰æ‰£é™¤ç§¯åˆ†

**æµç¨‹**ï¼š
1. **Starter é™åˆ¶æ£€æŸ¥**ï¼š
   - ç¦æ­¢ Veo Pro
   - æ£€æŸ¥æ—¥é™é¢ï¼ˆSora 6æ¬¡/å¤©ï¼ŒVeo Fast 1æ¬¡/å¤©ï¼‰
2. **æ‰£é™¤ç§¯åˆ†**ï¼š
   - è°ƒç”¨ `deduct_credits_from_wallet` RPC âœ…ï¼ˆSQLä¸­å­˜åœ¨ï¼‰
   - Bonus ä¼˜å…ˆï¼Œè‡ªåŠ¨è¿‡æœŸæ£€æŸ¥
3. **è®°å½•ä½¿ç”¨é‡**ï¼š
   - âš ï¸ **æ³¨æ„**ï¼šä»£ç ä¸­è°ƒç”¨ `increment_usage_daily`ï¼Œéœ€è¦ç¡®è®¤ SQL ä¸­æ˜¯å¦å­˜åœ¨æ­¤å‡½æ•°

**ä¿®å¤**ï¼š
- âŒ åŸé—®é¢˜ï¼š`starterRules` å±æ€§ä¸å­˜åœ¨
- âœ… ä¿®å¤ï¼šä½¿ç”¨ `dailyCaps` å±æ€§æ›¿ä»£

---

### 4. æ„å»ºä¿®å¤

#### 4.1 é‡å¤å˜é‡å®šä¹‰
**æ–‡ä»¶**ï¼š`app/api/payment/webhook/route.ts`
- ä¿®å¤ï¼š`const amountUsd` â†’ `let amountUsd`ï¼ˆç¬¬90è¡Œï¼‰ï¼Œç§»é™¤ç¬¬350è¡Œçš„ `const`

#### 4.2 æœªä½¿ç”¨çš„å¯¼å…¥
- ç§»é™¤ï¼š`extractClientIp`, `itemIdFromAmount`, `Stripe` ç±»å‹
- ä¿®å¤ï¼š`let stripeCustomerId` â†’ `const stripeCustomerId`

#### 4.3 TypeScript ç±»å‹é”™è¯¯
- **é”™è¯¯å¤„ç†**ï¼š`any` â†’ `unknown` + ç±»å‹æ£€æŸ¥
- **Stripe API**ï¼š`payment_link` â†’ `line_items`
- **Supabase RPC**ï¼šæ·»åŠ  `@ts-expect-error` å’Œç±»å‹æ–­è¨€
- **è®¡åˆ’é…ç½®**ï¼š`starterRules` â†’ `dailyCaps`
- **ç”¨æˆ·æƒé™**ï¼šæ·»åŠ æ˜ç¡®çš„ç±»å‹æ–­è¨€

#### 4.4 æœªä½¿ç”¨çš„å‚æ•°
- æ·»åŠ  ESLint ç¦ç”¨æ³¨é‡Šï¼ˆä¿ç•™å‚æ•°ç”¨äºç±»å‹å…¼å®¹æ€§ï¼‰

---

## ğŸ” å®‰å…¨ä¸é£æ§

### 1. å¹‚ç­‰æ€§ä¿è¯
- **æ•°æ®åº“å±‚é¢**ï¼š`purchases.stripe_event_id` unique çº¦æŸ
- **åº”ç”¨å±‚é¢**ï¼šWebhook å¤„ç†å‰æ£€æŸ¥æ˜¯å¦å·²å¤„ç†

### 2. Starter é˜²è–…æœºåˆ¶
- **é™è´­è§„åˆ™**ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰ï¼š
  - æ¯è´¦å·ä»…é™ä¸€æ¬¡
  - æ¯è®¾å¤‡ä»…é™ä¸€æ¬¡ï¼ˆdevice_idï¼‰
  - IP /24 æ®µæ¯å¤©æœ€å¤š 3 ä¸ª
- âš ï¸ **å¾…è¡¥**ï¼šæ”¯ä»˜æŒ‡çº¹æ£€æŸ¥ï¼ˆéœ€è¦ä» PaymentIntent è·å– card fingerprintï¼‰
- **æ—¥é™é¢**ï¼š
  - Sora: 6æ¬¡/å¤©
  - Veo Fast: 1æ¬¡/å¤©
  - Veo Pro: é”å®š

### 3. é£æ§ä¿¡æ¯è®°å½•
- âš ï¸ **å½“å‰ç‰ˆæœ¬**ï¼š
  - `ip_prefix`ï¼šIP /24 å‰ç¼€ âœ…ï¼ˆå·²å®ç°ï¼‰
  - `stripe_customer_id`ï¼šStripe å®¢æˆ· ID âœ…ï¼ˆå·²å®ç°ï¼‰
- âš ï¸ **å¾…è¡¥**ï¼š
  - `payment_fingerprint`ï¼šéœ€è¦ä» PaymentIntent â†’ Charge â†’ payment_method_details.card.fingerprint è·å–
  - `payment_last4`ï¼šéœ€è¦ä» PaymentIntent è·å–
  - `ip_hash`ï¼šå¯é€‰ï¼Œå½“å‰ä½¿ç”¨ ip_prefix å·²è¶³å¤Ÿ

---

## ğŸ’° ç§¯åˆ†ç³»ç»Ÿè®¾è®¡

### 1. ç§¯åˆ†ç±»å‹
- **æ°¸ä¹…ç§¯åˆ†**ï¼šæ°¸ä¸è¿‡æœŸï¼Œå¯ç”¨äºæ‰€æœ‰æ¨¡å‹
- **Bonus ç§¯åˆ†**ï¼šæœ‰æ—¶é—´é™åˆ¶ï¼Œè¿‡æœŸè‡ªåŠ¨æ¸…é›¶

### 2. æ‰£å¸è§„åˆ™
- **Veo Pro**ï¼šåªä½¿ç”¨æ°¸ä¹…ç§¯åˆ†ï¼ˆä¿æŠ¤ç°é‡‘æµï¼‰âš ï¸ **å¿…é¡»åœ¨å‰ç«¯è¯´æ˜ï¼Œå¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—è¢«å‘**
- **å…¶ä»–æ¨¡å‹**ï¼šBonus ä¼˜å…ˆï¼Œä¸è¶³å†ç”¨æ°¸ä¹…ç§¯åˆ†
- **è‡ªåŠ¨è¿‡æœŸ**ï¼šæ‰£å¸æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸ Bonus

**å‰ç«¯è¯´æ˜å»ºè®®**ï¼š
- åœ¨ Pricing é¡µé¢æˆ– FAQ æ·»åŠ ï¼š"Veo Pro uses permanent credits only. Bonus credits are for Sora Preview and Veo Fast."

### 3. è´¦æœ¬ç³»ç»Ÿ
- æ‰€æœ‰ç§¯åˆ†å˜åŠ¨éƒ½è®°å½•åˆ° `wallet_ledger`
- åŒ…å«ï¼šåŸå› ã€å…³è”å¯¹è±¡ç±»å‹å’Œ ID
- ç”¨äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥

---

## ğŸ”„ æ”¯ä»˜æµç¨‹

### 1. ç”¨æˆ·è´­ä¹°æµç¨‹
```
ç”¨æˆ·é€‰æ‹©è®¡åˆ’
  â†“
åˆ›å»º Checkout Session (API)
  â†“
è·³è½¬åˆ° Stripe æ”¯ä»˜é¡µé¢
  â†“
æ”¯ä»˜æˆåŠŸ
  â†“
Stripe Webhook é€šçŸ¥
  â†“
Webhook å¤„ç†ï¼ˆå¹‚ç­‰æ€§æ£€æŸ¥ + å‘å¸ï¼‰
  â†“
ç”¨æˆ·é’±åŒ…æ›´æ–°
```

### 2. è§†é¢‘ç”Ÿæˆæµç¨‹
```
ç”¨æˆ·å‘èµ·ç”Ÿæˆè¯·æ±‚
  â†“
æ£€æŸ¥ Starter æ—¥é™é¢ï¼ˆå¦‚é€‚ç”¨ï¼‰
  â†“
æ‰£é™¤ç§¯åˆ†ï¼ˆBonus ä¼˜å…ˆï¼‰
  â†“
è®°å½•ä½¿ç”¨é‡
  â†“
å¼€å§‹ç”Ÿæˆ
```

---

## ğŸ“Š æŠ€æœ¯æ ˆ

- **å‰ç«¯**ï¼šNext.js 14, React, TypeScript
- **åç«¯**ï¼šNext.js API Routes
- **æ•°æ®åº“**ï¼šSupabase (PostgreSQL)
- **æ”¯ä»˜**ï¼šStripe Checkout Session
- **éƒ¨ç½²**ï¼šVercel (æ¨æµ‹)

---

## âœ… å®ŒæˆçŠ¶æ€

### å·²å®Œæˆ
- âœ… å®šä»·é…ç½®ç³»ç»Ÿï¼ˆ4æ¡£è®¡åˆ’ï¼‰
- âœ… æ•°æ®åº“è¡¨ç»“æ„ï¼ˆé’±åŒ…ã€è´¦æœ¬ã€è´­ä¹°è®°å½•ï¼‰
- âœ… SQL å‡½æ•°ï¼ˆå‘å¸ã€æ‰£å¸ã€è¿‡æœŸæ£€æŸ¥ï¼‰
- âœ… Webhook å¤„ç†ï¼ˆå¹‚ç­‰æ€§ã€é£æ§ï¼‰
- âœ… Checkout Session åˆ›å»º
- âœ… æ‰£å¸é€»è¾‘ï¼ˆBonus ä¼˜å…ˆã€è‡ªåŠ¨è¿‡æœŸï¼‰
- âœ… Starter é˜²è–…æœºåˆ¶ï¼ˆdevice + IPï¼‰
- âœ… æ„å»ºä¿®å¤ï¼ˆæ‰€æœ‰ TypeScript é”™è¯¯ï¼‰

### âš ï¸ å¿…é¡»ä»Šæ™šä¿®å¤ï¼ˆè§ `ç´§æ€¥ä¿®å¤è¡¥ä¸_å¿…é¡»ä»Šæ™šå®Œæˆ.md`ï¼‰
1. âŒ **å®šä»·æ•°æ®æºä¸ä¸€è‡´**ï¼š`config.ts` å’Œ `planConfig.ts` ç§¯åˆ†æ•°å­—ä¸ä¸€è‡´
2. âŒ **Webhook è·¯å¾„ä¸ç»Ÿä¸€**ï¼šä¸¤ä¸ª webhook æ–‡ä»¶ï¼Œéœ€è¦ç¡®è®¤ä½¿ç”¨å“ªä¸ª
3. âŒ **RPC å‡½æ•°åä¸åŒ¹é…**ï¼šä»£ç è°ƒç”¨ `apply_purchase`ï¼ŒSQL ä¸­æ˜¯ `grant_credits_for_purchase`
4. âš ï¸ **Starter é˜²è–…å­—æ®µç¼ºå¤±**ï¼šæ²¡æœ‰ payment_fingerprintï¼ˆä»Šæ™šå…ˆç”¨ device + IPï¼‰
5. âš ï¸ **Webhook è¯†åˆ«ç­–ç•¥**ï¼šä¸è¦ç”¨é‡‘é¢å…œåº•ï¼Œåªç”¨ metadata æˆ– payment_link
6. âš ï¸ **Veo Pro è§„åˆ™è¯´æ˜**ï¼šå‰ç«¯éœ€è¦æ·»åŠ è¯´æ˜

### å¾…ä¼˜åŒ–ï¼ˆæ˜å¤©ï¼‰
- âš ï¸ React Hook ä¾èµ–é¡¹è­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
- âš ï¸ å›¾ç‰‡ä¼˜åŒ–å»ºè®®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âš ï¸ payment_fingerprint æ”¯æŒï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼‰

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆ`0001_billing.sql`ï¼‰
- [ ] é…ç½® Stripe Webhook Secret
- [ ] éªŒè¯ Payment Link IDs
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹
- [ ] æµ‹è¯• Webhook å¤„ç†
- [ ] éªŒè¯ç§¯åˆ†æ‰£é™¤é€»è¾‘
- [ ] éªŒè¯ Starter é˜²è–…æœºåˆ¶

---

## ğŸ“ å…³é”®æ–‡ä»¶æ¸…å•

### é…ç½®
- `lib/billing/planConfig.ts` - è®¡åˆ’é…ç½®
- `lib/billing/config.ts` - ç»Ÿä¸€é…ç½®

### æ•°æ®åº“
- `supabase/migrations/0001_billing.sql` - æ•°æ®åº“è¿ç§»

### API
- `app/api/payment/webhook/route.ts` - Webhook å¤„ç†
- `app/api/checkout/create/route.ts` - åˆ›å»º Checkout
- `app/api/payment/create-plan-checkout/route.ts` - è®¡åˆ’ Checkout

### ä¸šåŠ¡é€»è¾‘
- `lib/billing/charge.ts` - æ‰£å¸é€»è¾‘
- `lib/billing/wallet.ts` - é’±åŒ…æ“ä½œ
- `lib/billing/get-user-entitlements.ts` - ç”¨æˆ·æƒç›Š

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

1. **å¹‚ç­‰æ€§è®¾è®¡**ï¼šæ•°æ®åº“ unique çº¦æŸ + åº”ç”¨å±‚æ£€æŸ¥
2. **åŸå­æ€§æ“ä½œ**ï¼šä½¿ç”¨ PostgreSQL å‡½æ•°ä¿è¯æ•°æ®ä¸€è‡´æ€§
3. **é˜²è–…æœºåˆ¶**ï¼šå¤šç»´åº¦é™åˆ¶ï¼ˆè´¦å·ã€è®¾å¤‡ã€IPã€æ”¯ä»˜æŒ‡çº¹ï¼‰
4. **Bonus ç§¯åˆ†ç­–ç•¥**ï¼šè¿‡æœŸè‡ªåŠ¨æ¸…ç†ï¼Œæ‰£å¸æ—¶ä¼˜å…ˆä½¿ç”¨
5. **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰é…ç½®é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `BUILD_FIX_SUMMARY.md` - æ„å»ºä¿®å¤æ€»ç»“
- `ç´§æ€¥ä¿®å¤è¡¥ä¸_å¿…é¡»ä»Šæ™šå®Œæˆ.md` - âš ï¸ **å¿…é¡»é˜…è¯»**ï¼š6ä¸ªè‡´å‘½é—®é¢˜ä¿®å¤æ–¹æ¡ˆ
- `COMPLETE_BILLING_SYSTEM_IMPLEMENTATION.md` - å®Œæ•´å®ç°æ–‡æ¡£
- `FINAL_BILLING_SYSTEM_READY.md` - æœ€ç»ˆç³»ç»Ÿæ–‡æ¡£

---

## âš ï¸ é‡è¦æé†’

**æ€»ç»“**ï¼šä»Šæ™šå®Œæˆäº†ç§¯åˆ†åˆ¶å®šä»·ç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„ï¼Œä½†å‘ç° **6ä¸ªå…³é”®é—®é¢˜** å¿…é¡»ä¿®å¤åæ‰èƒ½ä¸Šçº¿ï¼š

1. å®šä»·æ•°æ®æºä¸ä¸€è‡´ï¼ˆä¼šå¯¼è‡´å‘å¸é”™è¯¯ï¼‰
2. Webhook è·¯å¾„å’Œ RPC å‡½æ•°åä¸åŒ¹é…ï¼ˆä¼šå¯¼è‡´ 500 é”™è¯¯ï¼‰
3. Starter é˜²è–…å­—æ®µç¼ºå¤±ï¼ˆå½“å‰ç‰ˆæœ¬å…ˆç”¨ device + IPï¼‰
4. Webhook è¯†åˆ«ç­–ç•¥éœ€è¦ç»Ÿä¸€ï¼ˆä¸è¦ç”¨é‡‘é¢å…œåº•ï¼‰
5. Veo Pro è§„åˆ™éœ€è¦å‰ç«¯è¯´æ˜

**ä¸‹ä¸€æ­¥**ï¼šè¯·ç«‹å³æŸ¥çœ‹ `ç´§æ€¥ä¿®å¤è¡¥ä¸_å¿…é¡»ä»Šæ™šå®Œæˆ.md`ï¼ŒæŒ‰ä¼˜å…ˆçº§ä¿®å¤è¿™ 6 ä¸ªé—®é¢˜ã€‚

