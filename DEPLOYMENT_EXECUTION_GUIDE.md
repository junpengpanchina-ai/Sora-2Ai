# ğŸš€ éƒ¨ç½²æ‰§è¡ŒæŒ‡å— - 3 ä¸ªå…³é”®æ­¥éª¤

## âœ… æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

### 1.1 ç™»å½• Supabase Dashboard

1. è®¿é—® https://supabase.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®ï¼ˆSora-2Aiï¼‰
3. åœ¨å·¦ä¾§èœå•ç‚¹å‡» **"SQL Editor"**

### 1.2 æ‰§è¡Œè¿ç§»æ–‡ä»¶

1. ç‚¹å‡» **"New query"** åˆ›å»ºæ–°æŸ¥è¯¢
2. æ‰“å¼€é¡¹ç›®æ–‡ä»¶ï¼š`supabase/migrations/049_add_wallet_system_complete.sql`
3. **å¤åˆ¶å…¨éƒ¨å†…å®¹**ï¼ˆ298è¡Œï¼‰
4. ç²˜è´´åˆ° Supabase SQL Editor
5. ç‚¹å‡» **"Run"** æ‰§è¡Œ

### 1.3 éªŒè¯è¿ç§»æˆåŠŸ

åœ¨ SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹éªŒè¯æŸ¥è¯¢ï¼š

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('wallets', 'user_entitlements', 'usage_daily', 'purchases', 'risk_devices')
ORDER BY table_name;

-- åº”è¯¥è¿”å› 5 è¡Œï¼š
-- purchases
-- risk_devices
-- usage_daily
-- user_entitlements
-- wallets

-- æ£€æŸ¥å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN ('deduct_credits', 'check_and_increment_daily_usage', 'apply_purchase')
ORDER BY routine_name;

-- åº”è¯¥è¿”å› 3 è¡Œï¼š
-- apply_purchase
-- check_and_increment_daily_usage
-- deduct_credits
```

âœ… **å¦‚æœçœ‹åˆ° 5 ä¸ªè¡¨å’Œ 3 ä¸ªå‡½æ•°ï¼Œè¿ç§»æˆåŠŸï¼**

---

## âœ… æ­¥éª¤ 2: è®¾ç½®ç¯å¢ƒå˜é‡ STRIPE_SECRET_KEY

### 2.1 è·å– Stripe Secret Key

**åœ¨ Stripe Dashboard**:
1. è®¿é—® https://dashboard.stripe.com
2. ç¡®ä¿ä½ åœ¨æ­£ç¡®çš„æ¨¡å¼ï¼š
   - **Test mode** (æµ‹è¯•ç¯å¢ƒ) - ç”¨äºå¼€å‘æµ‹è¯•
   - **Live mode** (ç”Ÿäº§ç¯å¢ƒ) - ç”¨äºçœŸå®æ”¯ä»˜
3. ç‚¹å‡»å·¦ä¾§èœå•çš„ **"Developers"** â†’ **"API keys"**
4. æ‰¾åˆ° **"Secret key"** éƒ¨åˆ†
5. ç‚¹å‡» **"Reveal test key"**ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰æˆ– **"Reveal live key"**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
6. å¤åˆ¶å®Œæ•´çš„ keyï¼ˆæ ¼å¼ï¼š`sk_test_*****` æˆ– `sk_live_*****`ï¼‰
7. **é‡è¦**: ä¸è¦åˆ†äº«è¿™ä¸ª keyï¼Œå®ƒç­‰åŒäºä½ çš„ Stripe è´¦å·å¯†ç 

### 2.2 åœ¨ Vercel æ·»åŠ ç¯å¢ƒå˜é‡

**åœ¨ Vercel Dashboard**:
1. è®¿é—® https://vercel.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®ï¼ˆSora-2Aiï¼‰
3. ç‚¹å‡»é¡¶éƒ¨èœå•çš„ **"Settings"**
4. åœ¨å·¦ä¾§èœå•ä¸­ï¼Œç‚¹å‡» **"Environment Variables"**
5. ç‚¹å‡» **"Add New"** æŒ‰é’®ï¼ˆé€šå¸¸åœ¨å³ä¸Šè§’æˆ–åˆ—è¡¨ä¸Šæ–¹ï¼‰

6. **å¡«å†™ç¯å¢ƒå˜é‡**:
   - **Key** (å˜é‡å): `STRIPE_SECRET_KEY`
   - **Value** (å€¼): ç²˜è´´ä½ åˆšæ‰å¤åˆ¶çš„ Stripe Secret Key
   - **Environment** (ç¯å¢ƒ): 
     - âœ… å‹¾é€‰ **Production**ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
     - âœ… å‹¾é€‰ **Preview**ï¼ˆé¢„è§ˆç¯å¢ƒï¼‰
     - âœ… å‹¾é€‰ **Development**ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
     - æˆ–è€…é€‰æ‹© **"All Environments"**

7. ç‚¹å‡» **"Save"** ä¿å­˜

### 2.3 éªŒè¯ç¯å¢ƒå˜é‡å·²æ·»åŠ 

1. åœ¨ Environment Variables åˆ—è¡¨ä¸­ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š
   - **Name**: `STRIPE_SECRET_KEY`
   - **Value**: `sk_*****`ï¼ˆéƒ¨åˆ†éšè—ï¼‰
   - **Environments**: Production, Preview, Development

2. å¦‚æœçœ‹åˆ° âœ…ï¼Œè¯´æ˜æ·»åŠ æˆåŠŸ

### 2.4 é‡æ–°éƒ¨ç½²é¡¹ç›®

**æ–¹æ³• 1: é€šè¿‡ Vercel Dashboardï¼ˆæ¨èï¼‰**
1. åœ¨é¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»é¡¶éƒ¨èœå•çš„ **"Deployments"**
2. æ‰¾åˆ°æœ€æ–°çš„éƒ¨ç½²è®°å½•
3. ç‚¹å‡»å³ä¾§çš„ **"..."** (ä¸‰ä¸ªç‚¹)
4. é€‰æ‹© **"Redeploy"**
5. ç¡®è®¤é‡æ–°éƒ¨ç½²

**æ–¹æ³• 2: é€šè¿‡ Git æ¨é€**
```bash
git commit --allow-empty -m "Redeploy for STRIPE_SECRET_KEY"
git push
```

**æ–¹æ³• 3: ç­‰å¾…è‡ªåŠ¨éƒ¨ç½²**
- å¦‚æœä½ åˆšåˆšæ·»åŠ äº†ç¯å¢ƒå˜é‡ï¼ŒVercel å¯èƒ½ä¼šè‡ªåŠ¨è§¦å‘é‡æ–°éƒ¨ç½²
- æ£€æŸ¥ Deployments é¡µé¢æ˜¯å¦æœ‰æ–°çš„éƒ¨ç½²åœ¨è¿›è¡Œ

### 2.5 éªŒè¯éƒ¨ç½²æˆåŠŸ

1. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆé€šå¸¸ 1-3 åˆ†é’Ÿï¼‰
2. åœ¨ Deployments é¡µé¢ï¼Œæœ€æ–°çš„éƒ¨ç½²åº”è¯¥æ˜¾ç¤º **"Ready"** çŠ¶æ€
3. ç‚¹å‡»éƒ¨ç½²è®°å½•ï¼ŒæŸ¥çœ‹ **"Functions Logs"** ç¡®è®¤æ²¡æœ‰é”™è¯¯

---

## âœ… æ­¥éª¤ 3: æµ‹è¯•æ”¯ä»˜æµç¨‹

### 3.1 æµ‹è¯•å‰å‡†å¤‡

1. âœ… ç¡®è®¤æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
2. âœ… ç¡®è®¤ç¯å¢ƒå˜é‡ `STRIPE_SECRET_KEY` å·²è®¾ç½®
3. âœ… ç¡®è®¤é¡¹ç›®å·²é‡æ–°éƒ¨ç½²
4. âœ… ç¡®è®¤éƒ¨ç½²çŠ¶æ€ä¸º "Ready"

### 3.2 æµ‹è¯•æ”¯ä»˜æµç¨‹

#### æ­¥éª¤ A: è®¿é—®å®šä»·é¡µé¢

1. è®¿é—®ä½ çš„ç½‘ç«™ `/pricing` é¡µé¢
   - ä¾‹å¦‚ï¼š`https://sora2aivideos.com/pricing`
2. åº”è¯¥èƒ½çœ‹åˆ° 4 ä¸ªæ¡£ä½ï¼šStarter, Creator, Studio, Pro

#### æ­¥éª¤ B: ç‚¹å‡»è´­ä¹°æŒ‰é’®

1. ç‚¹å‡»ä»»æ„æ¡£ä½çš„ **"Get"** æˆ– **"Purchase"** æŒ‰é’®
2. åº”è¯¥è·³è½¬åˆ° Stripe Checkout é¡µé¢ï¼ˆä¸æ˜¯ Payment Linkï¼‰
3. å¦‚æœçœ‹åˆ° Stripe çš„æ”¯ä»˜è¡¨å•ï¼Œè¯´æ˜ API è°ƒç”¨æˆåŠŸ

#### æ­¥éª¤ C: ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜

**Stripe æµ‹è¯•å¡ä¿¡æ¯**:
- **å¡å·**: `4242 4242 4242 4242`
- **è¿‡æœŸæ—¥æœŸ**: ä»»æ„æœªæ¥æ—¥æœŸï¼ˆå¦‚ `12/25`ï¼‰
- **CVC**: ä»»æ„ 3 ä½æ•°å­—ï¼ˆå¦‚ `123`ï¼‰
- **é‚®ç¼–**: ä»»æ„ 5 ä½æ•°å­—ï¼ˆå¦‚ `12345`ï¼‰
- **å§“å**: ä»»æ„å§“å

**å®Œæˆæ”¯ä»˜**:
1. å¡«å†™æµ‹è¯•å¡ä¿¡æ¯
2. ç‚¹å‡» **"Pay"** æˆ– **"Complete payment"**
3. æ”¯ä»˜æˆåŠŸååº”è¯¥è‡ªåŠ¨è·³è½¬åˆ° `/billing/success?session_id=xxx`

#### æ­¥éª¤ D: éªŒè¯æ”¯ä»˜æˆåŠŸ

1. **æ£€æŸ¥è·³è½¬**:
   - åº”è¯¥è‡ªåŠ¨è·³è½¬åˆ° `/billing/success` é¡µé¢
   - URL åº”è¯¥åŒ…å« `session_id` å‚æ•°

2. **æ£€æŸ¥é¡µé¢æ˜¾ç¤º**:
   - é¡µé¢åº”è¯¥æ˜¾ç¤º "âœ… Credits added successfully!"
   - å‡ ç§’ååº”è¯¥è‡ªåŠ¨è·³è½¬åˆ° `/video` é¡µé¢

3. **æ£€æŸ¥ç§¯åˆ†å…¥è´¦**:
   - ç™»å½•åè®¿é—® `/video` æˆ–è°ƒç”¨ `/api/stats`
   - åº”è¯¥èƒ½çœ‹åˆ°é’±åŒ…ä¸­çš„ç§¯åˆ†ï¼ˆæ°¸ä¹… + Bonusï¼‰
   - æ£€æŸ¥ `wallets` è¡¨æ˜¯å¦æœ‰è®°å½•

4. **æ£€æŸ¥æ•°æ®åº“è®°å½•**:
   - åœ¨ Supabase Dashboard â†’ Table Editor â†’ `purchases`
   - åº”è¯¥èƒ½çœ‹åˆ°ä¸€æ¡è´­ä¹°è®°å½•
   - åœ¨ `wallets` è¡¨åº”è¯¥èƒ½çœ‹åˆ°ç§¯åˆ†å·²å…¥è´¦

### 3.3 æµ‹è¯•ç§¯åˆ†æ‰£é™¤

1. **ç”Ÿæˆä¸€ä¸ªè§†é¢‘**:
   - è®¿é—® `/video` é¡µé¢
   - é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ï¼ˆSora, Veo Flash, æˆ– Veo Proï¼‰
   - è¾“å…¥æç¤ºè¯å¹¶ç”Ÿæˆ

2. **éªŒè¯ç§¯åˆ†æ‰£é™¤**:
   - ç”Ÿæˆå‰åº”è¯¥è°ƒç”¨ `/api/render/start` è¿›è¡Œæ‰£è´¹
   - æ£€æŸ¥ç§¯åˆ†æ˜¯å¦æ­£ç¡®æ‰£é™¤ï¼ˆBonus ä¼˜å…ˆï¼‰
   - æ£€æŸ¥ `wallets` è¡¨çš„ç§¯åˆ†ä½™é¢

3. **éªŒè¯ Starter é™é¢**ï¼ˆå¦‚æœæµ‹è¯• Starter ç”¨æˆ·ï¼‰:
   - Starter ç”¨æˆ·åº”è¯¥å—åˆ°æ—¥é™é¢é™åˆ¶
   - Sora: */day
   - Veo Flash: */day
   - Veo Pro: åº”è¯¥è¢«é”å®š

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ•°æ®åº“è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: SQL æ‰§è¡ŒæŠ¥é”™

**æ£€æŸ¥**:
- âœ… æ˜¯å¦å·²ç»å­˜åœ¨åŒåè¡¨ï¼ˆå¯èƒ½éœ€è¦å…ˆåˆ é™¤æ—§è¡¨ï¼‰
- âœ… SQL è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼‰
- âœ… æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡Œ DDL è¯­å¥

**è§£å†³**:
- å¦‚æœè¡¨å·²å­˜åœ¨ï¼Œå¯ä»¥å…ˆåˆ é™¤ï¼š
  ```sql
  DROP TABLE IF EXISTS wallets CASCADE;
  DROP TABLE IF EXISTS user_entitlements CASCADE;
  DROP TABLE IF EXISTS usage_daily CASCADE;
  DROP TABLE IF EXISTS purchases CASCADE;
  DROP TABLE IF EXISTS risk_devices CASCADE;
  ```
- ç„¶åé‡æ–°æ‰§è¡Œè¿ç§»æ–‡ä»¶

### é—®é¢˜ 2: ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**: æ”¯ä»˜æ—¶æç¤º "Invalid API Key" æˆ– "STRIPE_SECRET_KEY is not set"

**æ£€æŸ¥**:
- âœ… ç¯å¢ƒå˜é‡åç§°æ˜¯å¦æ­£ç¡®ï¼š`STRIPE_SECRET_KEY`ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰
- âœ… æ˜¯å¦åœ¨æ‰€æœ‰ç¯å¢ƒéƒ½æ·»åŠ äº†ï¼ˆProduction, Preview, Developmentï¼‰
- âœ… æ˜¯å¦å·²é‡æ–°éƒ¨ç½²é¡¹ç›®
- âœ… æ£€æŸ¥ Vercel éƒ¨ç½²æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³**:
- ç¡®è®¤ç¯å¢ƒå˜é‡å·²æ·»åŠ å¹¶ä¿å­˜
- é‡æ–°éƒ¨ç½²é¡¹ç›®
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢

### é—®é¢˜ 3: æ”¯ä»˜æˆåŠŸåæ²¡æœ‰å…¥è´¦

**ç—‡çŠ¶**: æ”¯ä»˜æˆåŠŸä½†ç§¯åˆ†æ²¡æœ‰å…¥è´¦

**æ£€æŸ¥**:
- âœ… Stripe Checkout Session çš„ Success URL æ˜¯å¦æ­£ç¡®
- âœ… æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
- âœ… æŸ¥çœ‹ Vercel Functions Logsï¼ˆDeployments â†’ é€‰æ‹©éƒ¨ç½² â†’ Functions Logsï¼‰
- âœ… æ£€æŸ¥ Supabase çš„ `purchases` è¡¨æ˜¯å¦æœ‰è®°å½•
- âœ… æ£€æŸ¥ `wallets` è¡¨æ˜¯å¦æœ‰ç§¯åˆ†

**è§£å†³**:
- æ£€æŸ¥ `/api/billing/finalize` API æ˜¯å¦è¢«è°ƒç”¨
- æŸ¥çœ‹ Vercel Functions Logs ä¸­çš„é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥ Supabase æ—¥å¿—ï¼ˆDashboard â†’ Logs â†’ Postgres Logsï¼‰

### é—®é¢˜ 4: ç§¯åˆ†æ‰£é™¤å¤±è´¥

**ç—‡çŠ¶**: ç”Ÿæˆè§†é¢‘æ—¶æç¤ºç§¯åˆ†ä¸è¶³æˆ–æ‰£é™¤å¤±è´¥

**æ£€æŸ¥**:
- âœ… `wallets` è¡¨æ˜¯å¦æœ‰ç”¨æˆ·è®°å½•
- âœ… ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿï¼ˆæ£€æŸ¥ `permanent_credits` + `bonus_credits`ï¼‰
- âœ… Bonus æ˜¯å¦å·²è¿‡æœŸï¼ˆæ£€æŸ¥ `bonus_expires_at`ï¼‰
- âœ… æ¨¡å‹æ¶ˆè€—æ˜¯å¦æ­£ç¡®ï¼ˆSora **, Veo Flash **, Veo Pro ***ï¼‰

**è§£å†³**:
- æ£€æŸ¥é’±åŒ…ä½™é¢
- æ£€æŸ¥ Bonus è¿‡æœŸæ—¶é—´
- éªŒè¯æ¨¡å‹æ¶ˆè€—é…ç½®

### é—®é¢˜ 5: Starter é™é¢ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**: Starter ç”¨æˆ·å¯ä»¥æ— é™åˆ¶ä½¿ç”¨

**æ£€æŸ¥**:
- âœ… `user_entitlements` è¡¨ä¸­çš„ `plan_id` æ˜¯å¦ä¸º `starter`
- âœ… `usage_daily` è¡¨æ˜¯å¦æ­£ç¡®è®°å½•æ¯æ—¥ä½¿ç”¨
- âœ… å‡½æ•° `check_and_increment_daily_usage` æ˜¯å¦æ­£å¸¸æ‰§è¡Œ

**è§£å†³**:
- æ£€æŸ¥ç”¨æˆ·æƒç›Šé…ç½®
- éªŒè¯æ—¥é™é¢æ£€æŸ¥é€»è¾‘
- æŸ¥çœ‹ Supabase æ—¥å¿—

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

### æ•°æ®åº“è¿ç§»
- [ ] è¿ç§»æ–‡ä»¶å·²æ‰§è¡Œ
- [ ] 5 ä¸ªè¡¨å·²åˆ›å»ºï¼š`wallets`, `user_entitlements`, `usage_daily`, `purchases`, `risk_devices`
- [ ] 3 ä¸ªå‡½æ•°å·²åˆ›å»ºï¼š`deduct_credits`, `check_and_increment_daily_usage`, `apply_purchase`
- [ ] éªŒè¯æŸ¥è¯¢è¿”å›æ­£ç¡®ç»“æœ

### ç¯å¢ƒå˜é‡
- [ ] `STRIPE_SECRET_KEY` å·²æ·»åŠ åˆ° Vercel
- [ ] ç¯å¢ƒå˜é‡åœ¨æ‰€æœ‰ç¯å¢ƒéƒ½å¯ç”¨ï¼ˆProduction, Preview, Developmentï¼‰
- [ ] é¡¹ç›®å·²é‡æ–°éƒ¨ç½²
- [ ] éƒ¨ç½²çŠ¶æ€ä¸º "Ready"

### æ”¯ä»˜æµç¨‹æµ‹è¯•
- [ ] è®¿é—® `/pricing` é¡µé¢æˆåŠŸ
- [ ] ç‚¹å‡»è´­ä¹°æŒ‰é’®è·³è½¬åˆ° Stripe Checkout
- [ ] ä½¿ç”¨æµ‹è¯•å¡å®Œæˆæ”¯ä»˜
- [ ] æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ° `/billing/success`
- [ ] é¡µé¢æ˜¾ç¤º "âœ… Credits added successfully!"
- [ ] ç§¯åˆ†æ­£ç¡®å…¥è´¦åˆ°é’±åŒ…
- [ ] `purchases` è¡¨æœ‰è´­ä¹°è®°å½•
- [ ] `wallets` è¡¨æœ‰ç§¯åˆ†è®°å½•

### ç§¯åˆ†æ‰£é™¤æµ‹è¯•
- [ ] ç”Ÿæˆè§†é¢‘å‰æ­£ç¡®æ‰£è´¹
- [ ] Bonus ç§¯åˆ†ä¼˜å…ˆæ‰£é™¤
- [ ] ç§¯åˆ†ä½™é¢æ­£ç¡®æ˜¾ç¤º
- [ ] Starter ç”¨æˆ·æ—¥é™é¢æ­£ç¡®æ‰§è¡Œ

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **Vercel æ—¥å¿—**: Deployments â†’ é€‰æ‹©éƒ¨ç½² â†’ Functions Logs
2. **Stripe æ—¥å¿—**: Dashboard â†’ Developers â†’ Logs
3. **æµè§ˆå™¨æ§åˆ¶å°**: F12 â†’ Console
4. **Supabase æ—¥å¿—**: Dashboard â†’ Logs â†’ Postgres Logs

---

## ğŸ‰ å®Œæˆï¼

å®Œæˆä»¥ä¸Š 3 ä¸ªæ­¥éª¤åï¼Œä½ çš„å®šä»·ç³»ç»Ÿå°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼

**ä¸‹ä¸€æ­¥å»ºè®®**:
- ç›‘æ§ç¬¬ä¸€ä¸ªçœŸå®æ”¯ä»˜
- æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´ Starter é™é¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
- å‡†å¤‡åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚æœè¿˜åœ¨æµ‹è¯•ç¯å¢ƒï¼‰

---

**æœ€åæ›´æ–°**: 2026-01-07
**ç‰ˆæœ¬**: 1.0.0

