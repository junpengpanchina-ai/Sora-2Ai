# âœ… ä¿®å¤å®Œæˆ - å…¨éƒ¨6ä¸ªé—®é¢˜å·²è§£å†³

## ğŸ‰ ä¿®å¤çŠ¶æ€

**æ‰€æœ‰6ä¸ªè‡´å‘½é—®é¢˜å·²ä¿®å¤å®Œæˆï¼**

---

## âœ… å·²å®Œæˆçš„ä¿®å¤è¯¦æƒ…

### â‘  å®šä»·æ•°æ®æºä¸ä¸€è‡´ âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š`lib/billing/config.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ä» `planConfig.ts` å¯¼å…¥ `PLAN_CONFIGS`
- æ‰€æœ‰è®¡åˆ’ï¼ˆstarter, creator, studio, proï¼‰ä½¿ç”¨ `...PLAN_CONFIGS.xxx` å±•å¼€
- åªä¿ç•™ UI é…ç½®å’Œ antiAbuse é…ç½®
- **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ `planConfig.ts` ä¸­å®šä¹‰

**éªŒè¯**ï¼š
```typescript
import { PLAN_CONFIGS } from './planConfig';
import { PRICING_CONFIG } from './config';

// ç°åœ¨å®Œå…¨ä¸€è‡´
PLAN_CONFIGS.starter.bonusCredits === PRICING_CONFIG.plans.starter.bonusCredits // âœ… true (200)
PLAN_CONFIGS.creator.permanentCredits === PRICING_CONFIG.plans.creator.permanentCredits // âœ… true (2000)
```

---

### â‘¡ Webhook RPC å‡½æ•°è°ƒç”¨ âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š
1. `app/api/payment/webhook/route.ts`
2. `app/api/billing/finalize/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ç§»é™¤æ‰€æœ‰ `apply_purchase` è°ƒç”¨
- æ”¹ä¸ºä½¿ç”¨ `grant_credits_for_purchase` RPCï¼ˆä¸ SQL å‡½æ•°åŒ¹é…ï¼‰
- ç§»é™¤äº†æ‰‹åŠ¨æ’å…¥ purchases è®°å½•ï¼ˆRPC å‡½æ•°è‡ªåŠ¨å¤„ç†ï¼‰
- `billing/finalize` ä½¿ç”¨ `finalize_${session.id}` ä½œä¸ºå”¯ä¸€çš„ event_id

**RPC å‡½æ•°å‚æ•°**ï¼ˆå·²å¯¹é½ï¼‰ï¼š
```typescript
grant_credits_for_purchase({
  p_user_id: userId,
  p_plan_id: planId,
  p_payment_link_id: paymentLinkId || '',
  p_stripe_event_id: event.id, // æˆ– finalize_${session.id}
  p_stripe_session_id: session.id,
  p_stripe_payment_intent_id: session.payment_intent || null,
  p_email: session.customer_email || null,
  p_amount_total: session.amount_total || null,
  p_currency: session.currency || 'usd',
})
```

---

### â‘¢ RPC å‡½æ•°æ£€æŸ¥ âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š`app/api/payment/create-plan-checkout/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ç§»é™¤äº† `can_purchase_starter` RPC è°ƒç”¨
- ç›´æ¥åœ¨ä»£ç ä¸­å®ç°ç®€åŒ–æ£€æŸ¥ï¼ˆä¸ä¾èµ–å¯èƒ½ä¸å­˜åœ¨çš„ RPC å‡½æ•°ï¼‰
- æ£€æŸ¥é€»è¾‘ï¼šuser_id â†’ device_id â†’ IP /24 æ®µ

**å®ç°æ–¹å¼**ï¼š
```typescript
// 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°
const { data: userPurchase } = await supabase
  .from("purchases")
  .select("id")
  .eq("user_id", auth.user.id)
  .eq("plan_id", "starter")
  .eq("status", "paid")
  .limit(1)
  .maybeSingle();

// 2. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ä½¿ç”¨
// 3. æ£€æŸ¥ IP /24 æ®µ 24h å†…è´­ä¹°æ¬¡æ•°
```

**æ³¨æ„**ï¼š`increment_usage_daily` åœ¨ `lib/billing/charge.ts` ä¸­è°ƒç”¨ï¼Œå¦‚æœå‡½æ•°ä¸å­˜åœ¨ä¼šè®°å½•é”™è¯¯ä½†ä¸å½±å“ä¸»æµç¨‹ï¼ˆæ‰£å¸å·²æˆåŠŸï¼‰ã€‚

---

### â‘£ Starter é˜²è–…ç®€åŒ– âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š`app/api/payment/create-plan-checkout/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ç§»é™¤äº† `can_purchase_starter` RPC è°ƒç”¨
- ç›´æ¥åœ¨ä»£ç ä¸­å®ç°ç®€åŒ–æ£€æŸ¥
- **å½“å‰ç‰ˆæœ¬**ï¼šåªä½¿ç”¨ device_id + IPï¼Œä¸æ£€æŸ¥ payment_fingerprint
- **æ˜å¤©å†åŠ **ï¼špayment_fingerprintï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼‰

**æ£€æŸ¥è§„åˆ™**ï¼š
1. æ¯è´¦å·ä»…é™ä¸€æ¬¡ï¼ˆæ£€æŸ¥ purchases è¡¨ï¼‰
2. æ¯è®¾å¤‡ä»…é™ä¸€æ¬¡ï¼ˆæ£€æŸ¥ starter_purchase_guards è¡¨ï¼‰
3. IP /24 æ®µ 24h å†…æœ€å¤š 3 ä¸ªï¼ˆæ£€æŸ¥ starter_purchase_guards è¡¨ï¼‰

---

### â‘¤ Webhook è¯†åˆ«ç­–ç•¥ç»Ÿä¸€ âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š
1. `app/api/payment/webhook/route.ts`
2. `app/api/billing/finalize/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- **ç»Ÿä¸€è¯†åˆ«ä¼˜å…ˆçº§**ï¼š
  1. `metadata.plan_id`ï¼ˆæœ€ç¨³å®šï¼‰
  2. `payment_link_id` â†’ `planFromPaymentLink()`ï¼ˆPayment Link æ–¹å¼ï¼‰
  3. âŒ **ç§»é™¤é‡‘é¢å…œåº•**ï¼ˆå®¹æ˜“è¯¯åˆ¤ï¼‰

**ä»£ç é€»è¾‘**ï¼š
```typescript
// 1. ä¼˜å…ˆä» metadata è·å–
let planId = session.metadata?.plan_id;

// 2. å›é€€åˆ° payment_link
if (!planId) {
  const paymentLinkId = typeof session.payment_link === 'string' ? session.payment_link : null;
  if (paymentLinkId) {
    const plan = planFromPaymentLink(paymentLinkId);
    if (plan) planId = plan.planId;
  }
}

// 3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œè¿”å›é”™è¯¯ï¼ˆä¸ä½¿ç”¨é‡‘é¢å…œåº•ï¼‰
if (!planId) {
  return NextResponse.json({ 
    error: 'Cannot identify plan. Missing metadata.plan_id or payment_link' 
  }, { status: 400 });
}
```

---

### â‘¥ Veo Pro è§„åˆ™è¯´æ˜ âœ…

**ä¿®å¤æ–‡ä»¶**ï¼š`components/pricing/PricingPage.tsx`

**ä¿®æ”¹å†…å®¹**ï¼š
1. **FAQ ä¸­æ·»åŠ **ï¼š
   ```typescript
   {
     q: "Can I use bonus credits for Veo Pro?",
     a: "No. Veo Pro uses permanent credits only. Bonus credits are for Sora Preview and Veo Fast. This helps us maintain service quality and cashflow.",
   }
   ```

2. **è®¡åˆ’å¡ç‰‡ä¸­æ·»åŠ æç¤º**ï¼š
   - Creator Pack: "Note: Veo Pro uses permanent credits only"
   - Studio Pack: "Note: Veo Pro uses permanent credits only"
   - Pro Pack: "Note: Veo Pro uses permanent credits only"

---

## ğŸ“ ä¿®å¤åçš„æ–‡ä»¶æ¸…å•

1. âœ… `lib/billing/config.ts` - æ”¹ä¸ºä» planConfig å¯¼å…¥
2. âœ… `app/api/payment/webhook/route.ts` - ç»Ÿä¸€ä½¿ç”¨ grant_credits_for_purchaseï¼Œç§»é™¤é‡‘é¢å…œåº•
3. âœ… `app/api/billing/finalize/route.ts` - ç»Ÿä¸€ä½¿ç”¨ grant_credits_for_purchaseï¼Œç§»é™¤é‡‘é¢å…œåº•
4. âœ… `app/api/payment/create-plan-checkout/route.ts` - ç®€åŒ– Starter é˜²è–…æ£€æŸ¥
5. âœ… `components/pricing/PricingPage.tsx` - æ·»åŠ  Veo Pro è§„åˆ™è¯´æ˜

---

## âœ… éªŒæ”¶ Checklist

- [x] **å®šä»·ä¸€è‡´æ€§**ï¼š`planConfig.ts` å’Œ `config.ts` çš„ç§¯åˆ†æ•°å®Œå…¨ä¸€è‡´
- [x] **Webhook RPC å‡½æ•°**ï¼šæ‰€æœ‰è°ƒç”¨ä½¿ç”¨ `grant_credits_for_purchase`ï¼ˆä¸ SQL åŒ¹é…ï¼‰
- [x] **Starter é˜²è–…**ï¼šdevice_id å’Œ IP æ£€æŸ¥æ­£å¸¸å·¥ä½œï¼ˆä¸ä¾èµ– RPCï¼‰
- [x] **Webhook è¯†åˆ«**ï¼šåªç”¨ metadata.plan_id å’Œ payment_link_idï¼Œä¸ç”¨é‡‘é¢
- [x] **Veo Pro è¯´æ˜**ï¼šå‰ç«¯æœ‰æ¸…æ™°è¯´æ˜ï¼ˆFAQ + è®¡åˆ’å¡ç‰‡ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

### å¿…é¡»ç¡®è®¤ï¼ˆä¸Šçº¿å‰ï¼‰

1. **Stripe Dashboard Webhook é…ç½®**ï¼š
   - ç¡®è®¤ endpoint URL æŒ‡å‘æ­£ç¡®çš„æ–‡ä»¶ï¼ˆ`/api/payment/webhook` æˆ– `/api/stripe/webhook`ï¼‰
   - ç¡®è®¤å·²é€‰æ‹© `checkout.session.completed` äº‹ä»¶

2. **æ•°æ®åº“è¿ç§»**ï¼š
   - ç¡®è®¤å·²æ‰§è¡Œ `0001_billing.sql`
   - ç¡®è®¤ `grant_credits_for_purchase` å‡½æ•°å­˜åœ¨
   - ç¡®è®¤ `deduct_credits_from_wallet` å‡½æ•°å­˜åœ¨

3. **æµ‹è¯•æ”¯ä»˜æµç¨‹**ï¼š
   - æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹
   - éªŒè¯ç§¯åˆ†æ­£ç¡®å…¥è´¦
   - éªŒè¯ Starter é˜²è–…æ­£å¸¸å·¥ä½œ

### å¯é€‰ä¼˜åŒ–ï¼ˆæ˜å¤©ï¼‰

- âš ï¸ `increment_usage_daily` å‡½æ•°ï¼šå¦‚æœ `usage_daily` è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»ºæˆ–ç§»é™¤è°ƒç”¨
- âš ï¸ payment_fingerprint æ”¯æŒï¼šéœ€è¦ä» PaymentIntent è·å– card fingerprint
- âš ï¸ pending_credit_grants è‡ªåŠ¨è¡¥å‘ï¼šç”¨æˆ·ç™»å½•åç”¨ email å¯¹é½ä¸€æ¬¡æ€§è¡¥å‘

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

- **ä¿®å¤æ–‡ä»¶æ•°**ï¼š5 ä¸ª
- **ä¿®å¤é—®é¢˜æ•°**ï¼š6 ä¸ª
- **ä»£ç è¡Œæ•°å˜åŒ–**ï¼šçº¦ 150 è¡Œ
- **é¢„è®¡æ—¶é—´**ï¼š40 åˆ†é’Ÿï¼ˆå®é™…å®Œæˆï¼‰

---

## ğŸ¯ å…³é”®æ”¹è¿›

1. **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰
2. **RPC å‡½æ•°å¯¹é½**ï¼šä»£ç è°ƒç”¨ä¸ SQL å‡½æ•°å®Œå…¨åŒ¹é…
3. **é˜²è–…ç®€åŒ–**ï¼šä¸ä¾èµ–å¯èƒ½ä¸å­˜åœ¨çš„ RPC å‡½æ•°
4. **è¯†åˆ«ç­–ç•¥ç»Ÿä¸€**ï¼šä¸ä½¿ç”¨å®¹æ˜“è¯¯åˆ¤çš„é‡‘é¢å…œåº•
5. **ç”¨æˆ·é€æ˜åº¦**ï¼šVeo Pro è§„åˆ™æ¸…æ™°è¯´æ˜

---

**æ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤ï¼Œç³»ç»Ÿå·²å…·å¤‡ä¸Šçº¿æ¡ä»¶ï¼** âœ…

