/**
 * Observability utilities for workflow inspection.
 * Shared between CLI and Web UI for consistent behavior.
 */
import { hydrateStepArguments, hydrateStepReturnValue, hydrateWorkflowArguments, hydrateWorkflowReturnValue, } from './serialization.js';
const STREAM_ID_PREFIX = 'strm_';
/**
 * Marker for stream reference objects that can be rendered as links
 */
export const STREAM_REF_TYPE = '__workflow_stream_ref__';
/**
 * Check if a value is a stream ID string
 */
export const isStreamId = (value) => {
    return typeof value === 'string' && value.startsWith(STREAM_ID_PREFIX);
};
/**
 * Check if a value is a StreamRef object
 */
export const isStreamRef = (value) => {
    return (value !== null &&
        typeof value === 'object' &&
        '__type' in value &&
        value.__type === STREAM_REF_TYPE &&
        'streamId' in value &&
        typeof value.streamId === 'string');
};
/**
 * Create a StreamRef object from a stream value.
 * This is used during hydration to convert serialized streams into
 * objects that can be rendered as links in the UI.
 */
const streamToStreamRef = (value) => {
    let streamId;
    if ('name' in value) {
        const name = String(value.name);
        if (!name.startsWith(STREAM_ID_PREFIX)) {
            streamId = `${STREAM_ID_PREFIX}${name}`;
        }
        else {
            streamId = name;
        }
    }
    else {
        streamId = `${STREAM_ID_PREFIX}null`;
    }
    return {
        __type: STREAM_REF_TYPE,
        streamId,
    };
};
const serializedStepFunctionToString = (value) => {
    if (!value)
        return 'null';
    if (typeof value !== 'object')
        return 'null';
    if ('stepId' in value) {
        const stepId = value.stepId;
        // TODO: Add closure vars to the string representation.
        // value.closureVars
        return `<step:${stepId}>`;
    }
    return '<function>';
};
/**
 * This is an extra reviver for devalue that takes any streams that would be converted,
 * into actual streams, and instead formats them as StreamRef objects for display in the UI.
 *
 * This is mainly because we don't want to open any streams that we aren't going to read from,
 * and so we can get the string ID/name, which the serializer stream doesn't provide.
 */
const streamPrintRevivers = {
    ReadableStream: streamToStreamRef,
    WritableStream: streamToStreamRef,
    TransformStream: streamToStreamRef,
    StepFunction: serializedStepFunctionToString,
};
const hydrateStepIO = (step) => {
    return {
        ...step,
        input: step.input && Array.isArray(step.input) && step.input.length
            ? hydrateStepArguments(step.input, [], step.runId, globalThis, streamPrintRevivers)
            : step.input,
        output: step.output
            ? hydrateStepReturnValue(step.output, globalThis, streamPrintRevivers)
            : step.output,
    };
};
const hydrateWorkflowIO = (workflow) => {
    return {
        ...workflow,
        input: workflow.input && Array.isArray(workflow.input) && workflow.input.length
            ? hydrateWorkflowArguments(workflow.input, globalThis, streamPrintRevivers)
            : workflow.input,
        output: workflow.output
            ? hydrateWorkflowReturnValue(workflow.output, [], workflow.runId, globalThis, streamPrintRevivers)
            : workflow.output,
    };
};
const hydrateEventData = (event) => {
    if (!event.eventData) {
        return event;
    }
    const eventData = { ...event.eventData };
    // Events can have various eventData with non-devalued keys.
    // So far, only eventData.result is devalued (though this may change),
    // so we need to hydrate it specifically.
    try {
        if ('result' in eventData && typeof eventData.result === 'object') {
            eventData.result = hydrateStepReturnValue(eventData.result, globalThis, streamPrintRevivers);
        }
    }
    catch (error) {
        console.error('Error hydrating event data', error);
    }
    return {
        ...event,
        eventData,
    };
};
const hydrateHookMetadata = (hook) => {
    return {
        ...hook,
        metadata: hook.metadata && 'runId' in hook
            ? hydrateStepArguments(hook.metadata, [], hook.runId, globalThis, streamPrintRevivers)
            : hook.metadata,
    };
};
export const hydrateResourceIO = (resource) => {
    if (!resource) {
        return resource;
    }
    let hydrated;
    if ('stepId' in resource) {
        hydrated = hydrateStepIO(resource);
    }
    else if ('hookId' in resource) {
        hydrated = hydrateHookMetadata(resource);
    }
    else if ('eventId' in resource) {
        hydrated = hydrateEventData(resource);
    }
    else {
        hydrated = hydrateWorkflowIO(resource);
    }
    if ('executionContext' in hydrated) {
        const { executionContext: _, ...rest } = hydrated;
        return rest;
    }
    return hydrated;
};
/**
 * Extract all stream IDs from a value (recursively traverses objects/arrays)
 */
export function extractStreamIds(obj) {
    const streamIds = [];
    function traverse(value) {
        if (isStreamId(value)) {
            streamIds.push(value);
        }
        else if (Array.isArray(value)) {
            for (const item of value) {
                traverse(item);
            }
        }
        else if (value && typeof value === 'object') {
            for (const val of Object.values(value)) {
                traverse(val);
            }
        }
    }
    traverse(obj);
    return Array.from(new Set(streamIds)); // Remove duplicates
}
/**
 * Truncate a string to a maximum length, adding ellipsis if needed
 */
export function truncateId(id, maxLength = 12) {
    if (id.length <= maxLength)
        return id;
    return `${id.slice(0, maxLength)}...`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JzZXJ2YWJpbGl0eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9vYnNlcnZhYmlsaXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVILE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsc0JBQXNCLEVBQ3RCLHdCQUF3QixFQUN4QiwwQkFBMEIsR0FDM0IsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QixNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztBQUVqQzs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyx5QkFBeUIsQ0FBQztBQVd6RDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxDQUFDLEtBQWMsRUFBVyxFQUFFO0lBQ3BELE9BQU8sT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUN6RSxDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLEtBQWMsRUFBc0IsRUFBRTtJQUNoRSxPQUFPLENBQ0wsS0FBSyxLQUFLLElBQUk7UUFDZCxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQ3pCLFFBQVEsSUFBSSxLQUFLO1FBQ2pCLEtBQUssQ0FBQyxNQUFNLEtBQUssZUFBZTtRQUNoQyxVQUFVLElBQUksS0FBSztRQUNuQixPQUFPLEtBQUssQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUNuQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxLQUFVLEVBQWEsRUFBRTtJQUNsRCxJQUFJLFFBQWdCLENBQUM7SUFDckIsSUFBSSxNQUFNLElBQUksS0FBSyxFQUFFLENBQUM7UUFDcEIsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVB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