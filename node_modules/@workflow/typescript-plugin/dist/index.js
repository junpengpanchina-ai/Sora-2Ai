"use strict";
const code_fixes_1 = require("./code-fixes");
const completions_1 = require("./completions");
const diagnostics_1 = require("./diagnostics");
const hover_1 = require("./hover");
function init(modules) {
    const ts = modules.typescript;
    function create(info) {
        try {
            // Log plugin initialization
            info.project.projectService.logger.info('@workflow/typescript-plugin: Initializing plugin');
            // Get plugin configuration
            const config = info.config || {};
            const enableDiagnostics = config.enableDiagnostics !== false;
            const enableCompletions = config.enableCompletions !== false;
            info.project.projectService.logger.info(`@workflow/typescript-plugin: Diagnostics=${enableDiagnostics}, Completions=${enableCompletions}`);
            // Set up decorator object
            const proxy = Object.create(null);
            for (const k of Object.keys(info.languageService)) {
                const x = info.languageService[k];
                proxy[k] = (...args) => x.apply(info.languageService, args);
            }
            // Enhance semantic diagnostics
            if (enableDiagnostics) {
                proxy.getSemanticDiagnostics = (fileName) => {
                    const prior = info.languageService.getSemanticDiagnostics(fileName);
                    try {
                        const program = info.languageService.getProgram();
                        if (!program) {
                            return prior;
                        }
                        const customDiagnostics = (0, diagnostics_1.getCustomDiagnostics)(fileName, program, ts);
                        return [...prior, ...customDiagnostics];
                    }
                    catch (error) {
                        info.project.projectService.logger.info(`@workflow/typescript-plugin: Error in getSemanticDiagnostics: ${error}`);
                        return prior;
                    }
                };
            }
            // Enhance completions
            if (enableCompletions) {
                proxy.getCompletionsAtPosition = (fileName, position, options) => {
                    const prior = info.languageService.getCompletionsAtPosition(fileName, position, options);
                    try {
                        const program = info.languageService.getProgram();
                        if (!program)
                            return prior;
                        return (0, completions_1.enhanceCompletions)(fileName, position, prior, program, ts);
                    }
                    catch (error) {
                        info.project.projectService.logger.info(`@workflow/typescript-plugin: Error in getCompletionsAtPosition: ${error}`);
                        return prior;
                    }
                };
            }
            // Provide hover information
            proxy.getQuickInfoAtPosition = (fileName, position) => {
                const prior = info.languageService.getQuickInfoAtPosition(fileName, position);
                try {
                    const program = info.languageService.getProgram();
                    if (!program)
                        return prior;
                    const hoverInfo = (0, hover_1.getHoverInfo)(fileName, position, program, ts);
                    // If we have hover info for a directive, use it; otherwise use prior
                    return hoverInfo || prior;
                }
                catch (error) {
                    info.project.projectService.logger.info(`@workflow/typescript-plugin: Error in getQuickInfoAtPosition: ${error}`);
                    return prior;
                }
            };
            // Provide code fixes for diagnostics
            if (enableDiagnostics) {
                proxy.getCodeFixesAtPosition = (fileName, start, end, errorCodes, formatOptions, preferences) => {
                    const prior = info.languageService.getCodeFixesAtPosition(fileName, start, end, errorCodes, formatOptions, preferences);
                    try {
                        const program = info.languageService.getProgram();
                        if (!program)
                            return prior;
                        const customFixes = [];
                        for (const errorCode of errorCodes) {
                            const fixes = (0, code_fixes_1.getCodeFixes)(fileName, start, end, errorCode, program, ts);
                            customFixes.push(...fixes);
                        }
                        return [...prior, ...customFixes];
                    }
                    catch (error) {
                        info.project.projectService.logger.info(`@workflow/typescript-plugin: Error in getCodeFixesAtPosition: ${error}`);
                        return prior;
                    }
                };
            }
            info.project.projectService.logger.info('@workflow/typescript-plugin loaded successfully');
            return proxy;
        }
        catch (error) {
            info.project.projectService.logger.info(`@workflow/typescript-plugin: Error initializing plugin: ${error}`);
            // Return the original language service if plugin fails
            return info.languageService;
        }
    }
    return { create };
}
module.exports = init;
//# sourceMappingURL=index.js.map