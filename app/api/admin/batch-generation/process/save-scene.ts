/**
 * ä¿å­˜åœºæ™¯è¯åˆ°æ•°æ®åº“ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰
 */
export async function saveSceneToDatabase(
  industry: string,
  scene: { id: number; use_case: string },
  useCaseType: string,
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  supabase: any
) {
  const { generateSlugFromText } = await import('@/lib/utils/slug')
  const { checkContentQuality } = await import('@/lib/utils/content-quality')

  // ä»åœºæ™¯è¯ä¸­æå–å…³é”®è¯ä½œä¸ºæ ‡é¢˜
  const title = scene.use_case.length > 100 
    ? scene.use_case.substring(0, 100) + '...'
    : scene.use_case
  
  // ç”Ÿæˆ slugï¼Œç¡®ä¿ä¸ä¼šå¤ªé•¿
  const sceneText = scene.use_case.length > 80 
    ? scene.use_case.substring(0, 80) 
    : scene.use_case
  const slug = generateSlugFromText(`${industry}-${sceneText}`)
  
  // ç”Ÿæˆ H1 å’Œæè¿°
  const h1 = `AI Video Generation for ${scene.use_case} in ${industry}`
  const description = `Learn how to use AI video generation for ${scene.use_case} in the ${industry} industry. Create professional videos with Sora2.`

  // ç”Ÿæˆå®Œæ•´å†…å®¹
  const content = `# ${h1}

## Introduction

${scene.use_case}

## Why AI Video is Perfect for This Scenario

AI video generation offers several key advantages for ${scene.use_case} in the ${industry} industry:

- **Fast Production**: Create professional videos in minutes instead of days or weeks
- **Cost-Effective**: No need for expensive video production teams, equipment, or locations
- **Consistent Quality**: AI ensures professional output every time, maintaining brand consistency
- **Scalable**: Generate multiple variations easily for A/B testing or different markets
- **Flexible**: Quickly adapt videos for different platforms (YouTube, TikTok, Instagram, etc.)

## How to Use Sora2 for ${scene.use_case}

### Step 1: Create Your Video Prompt

Describe your ${scene.use_case} video needs in detail. Be specific about:
- The scene or setting
- The mood or tone
- Key elements or actions
- Style preferences (realistic, cinematic, animated, etc.)

### Step 2: Choose Video Settings

Select your preferred aspect ratio:
- **16:9** for YouTube, websites, presentations
- **9:16** for TikTok, Instagram Stories, Shorts
- **1:1** for Instagram posts, Facebook

Choose video duration: **10 seconds** or **15 seconds** based on your needs.

### Step 3: Generate Your Video

Click generate and wait a few moments. Sora2's AI will create your professional video with high-quality visuals and smooth transitions.

### Step 4: Download and Use

Once generated, download your video and use it immediately in your ${industry} marketing, training, or content strategy.

## Example Prompt for ${scene.use_case}

Here's an example prompt you can use with Sora2 to generate a **10-second or 15-second** video:

\`\`\`
[Example prompt based on the use case - will be generated based on scene description]
\`\`\`

**Note**: All videos generated by Sora2 are available in 10-second or 15-second durations. Choose the duration that best fits your content needs.

## Get Started Today

Start creating professional ${scene.use_case} videos for ${industry} today with Sora2 AI video generation platform. No technical skills required, no expensive equipment needed - just describe what you want, and AI will create it for you.`

  // è‡ªåŠ¨è´¨é‡æ£€æŸ¥
  const qualityCheck = checkContentQuality({
    title,
    h1,
    description,
    content,
    seo_keywords: [scene.use_case, industry, `${industry} AI video`],
  })

  // æ ¹æ®è´¨é‡æ£€æŸ¥ç»“æœè®¾ç½®çŠ¶æ€
  const qualityStatus = qualityCheck.passed && qualityCheck.score >= 70 ? 'approved' : 'pending'
  const isPublished = qualityStatus === 'approved'

  // ç›´æ¥ä½¿ç”¨ Supabase ä¿å­˜ï¼ˆé¿å… HTTP è°ƒç”¨ï¼‰
  // ğŸ”¥ æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼Œé¿å…æ•°æ®åº“æ“ä½œå¡ä½
  const DB_TIMEOUT = 10000 // 10ç§’è¶…æ—¶
  
  try {
    // ğŸ”¥ ä½¿ç”¨ Promise.race ç¡®ä¿è¶…æ—¶æ§åˆ¶
    const insertPromise = supabase
      .from('use_cases')
      .insert({
        slug,
        title,
        h1,
        description,
        content,
        use_case_type: useCaseType,
        industry,
        is_published: isPublished,
        seo_keywords: [scene.use_case, industry, `${industry} AI video`],
        quality_status: qualityStatus,
        quality_score: qualityCheck.score,
        quality_issues: qualityCheck.issues,
      })
      .select()
    
    const timeoutPromise = new Promise<{ error: { message?: string; code?: string; details?: string; hint?: string } | null }>((_, reject) =>
      setTimeout(() => reject(new Error('æ•°æ®åº“ä¿å­˜è¶…æ—¶ï¼ˆ10ç§’ï¼‰')), DB_TIMEOUT)
    )
    
    const { error: insertError } = await Promise.race([insertPromise, timeoutPromise]) as { error: { message?: string; code?: string; details?: string; hint?: string } | null }

    if (insertError) {
      // å¦‚æœæ˜¯é‡å¤ slugï¼Œå°è¯•æ·»åŠ åç¼€ï¼ˆä¹Ÿæ·»åŠ è¶…æ—¶æ§åˆ¶ï¼‰
      if (insertError.code === '23505') {
        const newSlug = `${slug}-${Date.now()}`
        const retryInsertPromise = supabase
          .from('use_cases')
          .insert({
            slug: newSlug,
            title,
            h1,
            description,
            content,
            use_case_type: useCaseType,
            industry,
            is_published: isPublished,
            seo_keywords: [scene.use_case, industry, `${industry} AI video`],
            quality_status: qualityStatus,
            quality_score: qualityCheck.score,
            quality_issues: qualityCheck.issues,
          })
        
        const retryTimeoutPromise = new Promise<{ error: { message?: string; code?: string; details?: string; hint?: string } | null }>((_, reject) =>
          setTimeout(() => reject(new Error('æ•°æ®åº“ä¿å­˜è¶…æ—¶ï¼ˆ10ç§’ï¼‰')), DB_TIMEOUT)
        )
        
        const { error: retryError } = await Promise.race([retryInsertPromise, retryTimeoutPromise]) as { error: { message?: string; code?: string; details?: string; hint?: string } | null }
        
        if (retryError) {
          console.error(`[${industry}] ä¿å­˜å¤±è´¥ (é‡å¤slugé‡è¯•å¤±è´¥):`, {
            error: retryError.message,
            code: retryError.code,
            details: retryError.details,
            hint: retryError.hint,
            slug: newSlug,
          })
          throw new Error(`ä¿å­˜å¤±è´¥: ${retryError.message} (code: ${retryError.code})`)
        }
      } else {
        console.error(`[${industry}] ä¿å­˜å¤±è´¥:`, {
          error: insertError.message,
          code: insertError.code,
          details: insertError.details,
          hint: insertError.hint,
          slug,
          useCaseType,
        })
        throw new Error(`ä¿å­˜å¤±è´¥: ${insertError.message} (code: ${insertError.code})`)
      }
    }
  } catch (error) {
    // è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    const errorMessage = error instanceof Error ? error.message : String(error)
    console.error(`[${industry}] ä¿å­˜åœºæ™¯è¯å¼‚å¸¸:`, {
      error: errorMessage,
      sceneId: scene.id,
      sceneLength: scene.use_case.length,
      slug,
      useCaseType,
    })
    throw error
  }
}

