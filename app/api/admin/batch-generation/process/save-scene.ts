/**
 * ä¿å­˜åœºæ™¯è¯åˆ°æ•°æ®åº“ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰
 */
export async function saveSceneToDatabase(
  industry: string,
  scene: { id: number; use_case: string },
  useCaseType: string,
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  supabase: any
) {
  const { generateSlugFromText } = await import('@/lib/utils/slug')
  const { checkContentQuality } = await import('@/lib/utils/content-quality')
  const { createHash } = await import('crypto')

  // ä»åœºæ™¯è¯ä¸­æå–å…³é”®è¯ä½œä¸ºæ ‡é¢˜
  const title = scene.use_case.length > 100 
    ? scene.use_case.substring(0, 100) + '...'
    : scene.use_case
  
  // ç”Ÿæˆ slugï¼Œç¡®ä¿ä¸ä¼šå¤ªé•¿
  const sceneText = scene.use_case.length > 80 
    ? scene.use_case.substring(0, 80) 
    : scene.use_case
  // ğŸ”¥ é˜²é‡å¤ï¼šå¯¹å®Œæ•´ use_case åšç¨³å®š hashï¼Œé¿å…é‡å¤è·‘ä»»åŠ¡æ—¶äº§ç”Ÿæµ·é‡é‡å¤è®°å½•
  // ä¹Ÿé¿å…è¿‡å»â€œslug å†²çªå°±åŠ æ—¶é—´æˆ³â€å¯¼è‡´çš„é‡å¤è†¨èƒ€
  const useCaseHash = createHash('sha1')
    .update(scene.use_case.trim(), 'utf8')
    .digest('hex')
    .slice(0, 10)
  const slug = generateSlugFromText(`${industry}-${useCaseHash}-${sceneText}`)
  
  // ç”Ÿæˆ H1 å’Œæè¿°
  const h1 = `AI Video Generation for ${scene.use_case} in ${industry}`
  const description = `Learn how to use AI video generation for ${scene.use_case} in the ${industry} industry. Create professional videos with Sora2.`

  // ğŸ”¥ å…ˆåšè½»é‡å»é‡ï¼šåŒä¸€ industry + use_case_type + h1 å·²å­˜åœ¨ï¼Œåˆ™è·³è¿‡ä¿å­˜
  // è¿™èƒ½è¦†ç›–â€œå†å²æ—§ slugâ€å¯¼è‡´çš„é‡å¤é—®é¢˜ï¼ˆä¸ä¾èµ– slug å†²çªï¼‰
  try {
    const { data: existing } = await supabase
      .from('use_cases')
      .select('id')
      .eq('industry', industry)
      .eq('use_case_type', useCaseType)
      .eq('h1', h1)
      .limit(1)
      .maybeSingle()
    if (existing?.id) {
      const duplicateError = new Error('Duplicate use case (same industry + type + h1), skipped.') as Error & {
        isDuplicate?: boolean
      }
      duplicateError.isDuplicate = true
      throw duplicateError
    }
  } catch (dedupeCheckError) {
    // å¦‚æœæ˜¯æˆ‘ä»¬æŠ›å‡ºçš„ duplicateï¼Œç»§ç»­å‘ä¸ŠæŠ›ï¼Œè®©ä¸Šå±‚æŒ‰â€œè·³è¿‡â€å¤„ç†
    if ((dedupeCheckError as Error & { isDuplicate?: boolean })?.isDuplicate) {
      throw dedupeCheckError
    }
    // å»é‡æŸ¥è¯¢å¤±è´¥ä¸åº”é˜»æ–­ä¿å­˜æµç¨‹ï¼ˆä¾‹å¦‚ä¸´æ—¶è¿æ¥é—®é¢˜ï¼‰
    console.warn(`[${industry}] å»é‡æ£€æŸ¥å¤±è´¥ï¼ˆç»§ç»­å°è¯•ä¿å­˜ï¼‰:`, dedupeCheckError)
  }

  // ç”Ÿæˆå®Œæ•´å†…å®¹
  const content = `# ${h1}

## Introduction

${scene.use_case}

## Why AI Video is Perfect for This Scenario

AI video generation offers several key advantages for ${scene.use_case} in the ${industry} industry:

- **Fast Production**: Create professional videos in minutes instead of days or weeks
- **Cost-Effective**: No need for expensive video production teams, equipment, or locations
- **Consistent Quality**: AI ensures professional output every time, maintaining brand consistency
- **Scalable**: Generate multiple variations easily for A/B testing or different markets
- **Flexible**: Quickly adapt videos for different platforms (YouTube, TikTok, Instagram, etc.)

## How to Use Sora2 for ${scene.use_case}

### Step 1: Create Your Video Prompt

Describe your ${scene.use_case} video needs in detail. Be specific about:
- The scene or setting
- The mood or tone
- Key elements or actions
- Style preferences (realistic, cinematic, animated, etc.)

### Step 2: Choose Video Settings

Select your preferred aspect ratio:
- **16:9** for YouTube, websites, presentations
- **9:16** for TikTok, Instagram Stories, Shorts
- **1:1** for Instagram posts, Facebook

Choose video duration: **10 seconds** or **15 seconds** based on your needs.

### Step 3: Generate Your Video

Click generate and wait a few moments. Sora2's AI will create your professional video with high-quality visuals and smooth transitions.

### Step 4: Download and Use

Once generated, download your video and use it immediately in your ${industry} marketing, training, or content strategy.

## Example Prompt for ${scene.use_case}

Here's an example prompt you can use with Sora2 to generate a **10-second or 15-second** video:

\`\`\`
[Example prompt based on the use case - will be generated based on scene description]
\`\`\`

**Note**: All videos generated by Sora2 are available in 10-second or 15-second durations. Choose the duration that best fits your content needs.

## Get Started Today

Start creating professional ${scene.use_case} videos for ${industry} today with Sora2 AI video generation platform. No technical skills required, no expensive equipment needed - just describe what you want, and AI will create it for you.`

  // è‡ªåŠ¨è´¨é‡æ£€æŸ¥
  const qualityCheck = checkContentQuality({
    title,
    h1,
    description,
    content,
    seo_keywords: [scene.use_case, industry, `${industry} AI video`],
  })

  // ğŸ”¥ è´¨é‡é˜ˆå€¼æ£€æŸ¥ï¼šå¦‚æœè´¨é‡åˆ†æ•° < 40ï¼Œè·³è¿‡ä¿å­˜ï¼Œé¿å…ä¿å­˜ä½è´¨é‡å†…å®¹
  // æ³¨æ„ï¼šæ­£å¸¸ç”Ÿæˆçš„å†…å®¹é€šå¸¸èƒ½æ‹¿åˆ° 60-100 åˆ†ï¼Œ40 åˆ†é˜ˆå€¼åªè¿‡æ»¤ä¸¥é‡ä½è´¨é‡å†…å®¹
  const QUALITY_THRESHOLD = 40
  if (qualityCheck.score < QUALITY_THRESHOLD) {
    const errorMessage = `è´¨é‡åˆ†æ•°è¿‡ä½ (${qualityCheck.score}/${QUALITY_THRESHOLD})ï¼Œè·³è¿‡ä¿å­˜ã€‚é—®é¢˜: ${qualityCheck.issues.join(', ')}`
    console.warn(`[${industry}] åœºæ™¯è¯ ${scene.id} è´¨é‡è¿‡ä½ï¼Œè·³è¿‡ä¿å­˜:`, {
      score: qualityCheck.score,
      threshold: QUALITY_THRESHOLD,
      issues: qualityCheck.issues,
      warnings: qualityCheck.warnings,
      scenePreview: scene.use_case.substring(0, 100),
    })
    // æŠ›å‡ºç‰¹å®šé”™è¯¯ï¼Œä¾¿äºåœ¨ saveBatchScenes ä¸­åŒºåˆ†
    const qualityError = new Error(errorMessage) as Error & { isQualityTooLow?: boolean }
    qualityError.isQualityTooLow = true
    throw qualityError
  }

  // æ ¹æ®è´¨é‡æ£€æŸ¥ç»“æœè®¾ç½®çŠ¶æ€
  const qualityStatus = qualityCheck.passed && qualityCheck.score >= 70 ? 'approved' : 'pending'
  const isPublished = qualityStatus === 'approved'

  // ç›´æ¥ä½¿ç”¨ Supabase ä¿å­˜ï¼ˆé¿å… HTTP è°ƒç”¨ï¼‰
  // ğŸ”¥ æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼Œé¿å…æ•°æ®åº“æ“ä½œå¡ä½
  const DB_TIMEOUT = 10000 // 10ç§’è¶…æ—¶
  
  try {
    // ğŸ”¥ ä½¿ç”¨ Promise.race ç¡®ä¿è¶…æ—¶æ§åˆ¶
    const insertPromise = supabase
      .from('use_cases')
      .insert({
        slug,
        title,
        h1,
        description,
        content,
        use_case_type: useCaseType,
        industry,
        is_published: isPublished,
        seo_keywords: [scene.use_case, industry, `${industry} AI video`],
        quality_status: qualityStatus,
        quality_score: qualityCheck.score,
        quality_issues: qualityCheck.issues,
      })
      .select()
    
    const timeoutPromise = new Promise<{ error: { message?: string; code?: string; details?: string; hint?: string } | null }>((_, reject) =>
      setTimeout(() => reject(new Error('æ•°æ®åº“ä¿å­˜è¶…æ—¶ï¼ˆ10ç§’ï¼‰')), DB_TIMEOUT)
    )
    
    const { error: insertError } = await Promise.race([insertPromise, timeoutPromise]) as { error: { message?: string; code?: string; details?: string; hint?: string } | null }

    if (insertError) {
      // å¦‚æœæ˜¯é‡å¤ slugï¼šè§†ä¸ºé‡å¤å†…å®¹ï¼Œç›´æ¥è·³è¿‡ï¼ˆé¿å…æ— é™å †ç§¯é‡å¤è®°å½•ï¼‰
      if (insertError.code === '23505') {
        const duplicateError = new Error(`Duplicate slug detected (likely duplicate use_case), skipped. slug=${slug}`) as Error & {
          isDuplicate?: boolean
        }
        duplicateError.isDuplicate = true
        throw duplicateError
      } else {
        console.error(`[${industry}] ä¿å­˜å¤±è´¥:`, {
          error: insertError.message,
          code: insertError.code,
          details: insertError.details,
          hint: insertError.hint,
          slug,
          useCaseType,
        })
        throw new Error(`ä¿å­˜å¤±è´¥: ${insertError.message} (code: ${insertError.code})`)
      }
    }
  } catch (error) {
    // è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
    const errorMessage = error instanceof Error ? error.message : String(error)
    console.error(`[${industry}] ä¿å­˜åœºæ™¯è¯å¼‚å¸¸:`, {
      error: errorMessage,
      sceneId: scene.id,
      sceneLength: scene.use_case.length,
      slug,
      useCaseType,
    })
    throw error
  }
}

