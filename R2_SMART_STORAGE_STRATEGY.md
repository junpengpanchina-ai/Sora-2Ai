# R2 智能存储策略

## 🎯 问题

如果启用 `R2_AUTO_UPLOAD_VIDEOS=true`，所有生成的视频都会自动上传到 R2，假设：
- 每个视频平均 10-20 MB
- 100 个用户，每人生成 5 个视频
- 总存储：100 × 5 × 15 MB = **7.5 GB**

随着用户增长，存储成本会快速增长。

## ✅ 解决方案：按需上传（On-Demand Upload）

### 策略说明

**默认行为（推荐）**：
- `R2_AUTO_UPLOAD_VIDEOS=false`（或不设置）
- 视频生成后使用原始 API URL
- **只在用户点击下载时，才上传到 R2**
- 节省存储：只有真正需要的视频才存储

**优势**：
- ✅ **零自动存储成本**：不自动上传，不占用存储
- ✅ **按需存储**：只有用户下载的视频才上传
- ✅ **保留质量**：下载时上传确保原始质量
- ✅ **智能更新**：上传后更新数据库，后续使用 R2 URL

### 工作流程

```
1. 视频生成成功
   ↓
2. 保存原始 API URL 到数据库
   ↓
3. 用户查看视频（使用原始 API URL，不占用 R2）
   ↓
4. 用户点击"下载"按钮
   ↓
5. 【按需上传】下载 API 检查：
   - 如果已经是 R2 URL → 直接返回
   - 如果是 API URL → 上传到 R2 → 更新数据库 → 返回 R2 URL
   ↓
6. 用户下载高质量视频（来自 R2）
```

## 📊 存储成本对比

### 方案 1: 自动上传所有视频（不推荐）

```
场景：100 用户，每人 5 个视频
- 自动上传：100 × 5 = 500 个视频
- 存储：500 × 15 MB = 7.5 GB
- 成本：R2 存储约 $0.015/GB/月 = $0.11/月
- 问题：很多视频用户可能不会下载
```

### 方案 2: 按需上传（推荐 ✅）

```
场景：100 用户，每人 5 个视频
- 假设 30% 用户会下载：30 × 5 = 150 个视频
- 存储：150 × 15 MB = 2.25 GB
- 成本：$0.034/月
- 节省：70% 的存储成本
```

## 🔧 配置说明

### 当前默认配置（推荐）

```env
# .env.local
# 不设置 R2_AUTO_UPLOAD_VIDEOS（或设置为 false）
# R2_AUTO_UPLOAD_VIDEOS=false
```

**效果**：
- ✅ 使用原始 API URL，零存储成本
- ✅ 点击下载时自动上传到 R2（按需）
- ✅ 上传后自动更新数据库，后续直接使用 R2 URL

### 可选：自动上传（如果需要）

```env
# .env.local
R2_AUTO_UPLOAD_VIDEOS=true
```

**效果**：
- ⚠️ 所有视频自动上传到 R2
- ⚠️ 立即占用存储空间
- ✅ 所有视频都有高质量版本

**使用场景**：
- 如果视频生成后需要立即分享
- 如果原始 API URL 可能过期
- 如果所有视频都需要高质量版本

## 📋 实现细节

### 1. 下载 API (`/api/video/download/[id]`)

**逻辑**：
1. 检查视频 URL 是否来自 R2
2. 如果不是 R2 URL：
   - 下载原始视频（使用 `Accept-Encoding: identity` 确保原始质量）
   - 上传到 R2
   - 更新数据库中的 `video_url` 为 R2 URL
   - 返回 R2 URL
3. 如果是 R2 URL：
   - 直接返回 R2 URL

**优势**：
- 第一次下载：上传到 R2，用户获得高质量版本
- 后续下载：直接使用 R2 URL，快速且高质量

### 2. 前端下载按钮

**更新前**：
```tsx
<a href={video_url} download>Download</a>
// 直接使用原始 URL
```

**更新后**：
```tsx
<a href={`/api/video/download/${task_id}`} download>Download</a>
// 通过下载 API，触发按需上传
```

## 🧹 清理策略（可选）

### 自动清理旧视频

如果需要，可以设置 R2 生命周期策略自动删除旧视频：

1. **Cloudflare R2 Dashboard** → 选择 bucket → **Settings** → **Lifecycle Rules**
2. 创建规则：
   - **Action**: Delete object
   - **Condition**: Object age > 30 days（或根据需要设置）
   - **Prefix**: `videos/`

**注意**：这会删除 R2 中的视频，但不影响数据库中的记录。如果用户再次下载，会重新上传。

### 手动清理 API

使用 `/api/admin/r2/cleanup` API 手动清理：

```bash
# 查看 30 天前的视频（dry run）
curl -X POST /api/admin/r2/cleanup?days=30&dryRun=true

# 实际删除 30 天前的视频
curl -X POST /api/admin/r2/cleanup?days=30
```

## 💡 最佳实践

### 1. 监控存储使用

定期检查 R2 存储使用情况：
- Cloudflare Dashboard → R2 → 查看存储统计
- 或使用 `/api/admin/r2/list` API

### 2. 设置存储预算

在 Cloudflare 中设置存储警告：
- Cloudflare Dashboard → Billing → 设置存储警告阈值

### 3. 分析下载率

如果发现很多用户下载视频，可以考虑：
- 提高自动上传的阈值（例如：热门视频自动上传）
- 或保持按需上传策略（推荐）

## 📈 扩展建议

### 未来优化（可选）

1. **热门视频自动上传**
   - 如果视频被多次访问，自动上传到 R2
   - 需要添加访问计数器

2. **分级存储**
   - 新视频：使用 API URL
   - 7 天后：自动上传到 R2
   - 30 天后：移至冷存储（如果支持）

3. **用户选择**
   - 让用户选择是否上传到 R2
   - 增加 UI 选项："保存高质量版本到云端"

## 🎯 总结

**推荐配置**：
```env
# 不设置或设置为 false（默认推荐）
# R2_AUTO_UPLOAD_VIDEOS=false
```

**优势**：
- ✅ 零自动存储成本
- ✅ 按需上传，节省 70%+ 存储
- ✅ 用户下载时自动获得高质量版本
- ✅ 一次上传，后续直接使用 R2 URL

**存储估算（按需上传）**：
- 假设 30% 下载率
- 100 用户 × 5 视频 × 30% × 15 MB = **2.25 GB**
- 成本：约 **$0.034/月**

比自动上传节省 **70%** 的存储成本！

