# ä¿®å¤æ€»ç»“ - å‰2ä¸ªå…³é”®é—®é¢˜å·²å®Œæˆ

## âœ… å·²å®Œæˆçš„ä¿®å¤ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

### â‘  å®šä»·æ•°æ®æºä¸ä¸€è‡´ âœ…

**é—®é¢˜**ï¼š`config.ts` å’Œ `planConfig.ts` çš„ç§¯åˆ†æ•°å­—ä¸ä¸€è‡´
- planConfig.ts: Starter 0+200, Creator 2000+600, Studio 6000+1500, Pro 20000+4000
- config.ts: Starter 0+120, Creator 600+60, Studio 1800+270, Pro 6000+1200

**ä¿®å¤**ï¼š`lib/billing/config.ts` ç°åœ¨ä» `planConfig.ts` å¯¼å…¥æ‰€æœ‰ç§¯åˆ†æ•°æ®
- ä½¿ç”¨ `...PLAN_CONFIGS.xxx` å±•å¼€
- åªä¿ç•™ UI é…ç½®å’Œ antiAbuse é…ç½®
- å•ä¸€æ•°æ®æºï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ `planConfig.ts` ä¸­å®šä¹‰

**éªŒè¯**ï¼š
```bash
# æ£€æŸ¥ä¸€è‡´æ€§
grep "bonusCredits.*200" lib/billing/planConfig.ts  # âœ… 200
grep "bonusCredits.*200" lib/billing/config.ts      # âœ… 200 (ä» planConfig å¯¼å…¥)
```

---

### â‘¡ Webhook RPC å‡½æ•°è°ƒç”¨ âœ…

**é—®é¢˜**ï¼šä»£ç è°ƒç”¨ `apply_purchase`ï¼Œä½† SQL ä¸­æ˜¯ `grant_credits_for_purchase`

**ä¿®å¤æ–‡ä»¶**ï¼š
1. `app/api/payment/webhook/route.ts` âœ…
2. `app/api/billing/finalize/route.ts` âœ…

**ä¿®æ”¹å†…å®¹**ï¼š
- ç§»é™¤ `apply_purchase` è°ƒç”¨
- æ”¹ä¸ºä½¿ç”¨ `grant_credits_for_purchase` RPC
- ç§»é™¤äº†æ‰‹åŠ¨æ’å…¥ purchases è®°å½•ï¼ˆRPC å‡½æ•°è‡ªåŠ¨å¤„ç†ï¼‰
- `billing/finalize` ä½¿ç”¨ `finalize_${session.id}` ä½œä¸ºå”¯ä¸€çš„ event_id

**RPC å‡½æ•°å‚æ•°**ï¼ˆå·²å¯¹é½ï¼‰ï¼š
```typescript
grant_credits_for_purchase({
  p_user_id: userId,
  p_plan_id: planId,
  p_payment_link_id: paymentLinkId || '',
  p_stripe_event_id: event.id, // æˆ– finalize_${session.id}
  p_stripe_session_id: session.id,
  p_stripe_payment_intent_id: session.payment_intent || null,
  p_email: session.customer_email || null,
  p_amount_total: session.amount_total || null,
  p_currency: session.currency || 'usd',
})
```

---

## â³ å‰©ä½™å·¥ä½œï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### â‘¢ RPC å‡½æ•°æ£€æŸ¥ï¼ˆéœ€è¦ç¡®è®¤ï¼‰

**é—®é¢˜**ï¼šä»£ç è°ƒç”¨ `can_purchase_starter` å’Œ `increment_usage_daily`ï¼Œä½†éœ€è¦ç¡®è®¤ SQL ä¸­æ˜¯å¦å­˜åœ¨

**å‘ç°**ï¼š
- `can_purchase_starter` åœ¨ `051_add_risk_control_fields.sql` ä¸­å®šä¹‰ï¼Œä½†æ£€æŸ¥çš„æ˜¯ `item_id` å­—æ®µï¼ˆæ–°è¡¨ç»“æ„ä½¿ç”¨ `plan_id`ï¼‰
- `increment_usage_daily` åœ¨ `054_deduct_credits_function.sql` ä¸­å®šä¹‰ï¼Œä½†éœ€è¦ `usage_daily` è¡¨ï¼ˆ0001_billing.sql ä¸­æ²¡æœ‰ï¼‰

**å»ºè®®**ï¼š
1. **can_purchase_starter**ï¼šç®€åŒ–å®ç°ï¼Œç›´æ¥åœ¨ä»£ç ä¸­æ£€æŸ¥ device + IPï¼ˆä¸ä¾èµ– RPCï¼‰
2. **increment_usage_daily**ï¼šå¦‚æœ `usage_daily` è¡¨ä¸å­˜åœ¨ï¼Œæš‚æ—¶ç§»é™¤è°ƒç”¨æˆ–è®°å½•è­¦å‘Š

---

### â‘£ Starter é˜²è–…ç®€åŒ–

**å½“å‰ä»£ç **ï¼š`app/api/payment/create-plan-checkout/route.ts` è°ƒç”¨ `can_purchase_starter` RPC

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç›´æ¥åœ¨ä»£ç ä¸­å®ç°ç®€åŒ–æ£€æŸ¥
```typescript
// æ£€æŸ¥ device_id
const { data: deviceCheck } = await supabase
  .from('starter_purchase_guards')
  .select('id')
  .eq('device_id', deviceId)
  .limit(1)
  .maybeSingle();

if (deviceCheck) {
  return NextResponse.json({ error: 'Starter already purchased on this device' }, { status: 403 });
}

// æ£€æŸ¥ IP 24h å†…è´­ä¹°æ¬¡æ•°
const { data: ipChecks } = await supabase
  .from('starter_purchase_guards')
  .select('id')
  .eq('ip', ipPrefix)
  .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

if (ipChecks && ipChecks.length >= 3) {
  return NextResponse.json({ error: 'Too many Starter purchases from this IP' }, { status: 403 });
}
```

---

### â‘¤ Webhook è¯†åˆ«ç­–ç•¥ç»Ÿä¸€

**å½“å‰ä»£ç **ï¼š`app/api/payment/webhook/route.ts` å’Œ `app/api/billing/finalize/route.ts` å¯èƒ½ä½¿ç”¨é‡‘é¢å…œåº•

**ä¿®å¤æ–¹æ¡ˆ**ï¼šç§»é™¤é‡‘é¢å…œåº•ï¼Œåªç”¨ metadata.plan_id å’Œ payment_link_id

---

### â‘¥ Veo Pro è§„åˆ™è¯´æ˜

**éœ€è¦æ·»åŠ **ï¼šåœ¨ Pricing é¡µé¢æˆ– FAQ æ·»åŠ è¯´æ˜
- "Veo Pro uses permanent credits only. Bonus credits are for Sora Preview and Veo Fast."

---

## ğŸ“Š ä¿®å¤è¿›åº¦

- âœ… â‘  å®šä»·æ•°æ®æºï¼ˆå·²å®Œæˆï¼‰
- âœ… â‘¡ Webhook RPC å‡½æ•°ï¼ˆå·²å®Œæˆï¼‰
- â³ â‘¢ RPC å‡½æ•°æ£€æŸ¥ï¼ˆéœ€è¦ç¡®è®¤ SQLï¼‰
- â³ â‘£ Starter é˜²è–…ç®€åŒ–ï¼ˆä»£ç å·²å‡†å¤‡å¥½ï¼‰
- â³ â‘¤ Webhook è¯†åˆ«ç­–ç•¥ï¼ˆéœ€è¦æ£€æŸ¥ä»£ç ï¼‰
- â³ â‘¥ Veo Pro è¯´æ˜ï¼ˆéœ€è¦å‰ç«¯ä¿®æ”¹ï¼‰

**å®Œæˆåº¦**ï¼š2/6 (33%)

**æœ€å…³é”®çš„å‰2ä¸ªé—®é¢˜å·²ä¿®å¤** âœ…

