# ç´§æ€¥ä¿®å¤è¡¥ä¸ - å¿…é¡»ä»Šæ™šå®Œæˆ

## âš ï¸ 6ä¸ªè‡´å‘½é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### â‘  planConfig.ts å’Œ config.ts å‘å¸æ•°ä¸ä¸€è‡´ï¼ˆè‡´å‘½ï¼‰

**é—®é¢˜**ï¼š
- `planConfig.ts`: Starter 0+200, Creator 2000+600, Studio 6000+1500, Pro 20000+4000
- `config.ts`: Starter 0+120, Creator 600+60, Studio 1800+270, Pro 6000+1200
- SQLå‡½æ•°ä½¿ç”¨ `planConfig.ts` çš„å€¼

**å½±å“**ï¼šå‰ç«¯æ˜¾ç¤ºä¸€å¥—ã€Webhook å‘å¸ä¸€å¥—ã€SQL å‘å¸ä¸€å¥— â†’ ç”¨æˆ·å¿…æŠ•è¯‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// lib/billing/config.ts
// åˆ é™¤ plans ä¸­çš„æ•°å­—é…ç½®ï¼Œæ”¹ä¸ºä» planConfig.ts å¯¼å…¥

import { PLAN_CONFIGS, type PlanId } from './planConfig';

export const PRICING_CONFIG = {
  // ... å…¶ä»–é…ç½®ä¿æŒä¸å˜
  plans: {
    free: { /* ... */ },
    starter: {
      ...PLAN_CONFIGS.starter, // ç›´æ¥ä½¿ç”¨ planConfig çš„æ•°æ®
      // åªä¿ç•™ UI é…ç½®
      ui: {
        title: "Starter Access",
        badge: "Try the workflow (7 days)",
        cta: "Start with Starter",
        bullets: [/* ... */],
      },
      antiAbuse: { /* ... */ },
    },
    creator: {
      ...PLAN_CONFIGS.creator,
      ui: { /* ... */ },
    },
    studio: {
      ...PLAN_CONFIGS.studio,
      ui: { /* ... */ },
    },
    pro: {
      ...PLAN_CONFIGS.pro,
      ui: { /* ... */ },
    },
  },
};
```

**æœ€å°æ”¹åŠ¨**ï¼š`config.ts` çš„ `plans` ç›´æ¥å¼•ç”¨ `PLAN_CONFIGS`ï¼Œä¸è¦é‡å¤å†™æ•°å­—ã€‚

---

### â‘¡ Webhook è·¯å¾„ä¸ä¸€è‡´ + RPC å‡½æ•°åä¸åŒ¹é…

**é—®é¢˜**ï¼š
- ä»£ç ä¸­æœ‰ä¸¤ä¸ª webhook æ–‡ä»¶ï¼š
  - `app/api/stripe/webhook/route.ts` - ä½¿ç”¨ `grant_credits_for_purchase` âœ…ï¼ˆä¸SQLåŒ¹é…ï¼‰
  - `app/api/payment/webhook/route.ts` - ä½¿ç”¨ `apply_purchase` âŒï¼ˆSQLä¸­æ²¡æœ‰ï¼‰
- æ–‡æ¡£ä¸­å†™çš„æ˜¯ `app/api/payment/webhook/route.ts`ï¼Œä½†å®é™…åº”è¯¥ç”¨å“ªä¸ªï¼Ÿ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**é€‰é¡¹Aï¼ˆæ¨èï¼‰**ï¼šç»Ÿä¸€ä½¿ç”¨ `app/api/stripe/webhook/route.ts`
- âœ… å·²ä½¿ç”¨æ­£ç¡®çš„ RPC å‡½æ•°å `grant_credits_for_purchase`
- âœ… ä¸ SQL å‡½æ•°åŒ¹é…
- âš ï¸ éœ€è¦ç¡®è®¤ Stripe Dashboard é…ç½®çš„ endpoint æ˜¯è¿™ä¸ªè·¯å¾„

**é€‰é¡¹B**ï¼šä¿®æ”¹ `app/api/payment/webhook/route.ts` ä½¿ç”¨æ­£ç¡®çš„ RPC å‡½æ•°
```typescript
// ä¿®æ”¹ç¬¬170è¡Œ
// ä»ï¼š
const { error: applyErr } = await supabase.rpc('apply_purchase', rpcParams);

// æ”¹ä¸ºï¼š
const { error: applyErr } = await supabase.rpc('grant_credits_for_purchase', {
  p_user_id: userId,
  p_plan_id: planId,
  p_payment_link_id: session.payment_link || '',
  p_stripe_event_id: event.id,
  p_stripe_session_id: session.id,
  p_stripe_payment_intent_id: session.payment_intent as string || null,
  p_email: session.customer_email || '',
  p_amount_total: session.amount_total || 0,
  p_currency: session.currency || 'usd',
});
```

**å¿…é¡»åš**ï¼š
1. ç¡®è®¤ Stripe Dashboard ä¸­é…ç½®çš„ Webhook endpoint URL
2. ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª webhook æ–‡ä»¶
3. ç¡®ä¿ RPC å‡½æ•°åä¸ SQL å‡½æ•°åä¸€è‡´

---

### â‘¢ RPC å‡½æ•°åç§°ä¸åŒ¹é…

**é—®é¢˜**ï¼š
- ä»£ç ä¸­è°ƒç”¨ï¼š`apply_purchase`, `can_purchase_starter`, `increment_usage_daily`
- SQL ä¸­åªæœ‰ï¼š`grant_credits_for_purchase`, `deduct_credits_from_wallet`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**å…¨å±€æœç´¢æ›¿æ¢**ï¼š
```bash
# æŸ¥æ‰¾æ‰€æœ‰è°ƒç”¨
grep -r "apply_purchase" app/ lib/
grep -r "can_purchase_starter" app/ lib/
grep -r "increment_usage_daily" app/ lib/
```

**ä¿®å¤æ–‡ä»¶**ï¼š
1. `app/api/payment/webhook/route.ts` - æ”¹ä¸º `grant_credits_for_purchase`
2. `app/api/payment/create-plan-checkout/route.ts` - æ£€æŸ¥ `can_purchase_starter` æ˜¯å¦å­˜åœ¨
3. `lib/billing/charge.ts` - æ£€æŸ¥ `increment_usage_daily` æ˜¯å¦å­˜åœ¨

**å¦‚æœ SQL ä¸­æ²¡æœ‰è¿™äº›å‡½æ•°ï¼Œéœ€è¦åˆ›å»º**ï¼š
```sql
-- æ£€æŸ¥æ˜¯å¦å­˜åœ¨
SELECT routine_name FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN ('apply_purchase', 'can_purchase_starter', 'increment_usage_daily');

-- å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»ºæˆ–ä½¿ç”¨ç°æœ‰å‡½æ•°
```

---

### â‘£ Starter é˜²è–…å­—æ®µç¼ºå¤±

**é—®é¢˜**ï¼š
- æ–‡æ¡£ä¸­å†™"è®°å½• payment_fingerprint / last4 / ip_hash / ip_prefix"
- ä½† `starter_purchase_guards` è¡¨åªæœ‰ï¼š`user_id, device_id, ip, email, created_at`
- æ²¡æœ‰ `payment_fingerprint`, `payment_last4` å­—æ®µ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**ä»Šæ™šæœ€å°æ”¹åŠ¨**ï¼šå…ˆç”¨ device + IP è·‘é€š
```typescript
// app/api/payment/create-plan-checkout/route.ts
// åªæ£€æŸ¥ device_id å’Œ IPï¼Œä¸æ£€æŸ¥ payment_fingerprint

// æ£€æŸ¥ device_id æ˜¯å¦å·²è´­ä¹°è¿‡ Starter
const { data: deviceCheck } = await supabase
  .from('starter_purchase_guards')
  .select('id')
  .eq('device_id', deviceId)
  .limit(1)
  .maybeSingle();

if (deviceCheck) {
  return NextResponse.json({ error: 'Starter already purchased on this device' }, { status: 403 });
}

// æ£€æŸ¥ IP 24h å†…è´­ä¹°æ¬¡æ•°
const { data: ipChecks } = await supabase
  .from('starter_purchase_guards')
  .select('id')
  .eq('ip', ipPrefix)
  .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());

if (ipChecks && ipChecks.length >= 3) {
  return NextResponse.json({ error: 'Too many Starter purchases from this IP' }, { status: 403 });
}
```

**æ˜å¤©å†åŠ **ï¼špayment_fingerprintï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼‰

---

### â‘¤ Webhook è¯†åˆ«ç­–ç•¥ä¸ç»Ÿä¸€

**é—®é¢˜**ï¼š
- æ–‡æ¡£ä¸­å†™"æ”¯æŒ Payment Link å’Œ Checkout Session ä¸¤ç§æ–¹å¼"
- ä½†å®é™…éœ€è¦ç»Ÿä¸€è¯†åˆ«ç­–ç•¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**ç»Ÿä¸€è¯†åˆ«ä¼˜å…ˆçº§**ï¼š
1. `metadata.plan_id`ï¼ˆæœ€ç¨³å®šï¼ŒCheckout Session æ–¹å¼ï¼‰
2. `payment_link_id` â†’ `planFromPaymentLink()`ï¼ˆPayment Link æ–¹å¼ï¼‰
3. âŒ ä¸è¦ç”¨é‡‘é¢å…œåº•ï¼ˆå®¹æ˜“è¯¯åˆ¤ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// app/api/payment/webhook/route.ts æˆ– app/api/stripe/webhook/route.ts

// 1. ä¼˜å…ˆä» metadata è·å–
const planId = session.metadata?.plan_id as PlanId | undefined;

// 2. å›é€€åˆ° payment_link
if (!planId) {
  const paymentLinkId = typeof session.payment_link === 'string' 
    ? session.payment_link 
    : null;
  if (paymentLinkId) {
    const plan = planFromPaymentLink(paymentLinkId);
    if (plan) {
      planId = plan.planId;
    }
  }
}

// 3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œè¿”å›é”™è¯¯ï¼ˆä¸è¦ç”¨é‡‘é¢å…œåº•ï¼‰
if (!planId) {
  return NextResponse.json({ 
    error: 'Cannot identify plan. Missing metadata.plan_id or payment_link' 
  }, { status: 400 });
}
```

---

### â‘¥ Veo Pro è§„åˆ™éœ€è¦å‰ç«¯å±•ç¤º

**é—®é¢˜**ï¼š
- Veo Pro åªç”¨æ°¸ä¹…ç§¯åˆ†ï¼ˆä¿æŠ¤ç°é‡‘æµï¼‰æ˜¯æ­£ç¡®çš„
- ä½†ç”¨æˆ·éœ€è¦æå‰çŸ¥é“ï¼Œå¦åˆ™ä¼šè§‰å¾—è¢«å‘

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**åœ¨ FAQ æˆ– Pricing é¡µé¢æ·»åŠ **ï¼š
```markdown
**Q: Can I use bonus credits for Veo Pro?**
A: No. Veo Pro uses permanent credits only. Bonus credits are for Sora Preview and Veo Fast. This helps us maintain service quality and cashflow.
```

**åœ¨ Pricing é¡µé¢æ¯ä¸ªè®¡åˆ’å¡ç‰‡ä¸­**ï¼š
```tsx
{planId === 'starter' && (
  <div className="text-sm text-gray-500 mt-2">
    âš ï¸ Veo Pro requires permanent credits only
  </div>
)}
```

---

## ğŸš€ ä»Šæ™šå¿…é¡»å®Œæˆçš„ä¿®å¤æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰

### Step 1: ç»Ÿä¸€å®šä»·æ•°æ®æºï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. ä¿®æ”¹ lib/billing/config.ts
# åˆ é™¤ plans ä¸­çš„ permanentCredits/bonusCredits æ•°å­—
# æ”¹ä¸ºä» PLAN_CONFIGS å¯¼å…¥
```

**éªŒè¯**ï¼š
```typescript
// æµ‹è¯•æ–‡ä»¶
import { PLAN_CONFIGS } from './planConfig';
import { PRICING_CONFIG } from './config';

console.log('planConfig starter:', PLAN_CONFIGS.starter.bonusCredits); // åº”è¯¥æ˜¯ 200
console.log('config starter:', PRICING_CONFIG.plans.starter.bonusCredits); // åº”è¯¥ä¹Ÿæ˜¯ 200
```

---

### Step 2: ç»Ÿä¸€ Webhook è·¯å¾„å’Œ RPC å‡½æ•°ï¼ˆ10åˆ†é’Ÿï¼‰

```bash
# 1. ç¡®è®¤ Stripe Dashboard é…ç½®çš„ endpoint URL
# 2. é€‰æ‹©ä½¿ç”¨å“ªä¸ª webhook æ–‡ä»¶ï¼ˆæ¨è app/api/stripe/webhook/route.tsï¼‰
# 3. å¦‚æœä½¿ç”¨ app/api/payment/webhook/route.tsï¼Œä¿®æ”¹ RPC è°ƒç”¨
```

**éªŒè¯**ï¼š
```bash
# æ£€æŸ¥ RPC å‡½æ•°è°ƒç”¨
grep -r "rpc.*apply_purchase" app/
grep -r "rpc.*grant_credits_for_purchase" app/

# åº”è¯¥åªæœ‰ä¸€ä¸ªæ­£ç¡®çš„è°ƒç”¨
```

---

### Step 3: ä¿®å¤ RPC å‡½æ•°åç§°ï¼ˆ10åˆ†é’Ÿï¼‰

```bash
# å…¨å±€æœç´¢å¹¶ä¿®å¤
# 1. apply_purchase â†’ grant_credits_for_purchase
# 2. æ£€æŸ¥ can_purchase_starter æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæˆ–ç§»é™¤è°ƒç”¨
# 3. æ£€æŸ¥ increment_usage_daily æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæˆ–ç§»é™¤è°ƒç”¨
```

**éªŒè¯**ï¼š
```sql
-- åœ¨ Supabase SQL Editor æ‰§è¡Œ
SELECT routine_name FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name IN (
  'grant_credits_for_purchase',
  'deduct_credits_from_wallet',
  'can_purchase_starter',
  'increment_usage_daily'
);
```

---

### Step 4: ç®€åŒ– Starter é˜²è–…ï¼ˆ5åˆ†é’Ÿï¼‰

```typescript
// åªä½¿ç”¨ device_id + IPï¼Œä¸æ£€æŸ¥ payment_fingerprint
// ä¿®æ”¹ app/api/payment/create-plan-checkout/route.ts
```

---

### Step 5: ç»Ÿä¸€ Webhook è¯†åˆ«ç­–ç•¥ï¼ˆ5åˆ†é’Ÿï¼‰

```typescript
// ç§»é™¤é‡‘é¢å…œåº•ï¼Œåªç”¨ metadata.plan_id å’Œ payment_link_id
// ä¿®æ”¹ webhook æ–‡ä»¶
```

---

### Step 6: æ·»åŠ  Veo Pro è§„åˆ™è¯´æ˜ï¼ˆ5åˆ†é’Ÿï¼‰

```tsx
// åœ¨ Pricing é¡µé¢æˆ– FAQ æ·»åŠ è¯´æ˜
```

---

## âœ… éªŒæ”¶ Checklistï¼ˆ10åˆ†é’Ÿï¼‰

- [ ] **å®šä»·ä¸€è‡´æ€§**ï¼š`planConfig.ts` å’Œ `config.ts` çš„ç§¯åˆ†æ•°å®Œå…¨ä¸€è‡´
- [ ] **Webhook è·¯å¾„**ï¼šStripe Dashboard é…ç½®çš„ endpoint ä¸ä»£ç æ–‡ä»¶ä¸€è‡´
- [ ] **RPC å‡½æ•°**ï¼šæ‰€æœ‰è°ƒç”¨çš„ RPC å‡½æ•°åœ¨ SQL ä¸­éƒ½å­˜åœ¨
- [ ] **Starter é˜²è–…**ï¼šdevice_id å’Œ IP æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- [ ] **Webhook è¯†åˆ«**ï¼šåªç”¨ metadata.plan_id å’Œ payment_link_idï¼Œä¸ç”¨é‡‘é¢
- [ ] **Veo Pro è¯´æ˜**ï¼šå‰ç«¯æœ‰æ¸…æ™°è¯´æ˜

---

## ğŸ“ ä¿®å¤åçš„æ–‡ä»¶æ¸…å•

1. `lib/billing/config.ts` - æ”¹ä¸ºä» planConfig å¯¼å…¥
2. `app/api/payment/webhook/route.ts` æˆ– `app/api/stripe/webhook/route.ts` - ç»Ÿä¸€ä½¿ç”¨
3. `app/api/payment/create-plan-checkout/route.ts` - ç®€åŒ–é˜²è–…æ£€æŸ¥
4. `lib/billing/charge.ts` - æ£€æŸ¥ RPC è°ƒç”¨
5. `app/pricing/page.tsx` æˆ– FAQ - æ·»åŠ  Veo Pro è¯´æ˜

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦ç”¨é‡‘é¢å…œåº•è¯†åˆ«è®¡åˆ’**ï¼šå®¹æ˜“è¯¯åˆ¤ï¼Œå¿…é¡»ç”¨ metadata æˆ– payment_link
2. **payment_fingerprint æ˜å¤©å†åŠ **ï¼šä»Šæ™šå…ˆç”¨ device + IP
3. **ç»Ÿä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰
4. **æµ‹è¯• Webhook**ï¼šä¿®å¤åå¿…é¡»æµ‹è¯•ä¸€æ¬¡å®Œæ•´æ”¯ä»˜æµç¨‹

---

**ä¼˜å…ˆçº§**ï¼šâ‘  > â‘¡ > â‘¢ > â‘£ > â‘¤ > â‘¥

**é¢„è®¡æ—¶é—´**ï¼š40åˆ†é’Ÿ

