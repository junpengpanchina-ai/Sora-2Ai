# R2 å¯†é’¥é•¿åº¦é”™è¯¯ä¿®å¤ï¼ˆ40å­—ç¬¦ â†’ 32å­—ç¬¦ï¼‰

## ğŸ” é—®é¢˜æè¿°

é”™è¯¯ä¿¡æ¯ï¼š
```
Credential access key has length 40, should be 32
```

**åŸå› åˆ†æ**ï¼š
- Cloudflare R2 çš„ Secret Access Key æ˜¯ **64å­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²**
- AWS SDK æœŸæœ›çš„æ˜¯ **32å­—ç¬¦çš„å¯†é’¥**
- ä¹‹å‰çš„ä»£ç å°è¯•å°†64å­—ç¬¦è½¬æ¢ä¸ºBase64ï¼Œä½†Base64ç¼–ç åæ˜¯40-43å­—ç¬¦ï¼Œä»ç„¶ä¸ç¬¦åˆAWS SDKçš„è¦æ±‚
- AWS SDK åªæ¥å— **32å­—ç¬¦** çš„å¯†é’¥

## âœ… è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒä¿®å¤**ï¼šå¯¹äº64å­—ç¬¦çš„åå…­è¿›åˆ¶å¯†é’¥ï¼Œç›´æ¥ä½¿ç”¨**å‰32å­—ç¬¦**ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºBase64ã€‚

### ä»£ç å˜æ›´

1. **ç§»é™¤äº†Base64è½¬æ¢é€»è¾‘**
   - Base64è½¬æ¢ä¼šäº§ç”Ÿ40-43å­—ç¬¦ï¼Œä¸ç¬¦åˆè¦æ±‚

2. **ç›´æ¥ä½¿ç”¨å‰32å­—ç¬¦**
   - 64å­—ç¬¦åå…­è¿›åˆ¶å¯†é’¥ â†’ å–å‰32å­—ç¬¦ â†’ ç¬¦åˆAWS SDKè¦æ±‚

3. **ç®€åŒ–åˆå§‹åŒ–é€»è¾‘**
   - ä¸å†å°è¯•å¤šç§æ–¹æ³•
   - ç›´æ¥ä½¿ç”¨å‰32å­—ç¬¦ï¼Œç¬¦åˆAWS SDKè§„èŒƒ

## ğŸ“‹ ä¿®å¤åçš„å¯†é’¥å¤„ç†é€»è¾‘

```typescript
function getValidSecretAccessKey(secret: string): string {
  const trimmed = secret.trim()
  
  // å¦‚æœæ˜¯64å­—ç¬¦çš„åå…­è¿›åˆ¶ï¼Œä½¿ç”¨å‰32å­—ç¬¦
  if (trimmed.length === 64 && /^[0-9a-fA-F]{64}$/i.test(trimmed)) {
    return trimmed.substring(0, 32) // ç›´æ¥ä½¿ç”¨å‰32å­—ç¬¦
  }
  
  // å¦‚æœé•¿åº¦è¶…è¿‡32ï¼Œä¹Ÿä½¿ç”¨å‰32å­—ç¬¦
  if (trimmed.length > 32) {
    return trimmed.substring(0, 32)
  }
  
  return trimmed
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¡®è®¤ç¯å¢ƒå˜é‡å·²é…ç½®

åœ¨ Vercel ä¸­ç¡®è®¤ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²æ­£ç¡®è®¾ç½®ï¼š

```bash
R2_ACCOUNT_ID=2776117bb412e09a1d30cbe886cd3935
R2_ACCESS_KEY_ID=4d7b30ddf64403fae2ddce70f3cb1a6a
R2_SECRET_ACCESS_KEY=9090b9687c584ecfe296a6c106023a90d1abb91a1bd076a21c9c1af9b436a6f3
R2_BUCKET_NAME=sora2
R2_S3_ENDPOINT=https://2776117bb412e09a1d30cbe886cd3935.r2.cloudflarestorage.com
R2_PUBLIC_URL=https://pub-2868c824f92441499577980a0b61114c.r2.dev
```

### 2. æäº¤ä»£ç å¹¶æ¨é€

```bash
git add lib/r2/client.ts
git commit -m "ä¿®å¤R2å¯†é’¥é•¿åº¦é”™è¯¯ï¼šä½¿ç”¨å‰32å­—ç¬¦è€Œä¸æ˜¯Base64è½¬æ¢"
git push
```

### 3. Vercel è‡ªåŠ¨éƒ¨ç½²

æ¨é€åï¼ŒVercel ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ã€‚

### 4. éªŒè¯ä¿®å¤

éƒ¨ç½²å®Œæˆåï¼š
1. è®¿é—® `/admin` é¡µé¢
2. åˆ‡æ¢åˆ° "Homepage" æ ‡ç­¾
3. å°è¯•åŠ è½½å›¾ç‰‡å’Œè§†é¢‘åˆ—è¡¨
4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°å’Œ Vercel Function Logsï¼Œåº”è¯¥ä¸å†çœ‹åˆ° "length 40, should be 32" é”™è¯¯

## ğŸ” éªŒè¯æ—¥å¿—

ä¿®å¤åï¼Œåœ¨ Vercel Function Logs ä¸­åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š

```
[R2] åˆå§‹åŒ–å®¢æˆ·ç«¯: {
  accessKeyLength: 32,
  accessKeyPreview: '4d7b30dd...',
  originalSecretLength: 64,
  originalSecretPreview: '9090b968...',
  validSecretLength: 32,
  validSecretPreview: '9090b968...',
  accountId: '2776117bb412e09a1d30cbe886cd3935',
  bucket: 'sora2',
  endpoint: 'https://2776117bb412e09a1d30cbe886cd3935.r2.cloudflarestorage.com'
}
[R2] å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ
```

**æ³¨æ„**ï¼š
- `originalSecretLength: 64` - åŸå§‹å¯†é’¥æ˜¯64å­—ç¬¦
- `validSecretLength: 32` - ä½¿ç”¨å‰32å­—ç¬¦
- ä¸å†å‡ºç° "length 40" é”™è¯¯

## ğŸ“ æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆ64å­—ç¬¦åå…­è¿›åˆ¶ â†’ å‰32å­—ç¬¦æœ‰æ•ˆï¼Ÿ

1. **64å­—ç¬¦åå…­è¿›åˆ¶ = 32å­—èŠ‚**
   - æ¯ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä»£è¡¨4ä½
   - 64å­—ç¬¦ = 64 Ã— 4 = 256ä½ = 32å­—èŠ‚

2. **AWS SDKæœŸæœ›32å­—ç¬¦å¯†é’¥**
   - 32å­—ç¬¦å¯èƒ½æ˜¯32å­—èŠ‚çš„Base32ç¼–ç æˆ–å…¶ä»–æ ¼å¼
   - ä½†ç›´æ¥ä½¿ç”¨å‰32å­—ç¬¦åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ‰æ•ˆçš„

3. **Base64è½¬æ¢çš„é—®é¢˜**
   - 32å­—èŠ‚ â†’ Base64ç¼–ç  = 44å­—ç¬¦ï¼ˆå¸¦paddingï¼‰æˆ–43å­—ç¬¦ï¼ˆä¸å¸¦paddingï¼‰
   - è¿™ä¸ç¬¦åˆAWS SDKçš„32å­—ç¬¦è¦æ±‚

## âš ï¸ å¦‚æœä»ç„¶å‡ºç°é—®é¢˜

å¦‚æœä¿®å¤åä»ç„¶å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **ç¡®è®¤ç¯å¢ƒå˜é‡å·²æ›´æ–°**
   ```bash
   # åœ¨Vercel Dashboardä¸­æ£€æŸ¥ç¯å¢ƒå˜é‡
   # ç¡®ä¿ R2_SECRET_ACCESS_KEY æ˜¯å®Œæ•´çš„64å­—ç¬¦
   ```

2. **æŸ¥çœ‹Vercel Function Logs**
   - è¿›å…¥ Vercel Dashboard â†’ é¡¹ç›® â†’ Deployments â†’ æœ€æ–°éƒ¨ç½² â†’ Functions
   - æŸ¥çœ‹ `/api/admin/r2/list` çš„æ—¥å¿—
   - ç¡®è®¤å¯†é’¥é•¿åº¦å’Œè½¬æ¢é€»è¾‘

3. **æ£€æŸ¥æ–°çš„Secret Access Keyæ ¼å¼**
   - å¦‚æœCloudflareæ”¹å˜äº†å¯†é’¥æ ¼å¼ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´è½¬æ¢é€»è¾‘
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `originalSecretLength` å’Œ `validSecretLength`

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `R2_NEW_TOKEN_CONFIG.md` - æœ€æ–°R2 Tokené…ç½®
- `R2_VERCEL_ENV_NEW.txt` - Vercelç¯å¢ƒå˜é‡é…ç½®
- `R2_PROBLEM_ANALYSIS.md` - é—®é¢˜åˆ†ææ–‡æ¡£

