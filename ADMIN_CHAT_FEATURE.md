# 管理员 AI 助手功能说明

## 📋 功能概述

在管理员后台新增了一个类似 ChatGPT 的 AI 助手窗口，支持：
- ✅ 多图片上传和识别
- ✅ 文字对话
- ✅ 历史记录保存
- ✅ 智能模型选择（根据内容自动选择最适合的 Gemini 模型）

## 🎯 智能模型选择规则

系统会根据消息内容自动选择最适合的模型：

### 1. **gemini-2-flash**（默认，成本最低）
- 适用于：一般对话、简单问题
- 特点：快速响应，成本最低

### 2. **gemini-3-flash**（中等成本）
- 触发条件：
  - 涉及**成本对比**、**价格售价**、**同行分析**
  - 包含关键词：成本、价格、售价、定价、费用、同行、竞争对手、竞品、对比、比较
- 特点：支持联网搜索，适合需要实时信息的分析任务

### 3. **gemini-3-pro**（最高质量，高成本）
- 触发条件：
  - 同时包含成本/价格和竞争对手关键词
  - 内容长度超过 1000 字符
  - 包含 3 个以上复杂分析关键词
- 特点：最高质量，适合复杂分析任务

## 🚀 使用方法

### 1. 访问功能
1. 登录管理员后台
2. 点击顶部导航栏的 **"AI 助手"** tab

### 2. 创建新对话
- 点击左侧 **"+ 新对话"** 按钮
- 或直接开始输入消息（系统会自动创建会话）

### 3. 发送消息
- **纯文本消息**：直接在输入框输入，按 `Cmd/Ctrl + Enter` 发送
- **带图片消息**：点击 📷 按钮上传图片，支持多张图片，然后输入文字或直接发送

### 4. 管理会话
- **切换会话**：点击左侧会话列表中的任意会话
- **删除会话**：点击会话右侧的 × 按钮
- **查看历史**：切换会话时会自动加载该会话的历史消息

## 📊 功能特性

### 多图片支持
- 支持同时上传多张图片
- 图片会显示在消息中
- 系统会自动识别图片内容并进行分析

### 历史记录保存
- 所有对话自动保存到数据库
- 支持多个会话，每个会话独立保存
- 会话标题自动生成（基于第一条消息）

### 模型信息显示
- 每条助手回复会显示使用的模型名称
- 显示模型说明（快速响应/支持联网搜索/最高质量）

## 🔧 技术实现

### 数据库表结构

#### `admin_chat_sessions`（会话表）
- `id`: UUID，主键
- `admin_user_id`: UUID，管理员ID
- `title`: TEXT，会话标题
- `created_at`: TIMESTAMPTZ，创建时间
- `updated_at`: TIMESTAMPTZ，更新时间

#### `admin_chat_messages`（消息表）
- `id`: UUID，主键
- `session_id`: UUID，会话ID
- `role`: TEXT，角色（user/assistant）
- `content`: TEXT，文本内容
- `images`: JSONB，图片数组（base64 或 URL）
- `model`: TEXT，使用的模型名称
- `created_at`: TIMESTAMPTZ，创建时间

### API 路由

- `POST /api/admin/chat` - 发送消息
- `GET /api/admin/chat/sessions` - 获取会话列表
- `POST /api/admin/chat/sessions` - 创建新会话
- `DELETE /api/admin/chat/sessions?id=xxx` - 删除会话
- `GET /api/admin/chat/messages?sessionId=xxx` - 获取消息列表

### 智能模型选择逻辑

位置：`lib/admin-chat/model-selector.ts`

核心函数：
- `detectComplexAnalysisTask()` - 检测是否需要复杂分析
- `selectModel()` - 根据内容和图片选择模型

## 📝 注意事项

1. **图片格式**：支持常见的图片格式（jpg, png, gif 等）
2. **图片大小**：建议单张图片不超过 10MB
3. **成本控制**：系统会自动选择最合适的模型，但复杂分析任务会使用更高成本的模型
4. **历史记录**：所有对话都会保存，注意定期清理不需要的会话

## 🔄 后续优化建议

1. **图片识别增强**：如果 Gemini API 支持多模态，可以直接传递图片进行识别
2. **会话标题自动生成**：基于对话内容自动生成更有意义的标题
3. **导出功能**：支持导出对话记录为文本或 PDF
4. **搜索功能**：在历史对话中搜索关键词
5. **模型手动选择**：允许用户手动选择模型（覆盖自动选择）

