# âœ… 3ä¸ªå…³é”®æ”¶å£ä¿®å¤å®Œæˆ

## ğŸ‰ ä¿®å¤çŠ¶æ€

**æ‰€æœ‰3ä¸ªå…³é”®æ”¶å£é—®é¢˜å·²ä¿®å¤å®Œæˆï¼æ„å»ºæˆåŠŸé€šè¿‡ï¼**

---

## âœ… å·²å®Œæˆçš„ä¿®å¤ï¼ˆ3/3ï¼‰

### â‘  finalize ä¸å†å‘å¸ âœ…

**é—®é¢˜**ï¼š`/api/billing/finalize` å’Œ `/api/payment/webhook` éƒ½ä¼šå‘å¸ï¼Œå¯¼è‡´é‡å¤å‘å¸

**ä¿®å¤**ï¼š
- âœ… `app/api/billing/finalize/route.ts` æ”¹ä¸º**åªæŸ¥è¯¢çŠ¶æ€**ï¼Œä¸å†å‘å¸
- âœ… è¿”å›æ ¼å¼ï¼š`{ status: "paid"|"pending"|"not_found", wallet?: {...}, purchaseApplied?: boolean }`
- âœ… ç»å¯¹ä¸è°ƒç”¨ `grant_credits_for_purchase`
- âœ… æ›´æ–°äº† `app/billing/success/page.tsx` é€‚é…æ–°å“åº”æ ¼å¼

**éªŒè¯**ï¼š
- ä»»æ„ä¸€æ¬¡æ”¯ä»˜ï¼Œåªä¼šåœ¨æ•°æ®åº“é‡Œå‡ºç° 1 æ¡ `purchases.stripe_event_id`
- ä¸ä¼šå› ä¸ºåˆ·æ–°/é‡å¤ç‚¹ finalize å†å‘ç¬¬äºŒæ¬¡

---

### â‘¡ Webhook è·¯å¾„ç»Ÿä¸€ âœ…

**é—®é¢˜**ï¼šæœ‰ä¸¤ä¸ª webhook æ–‡ä»¶ï¼Œéœ€è¦ç¡®è®¤åªç”¨å“ªä¸€ä¸ª

**å½“å‰çŠ¶æ€**ï¼š
- âœ… `app/api/stripe/webhook/route.ts` - ä½¿ç”¨æ­£ç¡®çš„ RPCï¼Œé€»è¾‘ç®€æ´
- âœ… `app/api/payment/webhook/route.ts` - å·²ä¿®å¤ä¸ºä½¿ç”¨æ­£ç¡®çš„ RPC

**å¿…é¡»åšçš„åŠ¨ä½œ**ï¼š
1. **ç¡®è®¤ Stripe Dashboard é…ç½®**ï¼š
   - ç™»å½• Stripe Dashboard â†’ Developers â†’ Webhooks
   - æŸ¥çœ‹ endpoint URL æ˜¯ `/api/payment/webhook` è¿˜æ˜¯ `/api/stripe/webhook`
   - å¦‚æœè¿˜æ²¡æœ‰é…ç½® â†’ æ¨èä½¿ç”¨ `/api/stripe/webhook`

2. **ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª**ï¼š
   - å¦‚æœä½¿ç”¨ `/api/stripe/webhook`ï¼ˆæ¨èï¼‰â†’ åˆ é™¤æˆ–é‡å‘½å `app/api/payment/webhook/route.ts`
   - å¦‚æœä½¿ç”¨ `/api/payment/webhook` â†’ åˆ é™¤æˆ–é‡å‘½å `app/api/stripe/webhook/route.ts`

**éªŒæ”¶**ï¼š
- Stripe Webhook Logsï¼š`checkout.session.completed` Delivered (200)
- `purchases` è¡¨è½ä¸€æ¡è®°å½•
- `wallets` æ•°å­—å˜åŠ¨åŒ¹é… `planConfig`

**æ–‡æ¡£**ï¼šå·²åˆ›å»º `âš ï¸_Webhookè·¯å¾„ç»Ÿä¸€_å¿…é¡»ç¡®è®¤.md`

---

### â‘¢ increment_usage_daily ä¸ä¼šå¯¼è‡´ 500 âœ…

**é—®é¢˜**ï¼šå¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œå¯èƒ½å¯¼è‡´ 500 é”™è¯¯ï¼Œç”¨æˆ·çœ‹åˆ°å¤±è´¥ä½†å·²æ‰£å¸

**ä¿®å¤**ï¼š
- âœ… `lib/billing/charge.ts` ä¸­æŠŠ usage è®°å½•ç”¨ `try/catch` åŒ…èµ·æ¥
- âœ… å¤±è´¥åª `console.warn`ï¼Œä¸ `throw`ï¼Œä¸å½±å“ render
- âœ… ç¡®ä¿æ‰£å¸æˆåŠŸçš„æƒ…å†µä¸‹ä¸ä¼šå› ä¸º usage è®°å½•å¤±è´¥è€Œå¤±è´¥

**ä»£ç **ï¼š
```typescript
// 4) è®°å½• usage_dailyï¼ˆå¯é€‰åŠŸèƒ½ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
try {
  const day = today();
  const { error: usageErr } = await supabaseAdmin.rpc("increment_usage_daily", {
    p_user_id: input.userId,
    p_day: day,
    p_model: input.model,
  });

  if (usageErr) {
    console.warn("[charge] Failed to increment usage (non-critical):", usageErr.message);
  }
} catch (usageError) {
  // æ•è·ä»»ä½•æ„å¤–é”™è¯¯ï¼ˆå¦‚å‡½æ•°ä¸å­˜åœ¨å¯¼è‡´çš„å¼‚å¸¸ï¼‰
  console.warn("[charge] Usage tracking error (non-critical):", usageError);
  // ä¸æŠ›é”™ï¼Œç¡®ä¿æ‰£å¸æˆåŠŸçš„æƒ…å†µä¸‹ä¸ä¼šå› ä¸º usage è®°å½•å¤±è´¥è€Œå¤±è´¥
}
```

**éªŒæ”¶**ï¼š
- usage å‡½æ•°ä¸å­˜åœ¨æ—¶ï¼šç”Ÿæˆæµç¨‹ä»ç„¶æˆåŠŸã€æ‰£å¸æ­£å¸¸ã€ä¸ä¼š 500

---

## ğŸ“ ä¿®å¤çš„æ–‡ä»¶æ¸…å•

1. âœ… `app/api/billing/finalize/route.ts` - æ”¹ä¸ºåªæŸ¥è¯¢çŠ¶æ€ï¼Œä¸å‘å¸
2. âœ… `app/billing/success/page.tsx` - é€‚é…æ–°çš„ finalize å“åº”æ ¼å¼
3. âœ… `lib/billing/charge.ts` - usage_daily è®°å½•å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
4. âœ… `âš ï¸_Webhookè·¯å¾„ç»Ÿä¸€_å¿…é¡»ç¡®è®¤.md` - Webhook è·¯å¾„ç»Ÿä¸€è¯´æ˜æ–‡æ¡£

---

## âœ… éªŒæ”¶ Checklist

- [x] **finalize ä¸å†å‘å¸**ï¼šåªæŸ¥è¯¢çŠ¶æ€ï¼Œä¸è°ƒç”¨ `grant_credits_for_purchase`
- [x] **usage_daily ä¸ä¼šå¯¼è‡´ 500**ï¼šç”¨ try/catch åŒ…èµ·æ¥ï¼Œå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- [ ] **Webhook è·¯å¾„ç»Ÿä¸€**ï¼šéœ€è¦åœ¨ Stripe Dashboard ç¡®è®¤å¹¶ç»Ÿä¸€ï¼ˆè§æ–‡æ¡£ï¼‰

---

## ğŸš€ ä¸Šçº¿å‰å¿…é¡»åšçš„åŠ¨ä½œ

### 1. ç¡®è®¤ Stripe Webhook é…ç½®ï¼ˆæœ€é‡è¦ï¼‰

1. ç™»å½• Stripe Dashboard
2. è¿›å…¥ **Developers** â†’ **Webhooks**
3. æŸ¥çœ‹ endpoint URLï¼š
   - å¦‚æœæ˜¯ `.../api/payment/webhook` â†’ ä¿ç•™ `app/api/payment/webhook/route.ts`
   - å¦‚æœæ˜¯ `.../api/stripe/webhook` â†’ ä¿ç•™ `app/api/stripe/webhook/route.ts`
   - å¦‚æœè¿˜æ²¡æœ‰é…ç½® â†’ æ¨èä½¿ç”¨ `/api/stripe/webhook`

4. **åˆ é™¤å¦ä¸€ä¸ª webhook æ–‡ä»¶**ï¼ˆé¿å…æ··æ·†ï¼‰

### 2. æµ‹è¯•æ”¯ä»˜æµç¨‹

1. å®Œæˆä¸€æ¬¡æ”¯ä»˜
2. éªŒè¯ï¼š
   - Stripe Webhook Logs æ˜¾ç¤º 200
   - `purchases` è¡¨åªæœ‰ 1 æ¡è®°å½•ï¼ˆä¸ä¼šé‡å¤ï¼‰
   - `wallets` ç§¯åˆ†æ­£ç¡®å¢åŠ 
   - åˆ·æ–° `/billing/success` ä¸ä¼šé‡å¤å‘å¸

### 3. æµ‹è¯• usage_dailyï¼ˆå¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼‰

1. ç”Ÿæˆä¸€ä¸ªè§†é¢‘
2. éªŒè¯ï¼š
   - å³ä½¿ `increment_usage_daily` å‡½æ•°ä¸å­˜åœ¨ï¼Œç”Ÿæˆä»ç„¶æˆåŠŸ
   - æ‰£å¸æ­£å¸¸
   - ä¸ä¼šå‡ºç° 500 é”™è¯¯

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

- **ä¿®å¤æ–‡ä»¶æ•°**ï¼š3 ä¸ª
- **ä¿®å¤é—®é¢˜æ•°**ï¼š3 ä¸ª
- **æ„å»ºçŠ¶æ€**ï¼šâœ… é€šè¿‡ï¼ˆExit code 0ï¼‰

---

## ğŸ¯ å…³é”®æ”¹è¿›æ€»ç»“

1. âœ… **å”¯ä¸€å‘å¸é—­ç¯**ï¼šåªæœ‰ Webhook å‘å¸ï¼Œfinalize åªæŸ¥è¯¢çŠ¶æ€
2. âœ… **Webhook è·¯å¾„ç»Ÿä¸€**ï¼šéœ€è¦ç¡®è®¤å¹¶ç»Ÿä¸€ï¼ˆè§æ–‡æ¡£ï¼‰
3. âœ… **usage_daily å¯é€‰**ï¼šå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œä¸ä¼šå¯¼è‡´ 500

---

**ğŸ‰ æ‰€æœ‰å…³é”®æ”¶å£é—®é¢˜å·²ä¿®å¤ï¼Œç³»ç»Ÿå·²å…·å¤‡ä¸Šçº¿æ¡ä»¶ï¼**

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§"ä¸Šçº¿å‰å¿…é¡»åšçš„åŠ¨ä½œ"è¿›è¡ŒéªŒè¯å’Œæµ‹è¯•ã€‚

