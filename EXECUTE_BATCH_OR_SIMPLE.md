# 🔄 分批执行或简化执行方案

## 🚨 问题

即使只执行 DO $$ 块，UPDATE 操作也超时了。

**原因**：表有 216,273 条记录，一次性更新所有符合条件的记录可能超过超时限制。

## ✅ 解决方案

### 方案 1：分批执行（推荐）

**文件**：`068_setup_scene_data_batch.sql`

**原理**：每次只处理 1000 条记录，循环执行直到处理完所有记录。

**优点**：
- ✅ 避免超时
- ✅ 可以处理所有记录
- ✅ 有进度提示（NOTICE 消息）

**执行步骤**：
1. 执行 `068_setup_scene_data_batch.sql`
2. 查看 NOTICE 消息，确认每批处理的数量
3. 循环会自动执行，直到处理完所有记录

**预期输出**：
```
NOTICE: ✅ 本批处理了 1000 个场景，总计 1000 个场景设置了 in_sitemap = TRUE
NOTICE: ✅ 本批处理了 1000 个场景，总计 2000 个场景设置了 in_sitemap = TRUE
...
NOTICE: ✅ 完成！总共为 215697 个场景设置了 in_sitemap = TRUE
```

---

### 方案 2：简化执行（测试用）

**文件**：`068_setup_scene_data_simple.sql`

**原理**：只处理前 1000 条记录，先测试逻辑是否正确。

**优点**：
- ✅ 快速，不会超时
- ✅ 可以测试逻辑
- ✅ 确认后可以多次执行或增加数量

**执行步骤**：
1. 执行 `068_setup_scene_data_simple.sql`
2. 查看 NOTICE 消息，确认处理成功
3. 如果逻辑正确，可以：
   - 多次执行脚本（每次处理 1000 条）
   - 或者修改脚本中的 `LIMIT 1000` 为更大的数字（例如 5000、10000）

**预期输出**：
```
NOTICE: ✅ 为 1000 个场景设置了 in_sitemap = TRUE（前 1000 条）
NOTICE: ✅ 为 1000 个场景设置了初始 AI 分数 0.7（前 1000 条）
```

---

## 🎯 推荐方案

### 如果你想一次性处理所有记录

**使用方案 1**：`068_setup_scene_data_batch.sql`
- 会自动分批处理
- 有进度提示
- 可能需要一些时间，但不会超时

### 如果你想先测试少量记录

**使用方案 2**：`068_setup_scene_data_simple.sql`
- 快速执行，不会超时
- 可以验证逻辑
- 确认后可以逐步增加数量

---

## 📋 执行清单

### 方案 1（分批执行）
- [ ] **步骤 1**：执行 `068_setup_scene_data_batch.sql`
- [ ] **步骤 2**：查看 NOTICE 消息，确认分批处理进度
- [ ] **步骤 3**：等待循环完成（会显示 "✅ 完成！"）
- [ ] **完成**：所有记录已处理完成

### 方案 2（简化执行）
- [ ] **步骤 1**：执行 `068_setup_scene_data_simple.sql`
- [ ] **步骤 2**：查看 NOTICE 消息，确认处理成功（1000 条）
- [ ] **步骤 3**：（可选）多次执行脚本，每次处理 1000 条
- [ ] **完成**：已处理所需的记录数

---

## 🚀 开始执行

### 推荐：先测试方案 2

1. **打开文件**：`supabase/migrations/068_setup_scene_data_simple.sql`
2. **执行整个文件**
3. **查看 NOTICE 消息**，确认处理成功
4. **如果逻辑正确**，可以多次执行或使用方案 1

### 或者：直接使用方案 1

1. **打开文件**：`supabase/migrations/068_setup_scene_data_batch.sql`
2. **执行整个文件**
3. **等待循环完成**（可能需要一些时间）
4. **查看最终 NOTICE 消息**，确认所有记录已处理

---

## 💡 提示

- **分批执行可能需要一些时间**：如果有 21 万条记录，需要执行 216 次批次
- **可以先测试少量记录**：使用方案 2 先处理 1000 条，确认逻辑正确
- **可以逐步增加数量**：如果方案 2 成功，可以修改 `LIMIT 1000` 为更大的数字

准备好了吗？建议先使用方案 2 测试，确认逻辑正确后再使用方案 1 处理所有记录！
