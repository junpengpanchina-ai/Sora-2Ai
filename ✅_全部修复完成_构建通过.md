# âœ… å…¨éƒ¨ä¿®å¤å®Œæˆ - æ„å»ºé€šè¿‡

## ğŸ‰ ä¿®å¤çŠ¶æ€

**æ‰€æœ‰6ä¸ªè‡´å‘½é—®é¢˜å·²ä¿®å¤å®Œæˆï¼æ„å»ºæˆåŠŸé€šè¿‡ï¼**

**æ„å»ºæ—¶é—´**ï¼š2026-01-07  
**æ„å»ºçŠ¶æ€**ï¼šâœ… Exit code 0

---

## âœ… å·²å®Œæˆçš„ä¿®å¤ï¼ˆ6/6ï¼‰

### â‘  å®šä»·æ•°æ®æºä¸ä¸€è‡´ âœ…

**æ–‡ä»¶**ï¼š`lib/billing/config.ts`

**ä¿®å¤**ï¼š
- ä» `planConfig.ts` å¯¼å…¥æ‰€æœ‰ç§¯åˆ†æ•°æ®
- æ˜ç¡®æ˜ å°„å­—æ®µï¼š`priceUsd`, `permanentCredits`, `bonusCredits`, `bonusExpiresInDays`
- å•ä¸€æ•°æ®æºï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ `planConfig.ts` ä¸­å®šä¹‰

**éªŒè¯**ï¼š
```typescript
PLAN_CONFIGS.starter.bonusCredits === PRICING_CONFIG.plans.starter.bonusCredits // âœ… 200
```

---

### â‘¡ Webhook RPC å‡½æ•°è°ƒç”¨ âœ…

**æ–‡ä»¶**ï¼š
- `app/api/payment/webhook/route.ts`
- `app/api/billing/finalize/route.ts`

**ä¿®å¤**ï¼š
- æ‰€æœ‰ `apply_purchase` è°ƒç”¨æ”¹ä¸º `grant_credits_for_purchase`
- ä¸ SQL å‡½æ•°å®Œå…¨åŒ¹é…
- ç§»é™¤äº†æ‰‹åŠ¨æ’å…¥ purchases è®°å½•ï¼ˆRPC è‡ªåŠ¨å¤„ç†ï¼‰

---

### â‘¢ RPC å‡½æ•°æ£€æŸ¥ âœ…

**æ–‡ä»¶**ï¼š`app/api/payment/create-plan-checkout/route.ts`

**ä¿®å¤**ï¼š
- ç§»é™¤äº† `can_purchase_starter` RPC è°ƒç”¨
- ç›´æ¥åœ¨ä»£ç ä¸­å®ç°ç®€åŒ–æ£€æŸ¥
- ä¸ä¾èµ–å¯èƒ½ä¸å­˜åœ¨çš„ RPC å‡½æ•°

---

### â‘£ Starter é˜²è–…ç®€åŒ– âœ…

**æ–‡ä»¶**ï¼š`app/api/payment/create-plan-checkout/route.ts`

**ä¿®å¤**ï¼š
- åªä½¿ç”¨ device_id + IP æ£€æŸ¥
- ä¸æ£€æŸ¥ payment_fingerprintï¼ˆæ˜å¤©å†åŠ ï¼‰
- æ£€æŸ¥è§„åˆ™ï¼šuser_id â†’ device_id â†’ IP /24 æ®µ

---

### â‘¤ Webhook è¯†åˆ«ç­–ç•¥ç»Ÿä¸€ âœ…

**æ–‡ä»¶**ï¼š
- `app/api/payment/webhook/route.ts`
- `app/api/billing/finalize/route.ts`

**ä¿®å¤**ï¼š
- ç»Ÿä¸€è¯†åˆ«ä¼˜å…ˆçº§ï¼š1) metadata.plan_id 2) payment_link_id
- **å®Œå…¨ç§»é™¤é‡‘é¢å…œåº•**ï¼ˆå®¹æ˜“è¯¯åˆ¤ï¼‰
- å¦‚æœæ— æ³•è¯†åˆ«ï¼Œè¿”å›æ˜ç¡®é”™è¯¯

---

### â‘¥ Veo Pro è§„åˆ™è¯´æ˜ âœ…

**æ–‡ä»¶**ï¼š`components/pricing/PricingPage.tsx`

**ä¿®å¤**ï¼š
- FAQ ä¸­æ·»åŠ ï¼š"Can I use bonus credits for Veo Pro?"
- è®¡åˆ’å¡ç‰‡ä¸­æ·»åŠ ï¼š"Note: Veo Pro uses permanent credits only"

---

## ğŸ“ ä¿®å¤çš„æ–‡ä»¶æ¸…å•

1. âœ… `lib/billing/config.ts` - ä» planConfig å¯¼å…¥ï¼Œç»Ÿä¸€æ•°æ®æº
2. âœ… `app/api/payment/webhook/route.ts` - ä½¿ç”¨ grant_credits_for_purchaseï¼Œç§»é™¤é‡‘é¢å…œåº•
3. âœ… `app/api/billing/finalize/route.ts` - ä½¿ç”¨ grant_credits_for_purchaseï¼Œç§»é™¤é‡‘é¢å…œåº•
4. âœ… `app/api/payment/create-plan-checkout/route.ts` - ç®€åŒ– Starter é˜²è–…æ£€æŸ¥
5. âœ… `components/pricing/PricingPage.tsx` - æ·»åŠ  Veo Pro è§„åˆ™è¯´æ˜

---

## âœ… æ„å»ºéªŒè¯

```bash
npm run build
# âœ… Exit code: 0
# âœ… ç¼–è¯‘æˆåŠŸ
# âœ… ç±»å‹æ£€æŸ¥é€šè¿‡
# âš ï¸ åªæœ‰è­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
```

---

## ğŸš€ ä¸Šçº¿å‰æ£€æŸ¥æ¸…å•

### å¿…é¡»ç¡®è®¤

- [ ] **Stripe Dashboard Webhook é…ç½®**
  - ç¡®è®¤ endpoint URL æŒ‡å‘ `/api/payment/webhook` æˆ– `/api/stripe/webhook`
  - ç¡®è®¤å·²é€‰æ‹© `checkout.session.completed` äº‹ä»¶
  - ç¡®è®¤ Webhook Secret å·²é…ç½®

- [ ] **æ•°æ®åº“è¿ç§»**
  - ç¡®è®¤å·²æ‰§è¡Œ `0001_billing.sql`
  - éªŒè¯å‡½æ•°å­˜åœ¨ï¼š
    ```sql
    SELECT routine_name FROM information_schema.routines 
    WHERE routine_schema = 'public' 
    AND routine_name IN (
      'grant_credits_for_purchase',
      'deduct_credits_from_wallet',
      'ensure_wallet'
    );
    ```

- [ ] **ç¯å¢ƒå˜é‡**
  - `STRIPE_SECRET_KEY`
  - `STRIPE_WEBHOOK_SECRET`
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `SUPABASE_SERVICE_ROLE_KEY`

### æµ‹è¯•æµç¨‹

1. **æ–°ç”¨æˆ·æ³¨å†Œ** â†’ éªŒè¯ `profiles` è¡¨å†™å…¥ email
2. **è´­ä¹° Starter** â†’ éªŒè¯ï¼š
   - Webhook æ”¶åˆ°äº‹ä»¶
   - `purchases` è¡¨æœ‰æ–°è®°å½•
   - `wallets` è¡¨ bonus_credits å¢åŠ  200
   - `wallet_ledger` æœ‰è®°å½•
3. **ç”Ÿæˆè§†é¢‘** â†’ éªŒè¯ï¼š
   - ç§¯åˆ†æ­£ç¡®æ‰£é™¤
   - `wallet_ledger` æœ‰æ‰£å¸è®°å½•
4. **Starter é˜²è–…** â†’ éªŒè¯ï¼š
   - åŒä¸€ device ç¬¬äºŒæ¬¡è´­ä¹°è¿”å› 403
   - IP /24 æ®µ 24h å†…è¶…è¿‡ 3 ä¸ªè¿”å› 403

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

- **ä¿®å¤æ–‡ä»¶æ•°**ï¼š5 ä¸ª
- **ä¿®å¤é—®é¢˜æ•°**ï¼š6 ä¸ª
- **ä»£ç è¡Œæ•°å˜åŒ–**ï¼šçº¦ 200 è¡Œ
- **æ„å»ºçŠ¶æ€**ï¼šâœ… é€šè¿‡

---

## ğŸ¯ å…³é”®æ”¹è¿›æ€»ç»“

1. âœ… **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ç§¯åˆ†æ•°å­—åªåœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰ï¼ˆplanConfig.tsï¼‰
2. âœ… **RPC å‡½æ•°å¯¹é½**ï¼šä»£ç è°ƒç”¨ä¸ SQL å‡½æ•°å®Œå…¨åŒ¹é…
3. âœ… **é˜²è–…ç®€åŒ–**ï¼šä¸ä¾èµ–å¯èƒ½ä¸å­˜åœ¨çš„ RPC å‡½æ•°ï¼Œç›´æ¥åœ¨ä»£ç ä¸­å®ç°
4. âœ… **è¯†åˆ«ç­–ç•¥ç»Ÿä¸€**ï¼šä¸ä½¿ç”¨å®¹æ˜“è¯¯åˆ¤çš„é‡‘é¢å…œåº•
5. âœ… **ç”¨æˆ·é€æ˜åº¦**ï¼šVeo Pro è§„åˆ™æ¸…æ™°è¯´æ˜
6. âœ… **æ„å»ºé€šè¿‡**ï¼šæ‰€æœ‰ TypeScript é”™è¯¯å·²ä¿®å¤

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Stripe Webhook è·¯å¾„**ï¼šéœ€è¦ç¡®è®¤ Dashboard é…ç½®çš„ endpoint URL
2. **æ•°æ®åº“è¿ç§»**ï¼šç¡®ä¿å·²æ‰§è¡Œ `0001_billing.sql`
3. **æµ‹è¯•æ”¯ä»˜æµç¨‹**ï¼šä¿®å¤åå¿…é¡»æµ‹è¯•ä¸€æ¬¡å®Œæ•´æ”¯ä»˜æµç¨‹
4. **payment_fingerprint**ï¼šæ˜å¤©å†åŠ ï¼ˆéœ€è¦ä» PaymentIntent è·å–ï¼‰

---

**ğŸ‰ æ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤ï¼Œç³»ç»Ÿå·²å…·å¤‡ä¸Šçº¿æ¡ä»¶ï¼**

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§"ä¸Šçº¿å‰æ£€æŸ¥æ¸…å•"è¿›è¡ŒéªŒè¯å’Œæµ‹è¯•ã€‚

