# 批量生成文案积分保护修复

## 🎯 问题

**原问题**：
- 保存失败后继续下一个批次
- 下一个批次又会调用 API，导致积分被重复扣除
- 每次 63-70 积分（gemini-2.5-flash）
- 如果是 pro 模型，直接 140-160 积分起步

## ✅ 修复方案

### 1. 保存失败率检查

**逻辑**：
- 如果保存失败率 > 50%，**立即停止生成**
- 避免继续调用 API 浪费积分
- 只有在保存成功率 >= 50% 时才继续下一个批次

### 2. 修复位置

#### A. gemini-2.5-flash
- ✅ 添加保存失败率检查
- ✅ 如果失败率 > 50%，停止生成
- ✅ 避免继续调用 API 浪费积分

#### B. gemini-3-pro
- ✅ 添加保存失败率检查
- ✅ 如果失败率 > 50%，停止生成
- ✅ 避免继续调用 API 浪费积分

#### C. gemini-3-flash
- ✅ 添加保存失败率检查
- ✅ 如果失败率 > 50%，停止生成
- ✅ 避免继续调用 API 浪费积分

#### D. gemini-3-pro fallback
- ✅ 添加保存失败率检查
- ✅ 如果失败率 > 50%，停止生成
- ✅ 避免继续调用 API 浪费积分

### 3. 保存重试机制

**现有机制**：
- 每个场景词最多重试 5 次
- 根据错误类型调整重试延迟
- 连接错误时延迟更长

**改进**：
- 如果保存失败率 > 50%，立即停止
- 避免在保存失败的情况下继续调用 API

## 📊 积分保护效果

### 修复前
- ❌ 保存失败 → 继续下一个批次 → 调用 API → 扣除积分
- ❌ 即使保存失败，也会继续生成，浪费积分

### 修复后
- ✅ 保存失败率 > 50% → 立即停止 → 不再调用 API → 节省积分
- ✅ 只有在保存成功率 >= 50% 时才继续生成

## 🔧 使用建议

### 1. 监控保存失败率

**检查日志**：
- 如果看到 "保存失败率过高" 的警告，说明保存有问题
- 需要检查数据库连接或配置

### 2. 优化保存逻辑

**如果保存失败率高**：
- 检查数据库连接
- 检查 Supabase 配置
- 检查网络连接
- 增加重试延迟

### 3. 调整失败率阈值

**当前阈值**：50%

**如果需要调整**：
- 修改 `saveFailureRate > 0.5` 为其他值
- 例如：`saveFailureRate > 0.3`（30% 失败率就停止）

## 📝 代码示例

```typescript
// 检查保存失败率
const totalAttempted = saveResult.savedCount + saveResult.failedCount
const saveFailureRate = totalAttempted > 0 ? saveResult.failedCount / totalAttempted : 0

if (saveFailureRate > 0.5) {
  console.error(`保存失败率过高 (${(saveFailureRate * 100).toFixed(1)}%)，停止生成避免浪费积分`)
  break // 停止整个循环，避免继续调用 API 浪费积分
}
```

## ✅ 总结

### 修复内容
1. ✅ 添加保存失败率检查（50% 阈值）
2. ✅ 如果失败率 > 50%，立即停止生成
3. ✅ 避免在保存失败的情况下继续调用 API
4. ✅ 保护积分不被浪费

### 效果
- **节省积分**：避免在保存失败时继续调用 API
- **及时停止**：如果保存失败率高，立即停止避免浪费
- **更好的错误处理**：清晰的错误日志和停止原因

