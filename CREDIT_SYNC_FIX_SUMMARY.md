# ç§¯åˆ†åŒæ­¥ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åæ˜ ï¼š
1. **æµ‹è¯•è´¦å·æ˜¾ç¤ºæœ‰ç§¯åˆ†ä½†æ— æ³•ä½¿ç”¨**ï¼šUI æ˜¾ç¤º 5320 ç§¯åˆ†ï¼Œä½†ç”Ÿæˆè§†é¢‘æ—¶æç¤º"ç§¯åˆ†ä¸è¶³"
2. **çœŸå®è´¦å·å……å€¼åç§¯åˆ†å¯èƒ½ä¸åŒæ­¥**ï¼šæ‹…å¿ƒå……é’±åçœ‹ä¸åˆ°ç§¯åˆ†åŒæ­¥
3. **Admin è°ƒæ•´ç§¯åˆ†éœ€è¦ç¡®ä¿åŒæ­¥**ï¼šé¿å…è°ƒæ•´åç”¨æˆ·çœ‹ä¸åˆ°ç§¯åˆ†å˜åŒ–

## ğŸ” æ ¹æœ¬åŸå› 

1. **æ˜¾ç¤ºä¸æ‰£è´¹ä¸ä¸€è‡´**ï¼š
   - `/api/stats` ä»æ—§çš„ `users.credits` å­—æ®µè¯»å–ç§¯åˆ†
   - å®é™…æ‰£è´¹ä½¿ç”¨æ–°çš„ `credit_wallet` è¡¨
   - å¯¼è‡´æ˜¾ç¤ºæœ‰ç§¯åˆ†ï¼Œä½†é’±åŒ…ä¸ºç©º

2. **Admin è°ƒæ•´æœªå®Œå…¨åŒæ­¥**ï¼š
   - æ—§çš„ `admin_adjust_user_credits` å‡½æ•°æ›´æ–° `users.credits` å’Œ `wallets` è¡¨
   - ä½†ç³»ç»Ÿå®é™…ä½¿ç”¨ `credit_wallet` è¡¨
   - å¯¼è‡´è°ƒæ•´åç§¯åˆ†æœªåŒæ­¥åˆ°æ­£ç¡®çš„è¡¨

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä¿®å¤ `/api/stats` ç«¯ç‚¹
**æ–‡ä»¶**: `app/api/stats/route.ts`

**ä¿®å¤å†…å®¹**:
- ä»æ—§çš„ `userProfile.credits` æ”¹ä¸ºä½¿ç”¨ `get_total_available_credits` RPC å‡½æ•°
- ä»é’±åŒ…ç³»ç»Ÿï¼ˆ`credit_wallet`ï¼‰è¯»å–ç§¯åˆ†
- æ·»åŠ å‘åå…¼å®¹çš„å›é€€æœºåˆ¶

**æ•ˆæœ**:
- âœ… UI æ˜¾ç¤ºçš„ç§¯åˆ†ä¸é’±åŒ…ç³»ç»Ÿä¸€è‡´
- âœ… ç”¨æˆ·çœ‹åˆ°çš„ç§¯åˆ†å°±æ˜¯å®é™…å¯ç”¨çš„ç§¯åˆ†

### 2. åˆ›å»ºè¿ç§» 059 - Admin ç§¯åˆ†è°ƒæ•´
**æ–‡ä»¶**: `supabase/migrations/059_fix_admin_adjust_use_wallet_only.sql`

**ä¿®å¤å†…å®¹**:
- å®Œå…¨ä½¿ç”¨ `credit_wallet` è¡¨ï¼ˆä¸å†ä½¿ç”¨ `wallets` æˆ– `users.credits`ï¼‰
- è‡ªåŠ¨åˆ›å»ºé’±åŒ…ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- ç§»é™¤å¯¹æ—§ `users.credits` å­—æ®µçš„æ›´æ–°
- è®°å½•åˆ° `credit_ledger` è¡¨ï¼ˆå®¡è®¡è¿½è¸ªï¼‰

**æ•ˆæœ**:
- âœ… Admin è°ƒæ•´ç§¯åˆ†æ—¶ï¼Œç›´æ¥å†™å…¥ `credit_wallet` è¡¨
- âœ… ç¡®ä¿ä¸æ‰£è´¹ç³»ç»Ÿä½¿ç”¨åŒä¸€å¼ è¡¨
- âœ… è°ƒæ•´åç«‹å³ç”Ÿæ•ˆï¼Œç”¨æˆ·å¯è§

### 3. ä¿®å¤ Admin API GET æ–¹æ³•
**æ–‡ä»¶**: `app/api/admin/credits/route.ts`

**ä¿®å¤å†…å®¹**:
- ä» `wallets` è¡¨æ”¹ä¸º `credit_wallet` è¡¨
- æ˜¾ç¤ºæ°¸ä¹…ç§¯åˆ†å’Œ Bonus ç§¯åˆ†

**æ•ˆæœ**:
- âœ… Admin é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„é’±åŒ…ä½™é¢
- âœ… å¯ä»¥çœ‹åˆ°æ°¸ä¹…ç§¯åˆ†å’Œ Bonus ç§¯åˆ†çš„è¯¦ç»†æƒ…å†µ

### 4. å¢å¼º Admin API POST æ–¹æ³•
**æ–‡ä»¶**: `app/api/admin/credits/route.ts`

**ä¿®å¤å†…å®¹**:
- è°ƒæ•´åç«‹å³éªŒè¯é’±åŒ…ä½™é¢
- è¿”å›æœ€æ–°çš„é’±åŒ…ä¿¡æ¯ï¼ˆæ°¸ä¹…ç§¯åˆ†ã€Bonus ç§¯åˆ†ã€æ€»å¯ç”¨ç§¯åˆ†ï¼‰
- æ·»åŠ æˆåŠŸæ¶ˆæ¯ï¼Œæ˜ç¡®è¯´æ˜å·²åŒæ­¥åˆ°é’±åŒ…ç³»ç»Ÿ

**æ•ˆæœ**:
- âœ… Admin è°ƒæ•´åå¯ä»¥ç«‹å³çœ‹åˆ°åŒæ­¥ç»“æœ
- âœ… éªŒè¯åŒæ­¥æ˜¯å¦æˆåŠŸ
- âœ… æä¾›æ¸…æ™°çš„åé¦ˆä¿¡æ¯

## ğŸ“‹ å……å€¼æµç¨‹éªŒè¯

### å……å€¼æµç¨‹å·²æ­£ç¡®åŒæ­¥ âœ…

æ‰€æœ‰å……å€¼æµç¨‹éƒ½å·²ä½¿ç”¨ `addCreditsToWallet` å‡½æ•°ï¼Œè¯¥å‡½æ•°ï¼š
1. è°ƒç”¨ `add_credits_to_wallet` SQL å‡½æ•°
2. å†™å…¥ `credit_wallet` è¡¨
3. è®°å½•åˆ° `credit_ledger` è¡¨ï¼ˆå®¡è®¡è¿½è¸ªï¼‰

**æ¶‰åŠçš„ç«¯ç‚¹**:
- âœ… `/api/payment/webhook` - Stripe webhook å¤„ç†
- âœ… `/api/payment/verify-payment` - æ”¯ä»˜éªŒè¯
- âœ… `/api/payment/sync-payments` - æ”¯ä»˜åŒæ­¥
- âœ… `/api/stripe/webhook` - Stripe webhookï¼ˆæ–°ç³»ç»Ÿï¼‰

## ğŸ”„ ç§¯åˆ†åŒæ­¥æµç¨‹

### å……å€¼æµç¨‹
```
ç”¨æˆ·æ”¯ä»˜ â†’ Stripe Webhook â†’ addCreditsToWallet() â†’ credit_wallet è¡¨ â†’ ç”¨æˆ·å¯è§
```

### Admin è°ƒæ•´æµç¨‹
```
Admin è°ƒæ•´ â†’ admin_adjust_user_credits() â†’ credit_wallet è¡¨ â†’ è¿”å›æœ€æ–°ä½™é¢ â†’ ç”¨æˆ·å¯è§
```

### æ‰£è´¹æµç¨‹
```
ç”Ÿæˆè§†é¢‘ â†’ deductCreditsFromWallet() â†’ credit_wallet è¡¨ â†’ æ‰£é™¤ç§¯åˆ†
```

### æ˜¾ç¤ºæµç¨‹
```
UI è¯·æ±‚ â†’ /api/stats â†’ get_total_available_credits() â†’ credit_wallet è¡¨ â†’ æ˜¾ç¤ºç§¯åˆ†
```

## âœ… éªŒè¯æ¸…å•

### çœŸå®è´¦å·å……å€¼
- [x] å……å€¼æµç¨‹ä½¿ç”¨ `addCreditsToWallet`
- [x] å†™å…¥ `credit_wallet` è¡¨
- [x] UI ä»é’±åŒ…ç³»ç»Ÿè¯»å–ç§¯åˆ†
- [x] æ‰£è´¹ä»é’±åŒ…ç³»ç»Ÿæ‰£é™¤ç§¯åˆ†

### Admin è°ƒæ•´ç§¯åˆ†
- [x] ä½¿ç”¨ `credit_wallet` è¡¨ï¼ˆè¿ç§» 059ï¼‰
- [x] è‡ªåŠ¨åˆ›å»ºé’±åŒ…ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- [x] è®°å½•åˆ° `credit_ledger` è¡¨
- [x] è¿”å›æœ€æ–°ä½™é¢éªŒè¯åŒæ­¥

### UI æ˜¾ç¤ºç§¯åˆ†
- [x] ä»é’±åŒ…ç³»ç»Ÿè¯»å–
- [x] æ˜¾ç¤ºæ°¸ä¹…ç§¯åˆ† + æœ‰æ•ˆ Bonus ç§¯åˆ†
- [x] ä¸æ‰£è´¹é€»è¾‘ä¸€è‡´

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### å¿…é¡»æ‰§è¡Œ
1. **æ‰§è¡Œè¿ç§» 059**ï¼š
   ```sql
   -- åœ¨ Supabase Dashboard â†’ SQL Editor ä¸­æ‰§è¡Œ
   -- æ–‡ä»¶: supabase/migrations/059_fix_admin_adjust_use_wallet_only.sql
   ```

2. **éªŒè¯è¿ç§»æˆåŠŸ**ï¼š
   ```sql
   -- æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²æ›´æ–°
   SELECT routine_name, routine_definition 
   FROM information_schema.routines 
   WHERE routine_schema = 'public' 
   AND routine_name = 'admin_adjust_user_credits';
   ```

### æµ‹è¯•å»ºè®®
1. **æµ‹è¯•å……å€¼æµç¨‹**ï¼š
   - ä½¿ç”¨çœŸå®è´¦å·å……å€¼
   - éªŒè¯ç§¯åˆ†ç«‹å³æ˜¾ç¤ºåœ¨ UI
   - éªŒè¯å¯ä»¥æ­£å¸¸ç”Ÿæˆè§†é¢‘

2. **æµ‹è¯• Admin è°ƒæ•´**ï¼š
   - Admin åå°è°ƒæ•´ç§¯åˆ†
   - éªŒè¯è¿”å›çš„æœ€æ–°ä½™é¢
   - éªŒè¯ç”¨æˆ·ç«¯ç«‹å³çœ‹åˆ°å˜åŒ–

3. **æµ‹è¯•ç§¯åˆ†æ˜¾ç¤º**ï¼š
   - éªŒè¯ UI æ˜¾ç¤ºçš„ç§¯åˆ†ä¸é’±åŒ…ç³»ç»Ÿä¸€è‡´
   - éªŒè¯æ‰£è´¹åç§¯åˆ†æ­£ç¡®å‡å°‘

## ğŸ“Š ç³»ç»Ÿæ¶æ„

### ç§¯åˆ†å­˜å‚¨
- **ä¸»è¡¨**: `credit_wallet`ï¼ˆæ°¸ä¹…ç§¯åˆ† + Bonus ç§¯åˆ†ï¼‰
- **å®¡è®¡è¡¨**: `credit_ledger`ï¼ˆæ‰€æœ‰ç§¯åˆ†å˜åŠ¨è®°å½•ï¼‰
- **è°ƒæ•´è®°å½•**: `credit_adjustments`ï¼ˆAdmin è°ƒæ•´è®°å½•ï¼‰

### ç§¯åˆ†è®¡ç®—
- **æ€»å¯ç”¨ç§¯åˆ†** = `permanent_credits` + `æœ‰æ•ˆ bonus_credits`ï¼ˆæœªè¿‡æœŸï¼‰
- **æ‰£è´¹ä¼˜å…ˆçº§**: Bonus ç§¯åˆ†ä¼˜å…ˆï¼ˆVeo Pro é™¤å¤–ï¼‰

### æ•°æ®ä¸€è‡´æ€§
- âœ… æ‰€æœ‰ç§¯åˆ†æ“ä½œç»Ÿä¸€ä½¿ç”¨ `credit_wallet` è¡¨
- âœ… æ‰€æœ‰æ“ä½œéƒ½è®°å½•åˆ° `credit_ledger` è¡¨
- âœ… Admin è°ƒæ•´è®°å½•åˆ° `credit_adjustments` è¡¨

## ğŸ‰ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ UI æ˜¾ç¤º 5320 ç§¯åˆ†ï¼Œä½†æ— æ³•ä½¿ç”¨
- âŒ å……å€¼åå¯èƒ½çœ‹ä¸åˆ°ç§¯åˆ†åŒæ­¥
- âŒ Admin è°ƒæ•´åç”¨æˆ·å¯èƒ½çœ‹ä¸åˆ°å˜åŒ–

### ä¿®å¤å
- âœ… UI æ˜¾ç¤ºçš„ç§¯åˆ†å°±æ˜¯å®é™…å¯ç”¨ç§¯åˆ†
- âœ… å……å€¼åç«‹å³åŒæ­¥åˆ°é’±åŒ…ï¼Œç”¨æˆ·å¯è§
- âœ… Admin è°ƒæ•´åç«‹å³åŒæ­¥ï¼Œè¿”å›æœ€æ–°ä½™é¢éªŒè¯
- âœ… æ‰€æœ‰ç§¯åˆ†æ“ä½œç»Ÿä¸€ä½¿ç”¨é’±åŒ…ç³»ç»Ÿ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è¿ç§» 059 å¿…é¡»æ‰§è¡Œ**ï¼šå¦åˆ™ Admin è°ƒæ•´ä»ä¼šä½¿ç”¨æ—§é€»è¾‘
2. **æ—§ç§¯åˆ†å­—æ®µ**ï¼š`users.credits` å­—æ®µå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨
3. **é’±åŒ…è‡ªåŠ¨åˆ›å»º**ï¼šå¦‚æœç”¨æˆ·æ²¡æœ‰é’±åŒ…è®°å½•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆåˆå§‹åŒ–ä¸º 0ï¼‰
4. **Bonus ç§¯åˆ†è¿‡æœŸ**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†è¿‡æœŸçš„ Bonus ç§¯åˆ†

---

**æœ€åæ›´æ–°**: 2026-01-07  
**çŠ¶æ€**: âœ… æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼Œç­‰å¾…æ‰§è¡Œè¿ç§» 059
