# ä¿®å¤è¿›åº¦ - å·²å®Œæˆ

## âœ… å·²å®Œæˆçš„ä¿®å¤

### â‘  å®šä»·æ•°æ®æºä¸ä¸€è‡´ï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤æ–‡ä»¶**ï¼š`lib/billing/config.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- ä» `planConfig.ts` å¯¼å…¥ `PLAN_CONFIGS`
- `starter`, `creator`, `studio`, `pro` è®¡åˆ’ç°åœ¨ä½¿ç”¨ `...PLAN_CONFIGS.xxx` å±•å¼€
- åªä¿ç•™ UI é…ç½®å’Œ antiAbuse é…ç½®
- ç§¯åˆ†æ•°å­—ï¼ˆpermanentCredits, bonusCreditsï¼‰ç°åœ¨ç»Ÿä¸€ä» `planConfig.ts` è¯»å–

**éªŒè¯**ï¼š
```typescript
import { PLAN_CONFIGS } from './planConfig';
import { PRICING_CONFIG } from './config';

// ç°åœ¨åº”è¯¥ä¸€è‡´
console.log(PLAN_CONFIGS.starter.bonusCredits); // 200
console.log(PRICING_CONFIG.plans.starter.bonusCredits); // 200 âœ…
```

---

### â‘¡ Webhook RPC å‡½æ•°è°ƒç”¨ï¼ˆå·²å®Œæˆï¼‰

**ä¿®å¤æ–‡ä»¶**ï¼š
1. `app/api/payment/webhook/route.ts`
2. `app/api/billing/finalize/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š

#### `app/api/payment/webhook/route.ts`
- ç§»é™¤ `apply_purchase` è°ƒç”¨
- æ”¹ä¸ºä½¿ç”¨ `grant_credits_for_purchase` RPC
- ç§»é™¤äº†æ‰‹åŠ¨æ’å…¥ purchases è®°å½•ï¼ˆRPC å‡½æ•°ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
- ç§»é™¤äº†é£æ§å­—æ®µçš„æ‰‹åŠ¨æ’å…¥ï¼ˆå½“å‰ç‰ˆæœ¬æš‚ä¸æ”¯æŒï¼‰

#### `app/api/billing/finalize/route.ts`
- ç§»é™¤ `apply_purchase` è°ƒç”¨
- æ”¹ä¸ºä½¿ç”¨ `grant_credits_for_purchase` RPC
- ä½¿ç”¨ `finalize_${session.id}` ä½œä¸ºå”¯ä¸€çš„ event_idï¼ˆå› ä¸ºè¿™ä¸æ˜¯ webhook è°ƒç”¨ï¼‰
- ç§»é™¤äº†æ‰‹åŠ¨æ’å…¥ purchases è®°å½•

**RPC å‡½æ•°å‚æ•°**ï¼š
```typescript
grant_credits_for_purchase({
  p_user_id: userId,
  p_plan_id: planId,
  p_payment_link_id: paymentLinkId,
  p_stripe_event_id: event.id, // æˆ– finalize_${session.id}
  p_stripe_session_id: session.id,
  p_stripe_payment_intent_id: session.payment_intent || null,
  p_email: session.customer_email || null,
  p_amount_total: session.amount_total || null,
  p_currency: session.currency || 'usd',
})
```

---

## â³ å¾…ä¿®å¤çš„é—®é¢˜

### â‘¢ RPC å‡½æ•°åç§°æ£€æŸ¥
- [ ] æ£€æŸ¥ `can_purchase_starter` æ˜¯å¦å­˜åœ¨
- [ ] æ£€æŸ¥ `increment_usage_daily` æ˜¯å¦å­˜åœ¨
- [ ] å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»ºæˆ–ç§»é™¤è°ƒç”¨

### â‘£ Starter é˜²è–…ç®€åŒ–
- [ ] ä¿®æ”¹ `app/api/payment/create-plan-checkout/route.ts`
- [ ] åªä½¿ç”¨ device_id + IPï¼Œä¸æ£€æŸ¥ payment_fingerprint

### â‘¤ Webhook è¯†åˆ«ç­–ç•¥ç»Ÿä¸€
- [ ] ç§»é™¤é‡‘é¢å…œåº•é€»è¾‘
- [ ] åªç”¨ metadata.plan_id å’Œ payment_link_id

### â‘¥ Veo Pro è§„åˆ™è¯´æ˜
- [ ] åœ¨ Pricing é¡µé¢æˆ– FAQ æ·»åŠ è¯´æ˜

---

## ğŸ“ ä¸‹ä¸€æ­¥

ç»§ç»­ä¿®å¤å‰©ä½™ 4 ä¸ªé—®é¢˜ï¼ˆâ‘¢â‘£â‘¤â‘¥ï¼‰

