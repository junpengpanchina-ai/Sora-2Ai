# 三模型智能内容生成系统 — 完整架构（适配版）

## 📊 系统架构图

```
┌──────────────────────────────────────────────┐
│        用户任务：批量生成场景词（10,000 条）     │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ① 调度层（Task Dispatcher）                │
│  - 按行业拆分任务（每个行业独立处理）           │
│  - 批量处理（10～50条/批，避免超时）          │
│  - 任务状态管理（pending → processing → completed）│
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ② 模型选择层（Model Selector）             │
│                                              │
│  默认：gemini-2.5-flash（低成本，高速）        │
│  条件切换：gemini-3-flash（联网能力）          │
│  最终兜底：gemini-3-pro（最高质量）            │
│                                              │
│  选择规则：                                    │
│     A. 行业难度判断（医疗/工程/法律 → 3-flash） │
│     B. 极端专业领域（手术/航空航天 → 3-pro）    │
│     C. 质量检查失败 → 自动升级模型              │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│          ③ 内容生成层                         │
│     （根据模型进行内容生成调用）               │
│                                              │
│ Local Gen → gemini-2.5-flash                │
│ Web Gen   → gemini-3-flash（联网搜索）        │
│ Expert Gen→ gemini-3-pro（专业知识）          │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ④ 缺陷检测层（Quality Checker）            │
│                                              │
│ 检查点：                                      │
│   1. 数量不足（< 50%）                        │
│   2. 重复率（> 30% → 3-flash, > 80% → 3-pro） │
│   3. 内容过短（> 20%）                        │
│   4. 空结果([] / "")                           │
│   5. 错误响应（"No data", "Not found"）       │
│   6. 行业不匹配                                │
└──────────────────────────────────────────────┘
                         │
     ┌──────────────┬──────────────┬──────────────┐
     │ 合格（Pass）  │失败（Retry） │灾难失败（Upgrade） │
     ▼               ▼               ▼
┌────────────┐  ┌────────────┐  ┌────────────────────┐
│ 保存结果     │  │ 重试同模型     │  │ 升级模型（2.5→3F→3P）│
└────────────┘  └────────────┘  └────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ⑤ 自适应 Fallback（智能切换）               │
│                                              │
│ 基于质量评分自动决定：                        │
│   - 保持当前模型（质量通过）                   │
│   - 切换 gemini-3-flash（中等失败）            │
│   - 切换 gemini-3-pro（严重失败）              │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ⑥ 成本监控层（Billing Monitor）            │
│                                              │
│ 实时监控：                                      │
│   - 模型使用统计（2.5-flash / 3-flash / 3-pro）│
│   - 任务成本估算（基于 token 估算）              │
│   - 行业成本分析（哪些行业成本高）               │
│                                              │
│ 智能优化：                                      │
│   → 记录失败率，自动调整模型选择策略            │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│    ⑦ 内容合成层（Aggregator）                 │
│    对生成内容进行清洗 → 去重 → 保存             │
│                                               │
│ 处理事件：                                      │
│   - 去重（基于 use_case 内容）                  │
│   - 过滤无效内容（长度 < 50 字符）               │
│   - 行业 → 场景词 映射                          │
└──────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────┐
│          ⑧ 输出层（Output Layer）             │
│    最终输出：数据库（use_cases 表）             │
│                                                │
│    每条场景词包含：                              │
│    - 行业分类                                    │
│    - 场景词内容                                  │
│    - 质量评分                                    │
│    - 生成模型（用于成本分析）                     │
└──────────────────────────────────────────────┘
```

## 🎯 核心组件说明

### ① 调度层（Task Dispatcher）
**位置：** `app/api/admin/batch-generation/process/route.ts`

**功能：**
- ✅ 按行业拆分任务（每个行业独立处理）
- ✅ 批量处理（10～50条/批，避免超时）
- ✅ 任务状态管理（pending → processing → completed）
- ✅ 链式调用（避免 Vercel 超时限制）

**改进建议：**
- 可以添加任务优先级（热门行业优先）
- 可以添加失败重试机制（最多 3 次）

### ② 模型选择层（Model Selector）
**位置：** `app/api/admin/batch-generation/process/generate-scenes.ts`

**功能：**
- ✅ 三级模型自动选择
- ✅ 行业难度判断（`detect-cold-industry.ts`）
- ✅ 极端专业领域检测（`needsProModel()`）

**已实现规则：**
- 冷门行业 → 直接使用 3-flash
- 极端专业领域 → 直接使用 3-pro
- 质量检查失败 → 自动升级模型

### ③ 内容生成层
**位置：** `app/api/admin/batch-generation/process/generate-scenes.ts`

**功能：**
- ✅ 根据模型选择调用对应的 API
- ✅ 支持联网搜索（3-flash 和 3-pro）
- ✅ JSON 解析和修复

### ④ 缺陷检测层（Quality Checker）
**位置：** `app/api/admin/batch-generation/process/check-generation-quality.ts`

**功能：**
- ✅ 数量检查（< 50% 期望数量）
- ✅ 重复率检查（> 30% → 3-flash, > 80% → 3-pro）
- ✅ 空内容检查
- ✅ 错误响应检查
- ✅ 内容长度检查

### ⑤ 自适应 Fallback
**位置：** `app/api/admin/batch-generation/process/generate-scenes.ts`

**功能：**
- ✅ 三级自动升级（2.5-flash → 3-flash → 3-pro）
- ✅ 基于质量评分自动决定
- ✅ 失败时自动切换模型

### ⑥ 成本监控层（Billing Monitor）
**位置：** 待实现

**功能：**
- ❌ Token 用量统计（需要从 API 响应中提取）
- ❌ 模型成本计算（基于 token 和模型价格）
- ❌ 任务成本汇总
- ✅ 模型使用统计（可以通过日志分析）

**实现建议：**
- 在 `createChatCompletion` 中记录 token 用量
- 在 `batch_generation_tasks` 表中添加成本字段
- 创建成本统计 API

### ⑦ 内容合成层（Aggregator）
**位置：** `app/api/admin/batch-generation/process/save-scene.ts`

**功能：**
- ✅ 过滤无效内容（长度 < 50 字符）
- ✅ 去重（基于 slug，数据库唯一约束）
- ✅ 行业 → 场景词映射（保存到 `use_cases` 表）

**改进建议：**
- 可以添加内容相似度检查（避免重复内容）
- 可以添加关键词聚类（未来功能）

### ⑧ 输出层（Output Layer）
**位置：** `app/api/admin/batch-generation/process/save-scene.ts`

**功能：**
- ✅ 保存到数据库（`use_cases` 表）
- ✅ 包含行业分类、场景词内容、质量评分
- ✅ 生成模型信息（可以通过日志追踪）

**改进建议：**
- 可以在 `use_cases` 表中添加 `generation_model` 字段
- 可以添加导出功能（CSV / JSON）

## 📈 性能优化建议

### 1. 批量处理优化
- ✅ 已实现：每批 50 条，避免超时
- ✅ 已实现：批次之间延迟 1 秒，避免 API 限流

### 2. 成本优化
- ✅ 已实现：90% 使用低成本模型（2.5-flash）
- ✅ 已实现：仅 2% 使用高成本模型（3-pro）
- ⚠️ 待实现：成本监控和预警

### 3. 质量保证
- ✅ 已实现：三级质量检查
- ✅ 已实现：自动 Fallback 机制
- ✅ 已实现：内容过滤和去重

## 🔧 待实现功能

### 高优先级
1. **成本监控层**
   - Token 用量统计
   - 模型成本计算
   - 任务成本汇总

2. **模型使用统计**
   - 在 `batch_generation_tasks` 表中记录模型使用情况
   - 创建成本分析 API

### 中优先级
3. **内容相似度检查**
   - 避免重复内容（即使 slug 不同）
   - 基于内容相似度去重

4. **失败重试机制**
   - 任务级别的重试（最多 3 次）
   - 行业级别的重试（失败行业单独重试）

### 低优先级
5. **关键词聚类**
   - 基于内容相似度聚类
   - 行业 → 主题 → 场景词 三层结构

6. **导出功能**
   - CSV 导出
   - JSON 导出
   - 按行业/模型筛选导出

## 📊 数据流示例

```
用户选择：30 个行业 × 100 条/行业 = 3,000 条场景词
    ↓
调度层：拆分为 30 个行业任务
    ↓
模型选择层：
  - 25 个普通行业 → 2.5-flash（90%）
  - 4 个冷门行业 → 3-flash（8%）
  - 1 个极端专业 → 3-pro（2%）
    ↓
内容生成层：生成 3,000 条场景词
    ↓
质量检查：过滤掉 50 条无效内容
    ↓
保存到数据库：2,950 条有效场景词
    ↓
成本统计：
  - 2.5-flash: 2,500 条 × ￥0.001 = ￥2.50
  - 3-flash: 400 条 × ￥0.002 = ￥0.80
  - 3-pro: 50 条 × ￥0.010 = ￥0.50
  - 总成本：￥3.80
```

## 🎯 总结

**已实现的核心功能：**
- ✅ 调度层（任务拆分和状态管理）
- ✅ 模型选择层（三级模型自动选择）
- ✅ 内容生成层（根据模型调用 API）
- ✅ 缺陷检测层（质量检查）
- ✅ 自适应 Fallback（智能切换）
- ✅ 内容合成层（过滤和去重）
- ✅ 输出层（保存到数据库）

**待实现的功能：**
- ⚠️ 成本监控层（Token 统计和成本计算）
- ⚠️ 模型使用统计（记录到数据库）
- ⚠️ 内容相似度检查（避免重复）

**系统优势：**
- 🎯 成本优化：90% 使用低成本模型
- 🎯 质量保证：三级质量检查和自动 Fallback
- 🎯 智能判断：自动识别冷门行业和极端专业领域
- 🎯 自动恢复：无需人工干预，系统自动处理

