(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4453,970],{7293:function(e,o,r){Promise.resolve().then(r.bind(r,6656))},6656:function(e,o,r){"use strict";r.r(o),r.d(o,{default:function(){return u}});var t=r(7437),n=r(970),s=r(1212),a=r(3426),i=r(9376),l=r(2265),c=r(6242);function u(){let e=(0,i.useRouter)(),o=(0,i.useSearchParams)(),[r,u]=(0,l.useState)(null),[d,g]=(0,l.useState)(!0);return((0,l.useEffect)(()=>{(async()=>{let r=o.get("code"),t=o.get("error"),i=o.get("error_description");if(t){console.error("OAuth callback error:",t,i),e.push("/login?error=".concat(encodeURIComponent(i||t)));return}if(!r){console.error("No code parameter in callback"),e.push("/login?error=no_code");return}try{var l,c,d,f,m,h,v,p,S,y,b,k,_,w,I,C,x,D,E,O,j,P,A,W,N,L,U,R,T,z;let o=(0,n.createClient)();console.log("Callback received:",{code:r?r.substring(0,20)+"...":"none",codeLength:(null==r?void 0:r.length)||0});let t=Object.keys(localStorage);console.log("All localStorage keys:",t);let i=t.filter(e=>e.includes("supabase")||e.startsWith("sb-"));console.log("Supabase-related localStorage keys:",i);let u=Object.keys(sessionStorage);console.log("All sessionStorage keys:",u);let g=!1,V=null,F=t.map(e=>({key:e,normalized:e.toLowerCase()})).find(e=>e.normalized.includes("code_verifier")||e.normalized.includes("code-verifier")||e.normalized.includes("oauth-code-verifier"));if(F)g=!0,V={type:"key",key:F.key};else for(let e of i){let o=localStorage.getItem(e);if(o){if(o.includes("code_verifier")||o.includes("codeVerifier")||o.includes("oauthCodeVerifier")||o.includes("pkce")){g=!0,V={type:"value",key:e};break}try{let r=JSON.parse(o);if(r&&(r.code_verifier||r.codeVerifier||r.oauthCodeVerifier||(null==r?void 0:null===(b=r.session)||void 0===b?void 0:b.codeVerifier)||(null==r?void 0:r.pkce)||(null==r?void 0:null===(k=r.authSession)||void 0===k?void 0:k.codeVerifier))){g=!0,V={type:"parsed",key:e};break}}catch(o){console.warn("Failed to parse storage value for key",e,o)}}}if(g&&V?console.log("Detected code_verifier information in storage:",V):(console.warn("No code_verifier detected in localStorage yet. Supabase may still complete the exchange automatically."),console.warn("If the exchange fails, possible causes include:"),console.warn("1. Browser cleared localStorage"),console.warn("2. Using incognito/private mode"),console.warn("3. Redirect URL mismatch"),console.warn("4. Cross-origin redirect issue")),!g){for(let e of u){let o=e.toLowerCase();if(o.includes("code_verifier")||o.includes("code-verifier")||o.includes("oauth-code-verifier")||o.includes("pkce")){let o=sessionStorage.getItem(e);if(o)try{localStorage.setItem(e,o),console.log("Copied code_verifier from sessionStorage to localStorage",{key:e}),g=!0,V={type:"session-key",key:e};break}catch(o){console.error("Failed to copy code_verifier from sessionStorage to localStorage",{key:e,error:o})}}else{let o=sessionStorage.getItem(e);if(!o)continue;if(o.includes("code_verifier")||o.includes("codeVerifier")||o.includes("oauthCodeVerifier")||o.includes("pkce"))try{localStorage.setItem(e,o),console.log("Copied code_verifier value from sessionStorage to localStorage",{key:e}),g=!0,V={type:"session-value",key:e};break}catch(o){console.error("Failed to copy code_verifier value from sessionStorage to localStorage",{key:e,error:o})}}}g&&V&&console.log("Detected code_verifier from sessionStorage:",V)}console.log("Waiting for Supabase automatic session detection...");let J=null,G=null,B=0;for(;B<3&&!(null==J?void 0:J.session);){await new Promise(e=>setTimeout(e,300*(B+1)));let{data:{session:e}}=await o.auth.getSession();if(e&&e.user){console.log("✅ Session created by automatic detection (attempt ".concat(B+1,")")),J={session:e,user:e.user};break}++B<3&&console.log("⏳ Waiting for session... (attempt ".concat(B,"/").concat(3,")"))}if(!(null==J?void 0:J.session)){console.log("⚠️ Automatic detection failed after multiple attempts, trying manual exchange...",{codeVerifierDetected:g,supabaseKeys:i});let t={localStorageKeys:Object.keys(localStorage),sessionStorageKeys:Object.keys(sessionStorage),cookies:"undefined"!=typeof document?document.cookie:""};console.log("Storage state before manual exchange:",t),console.log("Storage lookups for PKCE:",["localStorage","sessionStorage"].map(e=>({source:e,matches:Object.keys("localStorage"===e?localStorage:sessionStorage).filter(e=>e.includes("code")||e.includes("verifier"))})));let n=null===(_=t.cookies.split("; ").find(e=>e.startsWith("sb-")))||void 0===_?void 0:_.split("=")[1];console.log("Cookie PKCE verifier presence:",!!n),console.log("\uD83D\uDD0D [OAuth Exchange] 开始交换 code..."),console.log("\uD83D\uDCCB [OAuth Exchange] Code 信息:",{codeLength:(null==r?void 0:r.length)||0,codePreview:r?r.substring(0,30)+"...":"none",hasCodeVerifier:g,codeVerifierSource:V});let a="https://hgzpzsiafycwlqrkzbis.supabase.co";console.log("\uD83D\uDCCB [OAuth Exchange] Supabase URL:",a),console.log("\uD83D\uDCCB [OAuth Exchange] 预期请求 URL:","".concat(a,"/auth/v1/token?grant_type=pkce"));let l=Date.now(),c=await o.auth.exchangeCodeForSession(r),u=Date.now()-l;if(J=c.data,G=c.error,console.log("\uD83D\uDCCA [OAuth Exchange] 响应信息:",{duration:"".concat(u,"ms"),hasSession:!!(null==J?void 0:J.session),hasError:!!G,errorStatus:null==G?void 0:G.status,errorMessage:null==G?void 0:G.message,errorName:null==G?void 0:G.name}),G){let o={message:G.message,status:G.status,name:G.name,errorDescription:(null===(I=G.message)||void 0===I?void 0:null===(w=I.match(/error_description[:\s]+([^,}]+)/i))||void 0===w?void 0:w[1])||null,errorCode:(null===(x=G.message)||void 0===x?void 0:null===(C=x.match(/error[:\s]+([^,}]+)/i))||void 0===C?void 0:C[1])||null,fullError:G};console.error("❌ [OAuth Exchange] 交换失败 - 详细错误信息:"),console.error("   Status Code:",o.status),console.error("   Error Name:",o.name),console.error("   Error Message:",o.message),console.error("   Error Code:",o.errorCode||"N/A"),console.error("   Error Description:",o.errorDescription||"N/A"),console.error("   完整错误对象:",o.fullError),console.error("\n\uD83D\uDD0D [OAuth Exchange] 错误诊断建议:"),400===o.status?(null===(D=o.message)||void 0===D?void 0:D.includes("invalid_client"))?(console.error("   ⚠️  可能原因: Google Client ID/Secret 配置错误"),console.error("   ✅ 检查: Supabase Dashboard → Authentication → Providers → Google"),console.error("   ✅ 检查: Google Cloud Console → OAuth client credentials")):(null===(E=o.message)||void 0===E?void 0:E.includes("redirect_uri"))||(null===(O=o.message)||void 0===O?void 0:O.includes("redirect"))?(console.error("   ⚠️  可能原因: 重定向 URL 不匹配"),console.error("   ✅ 检查: Google Cloud Console → Authorized redirect URIs"),console.error("   ✅ 必须包含: https://<project-ref>.supabase.co/auth/v1/callback"),console.error("   ✅ 检查: Supabase → Authentication → URL Configuration")):(null===(j=o.message)||void 0===j?void 0:j.includes("invalid_grant"))||(null===(P=o.message)||void 0===P?void 0:P.includes("already redeemed"))?(console.error("   ⚠️  可能原因: Code 已过期或被重复使用"),console.error("   ✅ 检查: 是否多次执行 exchangeCodeForSession"),console.error("   ✅ 检查: middleware 是否导致重复回调")):(null===(A=o.message)||void 0===A?void 0:A.includes("Unable to exchange external code"))&&(console.error("   ⚠️  可能原因: Supabase 无法与 Google 交换 token"),console.error('   ✅ 检查: Supabase Dashboard → Logs Explorer → 搜索 "oauth" / "google"'),console.error("   ✅ 检查: Google Cloud Console → OAuth client 状态")):500===o.status&&(console.error("   ⚠️  可能原因: Supabase 服务器端错误"),console.error("   ✅ 检查: Supabase Dashboard → Logs Explorer"),console.error("   ✅ 检查: Network 标签中的完整响应（可能包含更详细的错误）")),console.error("\n\uD83D\uDCCB [OAuth Exchange] 存储状态:",t),console.error("\uD83D\uDCCB [OAuth Exchange] Supabase storage keys:",{pkceKeys:Object.keys(localStorage).filter(e=>e.includes("code")||e.includes("verifier"))}),await (0,s.H)(Error("PKCE token exchange failed: ".concat(G.message)),{code:r?r.substring(0,20)+"...":"none",codeLength:(null==r?void 0:r.length)||0,...o,hasCodeVerifier:g,supabaseKeys:i});let n="Login failed. Please try again.";n=400===G.status?(null===(W=G.message)||void 0===W?void 0:W.includes("code verifier"))||(null===(N=G.message)||void 0===N?void 0:N.includes("code_verifier"))||!g&&G.message?"Login failed: missing PKCE verifier. Please clear site data (cookies/storage) and try again.":(null===(L=G.message)||void 0===L?void 0:L.includes("Unable to exchange external code"))||(null===(U=G.message)||void 0===U?void 0:U.includes("exchange external code"))?"Login failed: The verification code has expired or doesn't match. This usually happens if you waited too long or tried to login multiple times. Please clear your browser storage and try again.":(null===(R=G.message)||void 0===R?void 0:R.includes("expired"))||(null===(T=G.message)||void 0===T?void 0:T.includes("invalid"))?"Login failed: the verification code is expired or invalid. Please sign in again.":"Login failed: code exchange failed. Please clear site data (cookies/storage) and try again.":G.message||"Login failed: unknown error.";let a=G.message||"Unknown exchange error";try{await fetch("/api/log-oauth-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:a.substring(0,200),error_description:o.errorDescription||null,error_code:o.errorCode||(null===(z=G.status)||void 0===z?void 0:z.toString())||null,origin:window.location.origin,pathname:"/auth/callback",user_agent:"undefined"!=typeof navigator?navigator.userAgent:null,timestamp:new Date().toISOString()})})}catch(e){console.error("[OAuth Error Logger] Failed to log:",e)}e.push("/login?error=".concat(encodeURIComponent(n)));return}}if(console.log("Exchange result:",{hasSession:!!(null==J?void 0:J.session),hasUser:!!(null==J?void 0:J.user),error:null==G?void 0:G.message,errorCode:null==G?void 0:G.status}),G){console.error("Exchange code error:",G),e.push("/login?error=".concat(encodeURIComponent(G.message)));return}if(!(null==J?void 0:J.session)){console.error("No session after code exchange"),e.push("/login?error=no_session");return}let{data:{user:M},error:K}=await o.auth.getUser();if(K||!M){console.error("Get user error:",K);let o=(0,a.r4)();(0,a.TW)(),e.replace(o||"/");return}let Z=(null===(l=M.user_metadata)||void 0===l?void 0:l.provider_id)||(null===(c=M.user_metadata)||void 0===c?void 0:c.sub)||(null===(d=M.app_metadata)||void 0===d?void 0:d.provider_id)||M.id,X=M.email||(null===(f=M.user_metadata)||void 0===f?void 0:f.email)||"",q=(null===(m=M.user_metadata)||void 0===m?void 0:m.full_name)||(null===(h=M.user_metadata)||void 0===h?void 0:h.name)||(null===(v=M.user_metadata)||void 0===v?void 0:v.display_name)||"",Y=(null===(p=M.user_metadata)||void 0===p?void 0:p.avatar_url)||(null===(S=M.user_metadata)||void 0===S?void 0:S.picture)||(null===(y=M.user_metadata)||void 0===y?void 0:y.avatar)||"",{data:Q,error:H}=await o.from("users").select("id").eq("google_id",Z).single();if(H&&"PGRST116"!==H.code&&console.error("Query user error:",H),Q){let{error:e}=await o.from("users").update({last_login_at:new Date().toISOString(),name:q||void 0,avatar_url:Y||void 0}).eq("id",Q.id);e?console.error("Error updating user:",e):console.log("User updated successfully:",X)}else{let{error:e}=await o.from("users").upsert({id:M.id,google_id:Z,email:X,name:q||null,avatar_url:Y||null,last_login_at:new Date().toISOString()},{onConflict:"google_id"});e?console.error("Error creating user via upsert:",e):console.log("User created/updated successfully via upsert:",X)}let $=(0,a.r4)();(0,a.TW)(),e.replace($||"/"),e.refresh()}catch(o){console.error("Callback error:",o),u(o instanceof Error?o.message:"unknown_error"),e.push("/login?error=".concat(encodeURIComponent(o instanceof Error?o.message:"callback_error")))}finally{g(!1)}})()},[e,o]),d)?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.default,{error:null,pathname:"/auth/callback"}),(0,t.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent"}),(0,t.jsx)("p",{className:"mt-4 text-gray-600",children:"Processing login..."})]})})]}):r?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.default,{error:r,pathname:"/auth/callback"}),(0,t.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center text-red-600",children:[(0,t.jsxs)("p",{children:["Login failed: ",r]}),(0,t.jsx)("button",{onClick:()=>e.push("/login"),className:"mt-4 rounded bg-blue-600 px-4 py-2 text-white",children:"Back to Login"})]})})]}):(0,t.jsx)(c.default,{error:null,pathname:"/auth/callback"})}},6242:function(e,o,r){"use strict";r.r(o),r.d(o,{default:function(){return n}});var t=r(2265);function n(e){let{error:o,pathname:r}=e;return(0,t.useEffect)(()=>{if(!o)return;let e=o.match(/^([^:]+):\s*(.+)$/),t=e?e[1]:o,n=e?e[2]:null,s=null;o.includes("invalid_client")?s="invalid_client":o.includes("redirect_uri_mismatch")?s="redirect_uri_mismatch":o.includes("invalid_grant")?s="invalid_grant":o.includes("server_error")?s="server_error":o.includes("Unable to exchange external code")&&(s="exchange_failed"),(async()=>{try{await fetch("/api/log-oauth-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:t,error_description:n||o,error_code:s,origin:window.location.origin,pathname:r||window.location.pathname,user_agent:"undefined"!=typeof navigator?navigator.userAgent:null,timestamp:new Date().toISOString()})})}catch(e){console.error("[OAuth Error Logger] Failed to log error:",e)}})()},[o,r]),null}},3426:function(e,o,r){"use strict";r.d(o,{Ko:function(){return s},TW:function(){return i},r4:function(){return a}});let t="s2ai_post_login_redirect";function n(e){if(!e)return null;let o=String(e).trim();return!o||!o.startsWith("/")||o.startsWith("//")||o.includes("://")||o.startsWith("/auth/callback")||o.startsWith("/login")?null:o}function s(e){let o=n(e);if(o){try{"undefined"!=typeof sessionStorage&&sessionStorage.setItem(t,o)}catch(e){}try{"undefined"!=typeof localStorage&&localStorage.setItem(t,o)}catch(e){}}}function a(){let e=null;try{"undefined"!=typeof sessionStorage&&(e=sessionStorage.getItem(t))}catch(e){}if(!e)try{"undefined"!=typeof localStorage&&(e=localStorage.getItem(t))}catch(e){}return n(e)}function i(){try{"undefined"!=typeof sessionStorage&&sessionStorage.removeItem(t)}catch(e){}try{"undefined"!=typeof localStorage&&localStorage.removeItem(t)}catch(e){}}},1212:function(e,o,r){"use strict";async function t(e,o){try{let r=e instanceof Error?{message:e.message,stack:e.stack,name:e.name}:"string"==typeof e?{message:e}:e;await fetch("/api/log-error",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:r,context:{...o,url:window.location.href,userAgent:"undefined"!=typeof navigator?navigator.userAgent:void 0},level:"error"})}).catch(e=>{console.error("Failed to send error log:",e)})}catch(e){console.error("Error logger failed:",e)}}r.d(o,{H:function(){return t}})},970:function(e,o,r){"use strict";let t,n;r.d(o,{createClient:function(){return i}});var s=r(3053);let a=new Map;function i(){let e="https://hgzpzsiafycwlqrkzbis.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q";if(!e||!o)throw Error("Missing Supabase environment variables");return n||(n=function(){let e=function(){try{return"localStorage"in window?window.localStorage:null}catch(e){return null}}(),o=function(){try{return"sessionStorage"in window?window.sessionStorage:null}catch(e){return null}}();return{async getItem(r){var t;r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] getItem start",{key:r});let n=null==e?void 0:e.getItem(r);if(null!=n)return a.set(r,n),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] getItem hit localStorage",{key:r}),n;let s=null==o?void 0:o.getItem(r);if(null!=s)return a.set(r,s),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] getItem hit sessionStorage",{key:r}),s;let i=function(e){if("undefined"==typeof document)return null;for(let o of document.cookie?document.cookie.split("; "):[]){let[r,...t]=o.split("=");if(r===e)return decodeURIComponent(t.join("="))}return null}(r);return null!==i?(a.set(r,i),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] getItem hit cookie",{key:r}),i):(r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] getItem miss",{key:r}),null!==(t=a.get(r))&&void 0!==t?t:null)},async setItem(r,t){let n=String(t);try{null==e||e.setItem(r,n),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] setItem localStorage success",{key:r})}catch(e){r.endsWith("-code-verifier")&&console.warn("[SupabaseStorage] setItem localStorage failed",{key:r,error:e})}try{null==o||o.setItem(r,n),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] setItem sessionStorage success",{key:r})}catch(e){r.endsWith("-code-verifier")&&console.warn("[SupabaseStorage] setItem sessionStorage failed",{key:r,error:e})}if(r.endsWith("-code-verifier"))try{(function(e,o,r){if("undefined"==typeof document)return;let t="https:"===window.location.protocol,n="".concat(e,"=").concat(encodeURIComponent(o),"; Path=/; SameSite=Lax; Max-Age=").concat(600).concat(t?"; Secure":"");document.cookie=n})(r,n,0),console.log("[SupabaseStorage] setItem cookie success",{key:r})}catch(e){console.warn("[SupabaseStorage] setItem cookie failed",{key:r,error:e})}a.set(r,n),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] setItem memory store",{key:r})},async removeItem(r){try{null==e||e.removeItem(r),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] removeItem localStorage",{key:r})}catch(e){r.endsWith("-code-verifier")&&console.warn("[SupabaseStorage] removeItem localStorage failed",{key:r,error:e})}try{null==o||o.removeItem(r),r.endsWith("-code-verifier")&&console.log("[SupabaseStorage] removeItem sessionStorage",{key:r})}catch(e){r.endsWith("-code-verifier")&&console.warn("[SupabaseStorage] removeItem sessionStorage failed",{key:r,error:e})}r.endsWith("-code-verifier")&&("undefined"!=typeof document&&(document.cookie="".concat(r,"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax")),console.log("[SupabaseStorage] removeItem cookie",{key:r})),a.delete(r)}}}()),t||(t=(0,s.eI)(e,o,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce",storage:n}})),t}},9376:function(e,o,r){"use strict";var t=r(5475);r.o(t,"useParams")&&r.d(o,{useParams:function(){return t.useParams}}),r.o(t,"usePathname")&&r.d(o,{usePathname:function(){return t.usePathname}}),r.o(t,"useRouter")&&r.d(o,{useRouter:function(){return t.useRouter}}),r.o(t,"useSearchParams")&&r.d(o,{useSearchParams:function(){return t.useSearchParams}})}},function(e){e.O(0,[4609,3053,2971,2117,1744],function(){return e(e.s=7293)}),_N_E=e.O()}]);