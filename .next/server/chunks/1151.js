"use strict";exports.id=1151,exports.ids=[1151],exports.modules={61151:(e,o,s)=>{async function n(e,o,n,r,i,l="US"){let{createChatCompletion:a}=await s.e(9606).then(s.bind(s,49606)),{isColdIndustry:c,needsProModel:$}=await s.e(3887).then(s.bind(s,13887)),{checkGenerationQuality:g}=await s.e(3659).then(s.bind(s,83659)),{selectModelForIndustryScene:h}=await s.e(5045).then(s.bind(s,65045)),u=`You are a marketing content expert specializing in high-converting video marketing scenarios optimized for both SEO and GEO (Generative Engine Optimization). Your goal is to generate actionable, conversion-focused marketing video use cases that solve real business pain points and drive customer engagement. All output must be in English.

CRITICAL: The AI video platform ONLY supports 10-second or 15-second videos. NEVER mention any duration longer than 15 seconds (such as 20 seconds, 30 seconds, 45 seconds, 60 seconds, 1 minute, 2 minutes, etc.). When describing video examples, ALWAYS use "10 seconds" or "15 seconds" only.

GEO Optimization Requirements (for AI search citation - ChatGPT/Gemini/Perplexity):
1. Answer-First Structure (GEO-1):
   - Start with a clear, citable definition: "In [industry], AI-generated videos are commonly used for [use case]."
   - Follow with a list of typical applications (noun phrases, not marketing copy)
   - End with a summary sentence explaining the purpose

2. List Format (GEO-2):
   - Use noun phrases, NOT marketing sentences
   - âœ… Good: "Product demo videos", "Onboarding explainer clips", "Social media short-form ads"
   - âŒ Bad: "Boost your brand visibility", "Increase engagement dramatically"
   - AI prefers encyclopedia-style expressions over marketing copy

3. How-to Steps (GEO-3):
   - Include clear, actionable steps
   - Format: "1. [action], 2. [action], 3. [action]"

4. FAQ Style (GEO-4):
   - Answer questions a non-expert would ask
   - Use simple, direct questions: "Is AI video suitable for [industry]?", "Do I need [equipment]?", "Which platform works best?"
   - Keep answers 2-4 sentences, no marketing jargon

5. Industry + Scene + Platform (GEO-5):
   - Must clearly identify at least 2 of: industry, use case scenario, platform

Focus on marketing scenarios that:
- Solve specific customer pain points
- Drive conversions and sales
- Create emotional connections
- Showcase product benefits in real-world contexts
- Are suitable for social media marketing (TikTok, Instagram, YouTube, Twitter/X)
- Generate repeatable, scalable content ideas`,d=await h(e,n,1),m=d.model,p=d.nextFallback||"gemini-3-flash",f="gemini-3-pro";console.log(`[${e}] GEO: ${l}, åœºæ™¯: ${n}, æ¨¡å‹é€‰æ‹©: ${m}, Fallback: ${p}, åŸå› : ${d.reason}`);let S=$(e),w=c(e),y=Math.min(o,30),O=Math.ceil(o/y);console.log(`[${e}] åˆ†æ‰¹ç”Ÿæˆç­–ç•¥: æ€»å…± ${o} æ¡ï¼Œåˆ† ${O} æ‰¹ï¼Œæ¯æ‰¹ ${y} æ¡`);let _=[],N=0,b=0,C=[],E=()=>i.from("batch_generation_tasks"),J=async()=>{let{data:e}=await E().select("should_stop, status, is_paused").eq("id",r).single();return{shouldStop:e?.should_stop===!0||e?.status==="cancelled",isPaused:e?.is_paused===!0}};for(let s=0;s<O;s++){let{shouldStop:c,isPaused:$}=await J();if(c){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢ç”Ÿæˆ`);break}if($){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä»»åŠ¡å·²æš‚åœï¼Œç­‰å¾…æ¢å¤...`);let n=0;for(;n<10;){await new Promise(e=>setTimeout(e,1e3));let t=await J();if(!t.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â–¶ï¸ ä»»åŠ¡å·²æ¢å¤ï¼Œç»§ç»­ç”Ÿæˆ`);break}if(t.shouldStop)return console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œåœæ­¢ç”Ÿæˆ`),{scenes:_.slice(0,o),savedCount:N,failedCount:b,errors:[...C,"ä»»åŠ¡å·²ç»ˆæ­¢"]};n++}let t=await J();if(t.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä»»åŠ¡ä»ç„¶æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}if(t.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œåœæ­¢ç”Ÿæˆ`);break}}let h=s===O-1?o-s*y:y;console.log(`
[${e}] ========== æ‰¹æ¬¡ ${s+1}/${O} ==========`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“ æ­¥éª¤ 1 - å¼€å§‹ç”Ÿæˆ ${h} æ¡åœºæ™¯è¯...`);let d=`Generate ${h} highly specific, conversion-focused marketing video scenarios for the following target market:

Target Market: ${e}
Use Case Type: ${n}

CRITICAL: Generate MARKETING SCENARIOS optimized for GEO (Generative Engine Optimization), not industry encyclopedia entries. Focus on:
- Real customer pain points that videos can solve
- Conversion-focused content ideas that drive sales/engagement
- Scalable marketing use cases that can be repeated 1000+ times
- Social media-ready scenarios (TikTok, Instagram, YouTube, Twitter/X)

GEO Structure Requirements (for AI search citation):
Each scenario must follow this structure:
1. Answer-First (50-80 chars): "In [industry], AI videos are used for [specific use case]."
2. List of Applications (noun phrases only):
   - Use noun phrases: "Product demo videos", "Onboarding clips", "Social media ads"
   - NOT marketing copy: "Boost visibility", "Increase engagement"
3. Context & Pain Point (100-150 chars): Who, what, when, why
4. Video Solution (100-150 chars): Specific video idea that solves the pain point
5. Example Prompt (50-80 chars): 10-15 seconds only

Requirements:
- ${h} marketing scenarios
- Each scenario = 300â€“500 characters (detailed marketing use case description)
- Must be specific marketing scenarios, NOT generic industry descriptions
- Each scenario must clearly identify: industry + use case scenario + platform (at least 2 of 3)
- Use encyclopedia-style language (AI-friendly), not marketing jargon
- IMPORTANT: When mentioning video duration, ALWAYS use "10 seconds" or "15 seconds" ONLY. NEVER mention "20 seconds", "30 seconds", "45 seconds", "60 seconds", "1 minute", "2 minutes", or any duration longer than 15 seconds.
- Format as a clean JSON array: 
[
  {"id": 1, "use_case": "In [industry], AI videos are used for [use case]. Typical applications: [noun phrase list]. [Context & pain point]. [Video solution]. Example: [10-15 second prompt]"},
  {"id": 2, "use_case": "..."},
  ...
  {"id": ${h}, "use_case": "..."}
]
Do not include explanations. Output only the JSON.`,I="",A=[],k=!1,v=!1;if(w||S)S?(k=!0,v=!0,console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: æç«¯ä¸“ä¸šé¢†åŸŸï¼Œç›´æ¥ä½¿ç”¨ gemini-3-proï¼ˆæœ€é«˜è´¨é‡ï¼‰`)):(k=!0,console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: å†·é—¨è¡Œä¸šï¼Œç›´æ¥ä½¿ç”¨ gemini-3-flashï¼ˆè”ç½‘æœç´¢ï¼‰`));else{let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ä½¿ç”¨ ${m} ç”Ÿæˆï¼ˆGEO: ${l}ï¼‰...`);let o=await a({model:m,stream:!1,messages:[{role:"system",content:u},{role:"user",content:d}]});if(console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: API å“åº”ç»“æ„:`,{hasChoices:!!o.choices,choicesLength:o.choices?.length||0,firstChoice:o.choices?.[0]?{hasMessage:!!o.choices[0].message,hasContent:!!o.choices[0].message?.content,contentLength:o.choices[0].message?.content?.length||0,finishReason:o.choices[0].finish_reason}:null}),!(I=o.choices?.[0]?.message?.content||""))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ API è¿”å›ç©ºå†…å®¹ï¼å®Œæ•´å“åº”:`,JSON.stringify(o,null,2)),Error("ç”Ÿæˆçš„å†…å®¹ä¸ºç©º - API è¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«è¿‡æ»¤æˆ–æ‹’ç»");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: æ”¶åˆ°å†…å®¹é•¿åº¦ ${I.length} å­—ç¬¦`),I.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: åŸå§‹å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:`,I.substring(0,500));let c=I.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: å¼€å§‹è§£æ JSONï¼ŒåŸå§‹å†…å®¹é•¿åº¦: ${c.length} å­—ç¬¦`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON å†…å®¹å‰1000å­—ç¬¦:`,c.substring(0,1e3));try{A=JSON.parse(c),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… ç›´æ¥è§£æ JSON æˆåŠŸï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ JSON ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...`,n),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: è§£æé”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n));let o=c.match(/\[[\s\S]*\]/);if(o)try{A=JSON.parse(o[0]),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… JSON ä¿®å¤æˆåŠŸï¼ˆæå–æ•°ç»„ï¼‰ï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ JSON ä¿®å¤å¤±è´¥`,n),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: ä¿®å¤é”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n)),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: å°è¯•è§£æçš„å†…å®¹:`,o[0].substring(0,500)),Error(`æ— æ³•è§£æ JSON: ${n instanceof Error?n.message:String(n)}`)}else throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼ŒåŸå§‹å†…å®¹:`,c.substring(0,1e3)),Error("æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼Œå¯èƒ½ API è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼")}if(!Array.isArray(A))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ JSON è§£æç»“æœä¸æ˜¯æ•°ç»„ï¼ç±»å‹: ${typeof A}, å€¼:`,A),Error("JSON è§£æç»“æœä¸æ˜¯æ•°ç»„");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON è§£ææˆåŠŸï¼ŒåŸå§‹åœºæ™¯è¯æ•°é‡: ${A.length}`),A.forEach((e,o)=>{e.id=s*y+o+1});let $=A.length;A.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: è§£æåçš„åœºæ™¯è¯ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰:`,A.slice(0,3).map(e=>({hasId:!!e.id,hasUseCase:!!e.use_case,useCaseLength:e.use_case?.length||0,useCasePreview:e.use_case?.substring(0,100)||"N/A"})));let p=A.filter(o=>{if(!o)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: å‘ç° null/undefined åœºæ™¯è¯`),!1;if(!o.use_case)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: å‘ç°ç¼ºå°‘ use_case çš„åœºæ™¯è¯:`,JSON.stringify(o)),!1;let n=o.use_case.trim().length;return!(n<=30)||(console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: å‘ç°å†…å®¹è¿‡çŸ­çš„åœºæ™¯è¯ï¼ˆ${n} å­—ç¬¦ï¼Œé˜ˆå€¼: 30ï¼‰:`,o.use_case.substring(0,150)),!1)}),f=$-p.length;if(f>0?console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ è¿‡æ»¤æ‰ ${f} æ¡æ— æ•ˆåœºæ™¯è¯ï¼ˆåŸå§‹: ${$} æ¡ï¼Œæœ‰æ•ˆ: ${p.length} æ¡ï¼Œè¿‡æ»¤é˜ˆå€¼: 30 å­—ç¬¦ï¼‰`):console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… æ‰€æœ‰ ${$} æ¡åœºæ™¯è¯éƒ½é€šè¿‡è¿‡æ»¤ï¼ˆé˜ˆå€¼: 30 å­—ç¬¦ï¼‰`),A=p,0===A.length)k=!0,console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ ä¸¥é‡é—®é¢˜ï¼šgemini-2.5-flash è¿”å›ç©ºæ•°ç»„ï¼`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: åŸå§‹å†…å®¹é•¿åº¦: ${I.length} å­—ç¬¦`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON è§£æå‰æ•°é‡: ${$} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: è¿‡æ»¤åæ•°é‡: ${p.length} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:`,I.substring(0,500)),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: å°†å¼ºåˆ¶åˆ‡æ¢åˆ° gemini-3-flashï¼ˆè”ç½‘æœç´¢ï¼‰ä»¥é¿å…æµªè´¹ç§¯åˆ†`);else{let o=g(A,h,I);if(o.needsProModel)v=!0,k=!0,console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: è´¨é‡æ£€æŸ¥æ˜¾ç¤ºéœ€è¦ gemini-3-proï¼ˆæœ€é«˜è´¨é‡æ¨¡å‹ï¼‰`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: å¤±è´¥åŸå› : ${o.reason}`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: é—®é¢˜åˆ—è¡¨:`,o.issues);else if(o.needsFallback)k=!0,console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦ fallback åˆ° gemini-3-flashï¼ˆè”ç½‘æœç´¢ï¼‰`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: å¤±è´¥åŸå› : ${o.reason}`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: é—®é¢˜åˆ—è¡¨:`,o.issues);else{console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-2.5-flash ç”ŸæˆæˆåŠŸï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`);let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{let{data:o}=await E().select("total_scenes_generated").eq("id",r).single(),n=o?.total_scenes_generated||0;await E().update({total_scenes_generated:n+A.length,updated_at:new Date().toISOString()}).eq("id",r),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š å·²æ›´æ–°ç”Ÿæˆæ•°é‡: ${n+A.length} æ¡ï¼Œå¼€å§‹ä¿å­˜...`)}catch(o){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: æ›´æ–°ç”Ÿæˆæ•°é‡å¤±è´¥ï¼ˆç»§ç»­ä¿å­˜ï¼‰:`,o)}console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ’¾ å¼€å§‹ä¿å­˜ ${A.length} æ¡åœºæ™¯è¯...`);let l=await t(A,e,n,r,i,s+1);N+=l.savedCount,b+=l.failedCount,C.push(...l.errors);let a=l.skippedCount>0?`ï¼Œè·³è¿‡ ${l.skippedCount} æ¡ï¼ˆè´¨é‡è¿‡ä½ï¼‰`:"";console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… ä¿å­˜å®Œæˆï¼æˆåŠŸ ${l.savedCount} æ¡ï¼Œå¤±è´¥ ${l.failedCount} æ¡${a}`);let c=l.savedCount+l.failedCount,$=c>0?l.failedCount/c:0;if($>.5){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*$).toFixed(1)}%)ï¼Œåœæ­¢ç”Ÿæˆé¿å…æµªè´¹ç§¯åˆ†`),C.push(`æ‰¹æ¬¡ ${s+1} ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*$).toFixed(1)}%)ï¼Œå·²åœæ­¢ç”Ÿæˆ`);break}_.push(...A),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š ç´¯è®¡ç»Ÿè®¡ - å·²ç”Ÿæˆ ${_.length} æ¡ï¼Œå·²ä¿å­˜ ${N} æ¡ï¼Œå¤±è´¥ ${b} æ¡`),s+1<O&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1} å®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆæ‰¹æ¬¡ ${s+2}/${O}...`)}}}catch(t){let o=t instanceof Error?t.message:String(t);console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-2.5-flash ç”Ÿæˆå¤±è´¥:`,t),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: é”™è¯¯è¯¦æƒ…:`,o);let n=function(e){let o=e.message.toLowerCase();return o.includes("è¶…æ—¶")||o.includes("timeout")?{shouldRetry:!0,shouldStop:!1,retryDelay:3e3,errorMessage:"API è°ƒç”¨è¶…æ—¶ï¼Œå°†é‡è¯•",errorCategory:"timeout"}:o.includes("econnreset")||o.includes("ç½‘ç»œ")||o.includes("connection")||o.includes("è¿æ¥")?{shouldRetry:!0,shouldStop:!1,retryDelay:2e3,errorMessage:"ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œå°†é‡è¯•",errorCategory:"network"}:o.includes("è¢«è¿‡æ»¤")||o.includes("content_filter")||o.includes("è¢«æ‹’ç»")||o.includes("refused")?{shouldRetry:!1,shouldStop:!1,retryDelay:0,errorMessage:"å†…å®¹è¢«è¿‡æ»¤ï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡",errorCategory:"content_filter"}:o.includes("429")||o.includes("rate limit")||o.includes("é¢‘ç‡è¿‡é«˜")?{shouldRetry:!0,shouldStop:!1,retryDelay:5e3,errorMessage:"API é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…åé‡è¯•",errorCategory:"rate_limit"}:o.includes("500")||o.includes("502")||o.includes("503")||o.includes("æœåŠ¡å™¨é”™è¯¯")?{shouldRetry:!0,shouldStop:!1,retryDelay:4e3,errorMessage:"æœåŠ¡å™¨é”™è¯¯ï¼Œå°†é‡è¯•",errorCategory:"server_error"}:{shouldRetry:!1,shouldStop:!1,retryDelay:0,errorMessage:e.message,errorCategory:"other"}}(t instanceof Error?t:Error(o));if(console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: é”™è¯¯åˆ†ç±»:`,{category:n.errorCategory,shouldRetry:n.shouldRetry,shouldStop:n.shouldStop,message:n.errorMessage}),n.shouldRetry&&("timeout"===n.errorCategory||"network"===n.errorCategory)&&console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: ${n.errorMessage}ï¼Œå°†åˆ‡æ¢åˆ°æ›´å¼ºå¤§çš„æ¨¡å‹`),"content_filter"===n.errorCategory){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: ${n.errorMessage}ï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`),C.push(`æ‰¹æ¬¡ ${s+1}: ${n.errorMessage}`);continue}k=!0,A=[],console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ”„ å°†å¼ºåˆ¶åˆ‡æ¢åˆ° gemini-3-flashï¼ˆè”ç½‘æœç´¢ï¼‰`)}}if(v){let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ä½¿ç”¨ ${f}ï¼ˆç»ˆææ¨¡å‹ï¼‰...`);let o=await a({model:f,stream:!1,messages:[{role:"system",content:u},{role:"user",content:d}],tools:[{type:"google_search_retrieval"}]});if(console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro API å“åº”ç»“æ„:`,{hasChoices:!!o.choices,choicesLength:o.choices?.length||0,firstChoice:o.choices?.[0]?{hasMessage:!!o.choices[0].message,hasContent:!!o.choices[0].message?.content,contentLength:o.choices[0].message?.content?.length||0,finishReason:o.choices[0].finish_reason}:null}),!(I=o.choices?.[0]?.message?.content||""))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro API è¿”å›ç©ºå†…å®¹ï¼å®Œæ•´å“åº”:`,JSON.stringify(o,null,2)),Error("gemini-3-pro ç”Ÿæˆçš„å†…å®¹ä¸ºç©º - API è¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«è¿‡æ»¤æˆ–æ‹’ç»");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro æ”¶åˆ°å†…å®¹é•¿åº¦ ${I.length} å­—ç¬¦`),I.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro åŸå§‹å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:`,I.substring(0,500));let l=I.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å¼€å§‹è§£æ JSONï¼ŒåŸå§‹å†…å®¹é•¿åº¦: ${l.length} å­—ç¬¦`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro JSON å†…å®¹å‰1000å­—ç¬¦:`,l.substring(0,1e3));try{A=JSON.parse(l),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-pro ç›´æ¥è§£æ JSON æˆåŠŸï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ gemini-3-pro JSON ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...`,n),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro è§£æé”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n));let o=l.match(/\[[\s\S]*\]/);if(o)try{A=JSON.parse(o[0]),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-pro JSON ä¿®å¤æˆåŠŸï¼ˆæå–æ•°ç»„ï¼‰ï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro JSON ä¿®å¤å¤±è´¥`,n),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro ä¿®å¤é”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n)),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å°è¯•è§£æçš„å†…å®¹:`,o[0].substring(0,500)),Error(`æ— æ³•è§£æ JSON: ${n instanceof Error?n.message:String(n)}`)}else throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼ŒåŸå§‹å†…å®¹:`,l.substring(0,1e3)),Error("æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼Œå¯èƒ½ API è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼")}if(!Array.isArray(A))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro JSON è§£æç»“æœä¸æ˜¯æ•°ç»„ï¼ç±»å‹: ${typeof A}, å€¼:`,A),Error("gemini-3-pro JSON è§£æç»“æœä¸æ˜¯æ•°ç»„");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro JSON è§£ææˆåŠŸï¼ŒåŸå§‹åœºæ™¯è¯æ•°é‡: ${A.length}`),A.forEach((e,o)=>{e.id=s*y+o+1});let c=A.length;A.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro è§£æåçš„åœºæ™¯è¯ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰:`,A.slice(0,3).map(e=>({hasId:!!e.id,hasUseCase:!!e.use_case,useCaseLength:e.use_case?.length||0,useCasePreview:e.use_case?.substring(0,100)||"N/A"})));let $=A.filter(o=>{if(!o)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å‘ç° null/undefined åœºæ™¯è¯`),!1;if(!o.use_case)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å‘ç°ç¼ºå°‘ use_case çš„åœºæ™¯è¯:`,JSON.stringify(o)),!1;let n=o.use_case.trim().length;return!(n<=30)||(console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å‘ç°å†…å®¹è¿‡çŸ­çš„åœºæ™¯è¯ï¼ˆ${n} å­—ç¬¦ï¼Œé˜ˆå€¼: 30ï¼‰:`,o.use_case.substring(0,150)),!1)}),g=c-$.length;if(g>0?console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ gemini-3-pro è¿‡æ»¤æ‰ ${g} æ¡æ— æ•ˆåœºæ™¯è¯ï¼ˆåŸå§‹: ${c} æ¡ï¼Œæœ‰æ•ˆ: ${$.length} æ¡ï¼Œè¿‡æ»¤é˜ˆå€¼: 30 å­—ç¬¦ï¼‰`):console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-pro æ‰€æœ‰ ${c} æ¡åœºæ™¯è¯éƒ½é€šè¿‡è¿‡æ»¤ï¼ˆé˜ˆå€¼: 30 å­—ç¬¦ï¼‰`),A=$,0===A.length)throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ æç«¯æƒ…å†µï¼šgemini-3-pro ä¹Ÿè¿”å›ç©ºæ•°ç»„ï¼`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: åŸå§‹å†…å®¹é•¿åº¦: ${I.length} å­—ç¬¦`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON è§£æå‰æ•°é‡: ${c} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: è¿‡æ»¤åæ•°é‡: ${$.length} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆåœºæ™¯è¯`),Error("æ‰€æœ‰æ¨¡å‹ï¼ˆ2.5-flashã€3-flashã€3-proï¼‰éƒ½è¿”å›ç©ºæ•°ç»„ï¼Œæ— æ³•ç”Ÿæˆåœºæ™¯è¯");let h=await J();if(h.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(h.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{let{data:o}=await E().select("total_scenes_generated").eq("id",r).single(),n=o?.total_scenes_generated||0;await E().update({total_scenes_generated:n+A.length,updated_at:new Date().toISOString()}).eq("id",r),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š å·²æ›´æ–°ç”Ÿæˆæ•°é‡: ${n+A.length} æ¡ï¼Œå¼€å§‹ä¿å­˜...`)}catch(o){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: æ›´æ–°ç”Ÿæˆæ•°é‡å¤±è´¥ï¼ˆç»§ç»­ä¿å­˜ï¼‰:`,o)}console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ’¾ å¼€å§‹ä¿å­˜ ${A.length} æ¡åœºæ™¯è¯...`);let m=await t(A,e,n,r,i,s+1);N+=m.savedCount,b+=m.failedCount,C.push(...m.errors),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… ä¿å­˜å®Œæˆï¼æˆåŠŸ ${m.savedCount} æ¡ï¼Œå¤±è´¥ ${m.failedCount} æ¡`);let p=m.savedCount+m.failedCount,S=p>0?m.failedCount/p:0;if(S>.5){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ gemini-3-pro ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*S).toFixed(1)}%)ï¼Œåœæ­¢ç”Ÿæˆé¿å…æµªè´¹ç§¯åˆ†`),C.push(`æ‰¹æ¬¡ ${s+1} (gemini-3-pro) ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*S).toFixed(1)}%)ï¼Œå·²åœæ­¢ç”Ÿæˆ`);break}_.push(...A),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š ç´¯è®¡ç»Ÿè®¡ - å·²ç”Ÿæˆ ${_.length} æ¡ï¼Œå·²ä¿å­˜ ${N} æ¡ï¼Œå¤±è´¥ ${b} æ¡`),s+1<O&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1} å®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆæ‰¹æ¬¡ ${s+2}/${O}...`)}catch(n){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro ä¹Ÿå¤±è´¥:`,n);let o=n instanceof Error?n.message:String(n);C.push(`æ‰¹æ¬¡ ${s+1} (gemini-3-pro) ç”Ÿæˆå¤±è´¥: ${o}`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ‰¹æ¬¡`)}}if(k&&!v||0===A.length&&!v){let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ”„ å¼ºåˆ¶åˆ‡æ¢åˆ° ${p}ï¼ˆFallbackï¼‰...`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: åˆ‡æ¢åŸå› : ${0===A.length?"ç©ºæ•°ç»„":"è´¨é‡æ£€æŸ¥å¤±è´¥æˆ–ç”Ÿæˆå¤±è´¥"}`);let o=await a({model:p,stream:!1,messages:[{role:"system",content:u},{role:"user",content:d}],tools:[{type:"google_search_retrieval"}]});if(console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash API å“åº”ç»“æ„:`,{hasChoices:!!o.choices,choicesLength:o.choices?.length||0,firstChoice:o.choices?.[0]?{hasMessage:!!o.choices[0].message,hasContent:!!o.choices[0].message?.content,contentLength:o.choices[0].message?.content?.length||0,finishReason:o.choices[0].finish_reason}:null}),!(I=o.choices?.[0]?.message?.content||""))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-flash API è¿”å›ç©ºå†…å®¹ï¼å®Œæ•´å“åº”:`,JSON.stringify(o,null,2)),Error("gemini-3-flash ç”Ÿæˆçš„å†…å®¹ä¸ºç©º - API è¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«è¿‡æ»¤æˆ–æ‹’ç»");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash æ”¶åˆ°å†…å®¹é•¿åº¦ ${I.length} å­—ç¬¦`),I.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash åŸå§‹å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:`,I.substring(0,500));let l=I.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash å¼€å§‹è§£æ JSONï¼ŒåŸå§‹å†…å®¹é•¿åº¦: ${l.length} å­—ç¬¦`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash JSON å†…å®¹å‰1000å­—ç¬¦:`,l.substring(0,1e3));try{A=JSON.parse(l),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-flash ç›´æ¥è§£æ JSON æˆåŠŸï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ gemini-3-flash JSON ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...`,n),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash è§£æé”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n));let o=l.match(/\[[\s\S]*\]/);if(o)try{A=JSON.parse(o[0]),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-flash JSON ä¿®å¤æˆåŠŸï¼ˆæå–æ•°ç»„ï¼‰ï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-flash JSON ä¿®å¤å¤±è´¥`,n),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash ä¿®å¤é”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n)),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash å°è¯•è§£æçš„å†…å®¹:`,o[0].substring(0,500)),Error(`æ— æ³•è§£æ JSON: ${n instanceof Error?n.message:String(n)}`)}else throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-flash æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼ŒåŸå§‹å†…å®¹:`,l.substring(0,1e3)),Error("æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼Œå¯èƒ½ API è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼")}if(!Array.isArray(A))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-flash JSON è§£æç»“æœä¸æ˜¯æ•°ç»„ï¼ç±»å‹: ${typeof A}, å€¼:`,A),Error("gemini-3-flash JSON è§£æç»“æœä¸æ˜¯æ•°ç»„");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash JSON è§£ææˆåŠŸï¼ŒåŸå§‹åœºæ™¯è¯æ•°é‡: ${A.length}`),A.forEach((e,o)=>{e.id=s*y+o+1});let c=A.length;A.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash è§£æåçš„åœºæ™¯è¯ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰:`,A.slice(0,3).map(e=>({hasId:!!e.id,hasUseCase:!!e.use_case,useCaseLength:e.use_case?.length||0,useCasePreview:e.use_case?.substring(0,100)||"N/A"})));let $=A.filter(o=>{if(!o)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash å‘ç° null/undefined åœºæ™¯è¯`),!1;if(!o.use_case)return console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash å‘ç°ç¼ºå°‘ use_case çš„åœºæ™¯è¯:`,JSON.stringify(o)),!1;let n=o.use_case.trim().length;return!(n<=30)||(console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-flash å‘ç°å†…å®¹è¿‡çŸ­çš„åœºæ™¯è¯ï¼ˆ${n} å­—ç¬¦ï¼Œé˜ˆå€¼: 30ï¼‰:`,o.use_case.substring(0,150)),!1)}),g=c-$.length;if(g>0?console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ gemini-3-flash è¿‡æ»¤æ‰ ${g} æ¡æ— æ•ˆåœºæ™¯è¯ï¼ˆåŸå§‹: ${c} æ¡ï¼Œæœ‰æ•ˆ: ${$.length} æ¡ï¼Œè¿‡æ»¤é˜ˆå€¼: 30 å­—ç¬¦ï¼‰`):console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-flash æ‰€æœ‰ ${c} æ¡åœºæ™¯è¯éƒ½é€šè¿‡è¿‡æ»¤ï¼ˆé˜ˆå€¼: 30 å­—ç¬¦ï¼‰`),A=$,0===A.length)console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ ä¸¥é‡é—®é¢˜ï¼šgemini-3-flash ä¹Ÿè¿”å›ç©ºæ•°ç»„ï¼`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: åŸå§‹å†…å®¹é•¿åº¦: ${I.length} å­—ç¬¦`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: JSON è§£æå‰æ•°é‡: ${c} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: è¿‡æ»¤åæ•°é‡: ${$.length} æ¡`),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: å°†åˆ‡æ¢åˆ° gemini-3-proï¼ˆæœ€é«˜è´¨é‡ï¼‰ä»¥é¿å…æµªè´¹ç§¯åˆ†`),v=!0,k=!0;else{let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{let{data:o}=await E().select("total_scenes_generated").eq("id",r).single(),n=o?.total_scenes_generated||0;await E().update({total_scenes_generated:n+A.length,updated_at:new Date().toISOString()}).eq("id",r),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š å·²æ›´æ–°ç”Ÿæˆæ•°é‡: ${n+A.length} æ¡ï¼Œå¼€å§‹ä¿å­˜...`)}catch(o){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: æ›´æ–°ç”Ÿæˆæ•°é‡å¤±è´¥ï¼ˆç»§ç»­ä¿å­˜ï¼‰:`,o)}console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ’¾ å¼€å§‹ä¿å­˜ ${A.length} æ¡åœºæ™¯è¯...`);let l=await t(A,e,n,r,i,s+1);N+=l.savedCount,b+=l.failedCount,C.push(...l.errors),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… ä¿å­˜å®Œæˆï¼æˆåŠŸ ${l.savedCount} æ¡ï¼Œå¤±è´¥ ${l.failedCount} æ¡`);let a=l.savedCount+l.failedCount,c=a>0?l.failedCount/a:0;if(c>.5){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ gemini-3-flash ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*c).toFixed(1)}%)ï¼Œåœæ­¢ç”Ÿæˆé¿å…æµªè´¹ç§¯åˆ†`),C.push(`æ‰¹æ¬¡ ${s+1} (gemini-3-flash) ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*c).toFixed(1)}%)ï¼Œå·²åœæ­¢ç”Ÿæˆ`);break}_.push(...A),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š ç´¯è®¡ç»Ÿè®¡ - å·²ç”Ÿæˆ ${_.length} æ¡ï¼Œå·²ä¿å­˜ ${N} æ¡ï¼Œå¤±è´¥ ${b} æ¡`),s+1<O&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1} å®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆæ‰¹æ¬¡ ${s+2}/${O}...`)}}catch(l){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-flash å¤±è´¥ï¼Œå¼ºåˆ¶åˆ‡æ¢åˆ° gemini-3-pro...`,l),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: é”™è¯¯è¯¦æƒ…:`,l instanceof Error?l.message:String(l));let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ è°ƒç”¨ API å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: åˆ‡æ¢åˆ° ${f}ï¼ˆç»ˆææ¨¡å‹ï¼‰...`);let o=await a({model:f,stream:!1,messages:[{role:"system",content:u},{role:"user",content:d}],tools:[{type:"google_search_retrieval"}]});if(console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro API å“åº”ç»“æ„:`,{hasChoices:!!o.choices,choicesLength:o.choices?.length||0,firstChoice:o.choices?.[0]?{hasMessage:!!o.choices[0].message,hasContent:!!o.choices[0].message?.content,contentLength:o.choices[0].message?.content?.length||0,finishReason:o.choices[0].finish_reason}:null}),!(I=o.choices?.[0]?.message?.content||""))throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro API è¿”å›ç©ºå†…å®¹ï¼å®Œæ•´å“åº”:`,JSON.stringify(o,null,2)),Error("gemini-3-pro ç”Ÿæˆçš„å†…å®¹ä¸ºç©º - API è¿”å›äº†ç©ºå†…å®¹ï¼Œå¯èƒ½è¢«è¿‡æ»¤æˆ–æ‹’ç»");console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro æ”¶åˆ°å†…å®¹é•¿åº¦ ${I.length} å­—ç¬¦`),I.length>0&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro åŸå§‹å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:`,I.substring(0,500));let l=I.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim();console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å¼€å§‹è§£æ JSONï¼ŒåŸå§‹å†…å®¹é•¿åº¦: ${l.length} å­—ç¬¦`),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro JSON å†…å®¹å‰1000å­—ç¬¦:`,l.substring(0,1e3));try{A=JSON.parse(l),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-pro ç›´æ¥è§£æ JSON æˆåŠŸï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ gemini-3-pro JSON ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...`,n),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro è§£æé”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n));let o=l.match(/\[[\s\S]*\]/);if(o)try{A=JSON.parse(o[0]),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… gemini-3-pro JSON ä¿®å¤æˆåŠŸï¼ˆæå–æ•°ç»„ï¼‰ï¼Œè·å¾— ${A.length} æ¡åœºæ™¯è¯`)}catch(n){throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro JSON ä¿®å¤å¤±è´¥`,n),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro ä¿®å¤é”™è¯¯è¯¦æƒ…:`,n instanceof Error?n.message:String(n)),console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro å°è¯•è§£æçš„å†…å®¹:`,o[0].substring(0,500)),Error(`æ— æ³•è§£æ JSON: ${n instanceof Error?n.message:String(n)}`)}else throw console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âŒ gemini-3-pro æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼ŒåŸå§‹å†…å®¹:`,l.substring(0,1e3)),Error("æ— æ³•æ‰¾åˆ° JSON æ•°ç»„ï¼Œå¯èƒ½ API è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼")}A.forEach((e,o)=>{e.id=s*y+o+1});let c=A.filter(e=>e&&e.use_case&&e.use_case.trim().length>30),$=A.length-c.length;if($>0&&console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: gemini-3-pro è¿‡æ»¤æ‰ ${$} æ¡æ— æ•ˆåœºæ™¯è¯`),(A=c).length>0){let o=await J();if(o.shouldStop){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â›” ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢`);break}if(o.isPaused){console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: â¸ï¸ ä¿å­˜å‰æ£€æµ‹åˆ°ä»»åŠ¡å·²æš‚åœï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡`);continue}try{let{data:o}=await E().select("total_scenes_generated").eq("id",r).single(),n=o?.total_scenes_generated||0;await E().update({total_scenes_generated:n+A.length,updated_at:new Date().toISOString()}).eq("id",r),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š å·²æ›´æ–°ç”Ÿæˆæ•°é‡: ${n+A.length} æ¡ï¼Œå¼€å§‹ä¿å­˜...`)}catch(o){console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: æ›´æ–°ç”Ÿæˆæ•°é‡å¤±è´¥ï¼ˆç»§ç»­ä¿å­˜ï¼‰:`,o)}console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ’¾ å¼€å§‹ä¿å­˜ ${A.length} æ¡åœºæ™¯è¯...`);let l=await t(A,e,n,r,i,s+1);N+=l.savedCount,b+=l.failedCount,C.push(...l.errors);let a=l.skippedCount>0?`ï¼Œè·³è¿‡ ${l.skippedCount} æ¡ï¼ˆè´¨é‡è¿‡ä½ï¼‰`:"";console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: âœ… ä¿å­˜å®Œæˆï¼æˆåŠŸ ${l.savedCount} æ¡ï¼Œå¤±è´¥ ${l.failedCount} æ¡${a}`);let c=l.savedCount+l.failedCount,$=c>0?l.failedCount/c:0;if($>.5){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸âš ï¸âš ï¸ gemini-3-pro ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*$).toFixed(1)}%)ï¼Œåœæ­¢ç”Ÿæˆé¿å…æµªè´¹ç§¯åˆ†`),C.push(`æ‰¹æ¬¡ ${s+1} (gemini-3-pro fallback) ä¿å­˜å¤±è´¥ç‡è¿‡é«˜ (${(100*$).toFixed(1)}%)ï¼Œå·²åœæ­¢ç”Ÿæˆ`);break}_.push(...A),console.log(`[${e}] æ‰¹æ¬¡ ${s+1}: ğŸ“Š ç´¯è®¡ç»Ÿè®¡ - å·²ç”Ÿæˆ ${_.length} æ¡ï¼Œå·²ä¿å­˜ ${N} æ¡ï¼Œå¤±è´¥ ${b} æ¡`),s+1<O&&console.log(`[${e}] æ‰¹æ¬¡ ${s+1} å®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆæ‰¹æ¬¡ ${s+2}/${O}...`)}}catch(n){console.error(`[${e}] æ‰¹æ¬¡ ${s+1}: æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥:`,n);let o=n instanceof Error?n.message:String(n);C.push(`æ‰¹æ¬¡ ${s+1} (æ‰€æœ‰æ¨¡å‹) ç”Ÿæˆå¤±è´¥: ${o}`),console.warn(`[${e}] æ‰¹æ¬¡ ${s+1}: âš ï¸ æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ï¼Œè·³è¿‡æ­¤æ‰¹æ¬¡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ‰¹æ¬¡`)}}}}return{scenes:_.slice(0,o),savedCount:N,failedCount:b,errors:C}}async function t(e,o,n,t,r,i){let{saveSceneToDatabase:l}=await s.e(6666).then(s.bind(s,46666)),a=()=>r.from("batch_generation_tasks"),c=0,$=0,g=0,h=[],u=async()=>{let{data:e}=await a().select("should_stop, status, is_paused").eq("id",t).single();return{shouldStop:e?.should_stop===!0||e?.status==="cancelled",isPaused:e?.is_paused===!0}};for(let s=0;s<e.length;s++){let d=e[s],{shouldStop:m,isPaused:p}=await u();if(m){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œç«‹å³åœæ­¢ä¿å­˜åœºæ™¯è¯`);break}if(p){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â¸ï¸ ä»»åŠ¡å·²æš‚åœï¼Œç­‰å¾…æ¢å¤...`);let e=0;for(;e<10;){await new Promise(e=>setTimeout(e,1e3));let s=await u();if(!s.isPaused){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â–¶ï¸ ä»»åŠ¡å·²æ¢å¤ï¼Œç»§ç»­ä¿å­˜`);break}if(s.shouldStop){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œåœæ­¢ä¿å­˜`);break}e++}let s=await u();if(s.isPaused){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â¸ï¸ ä»»åŠ¡ä»ç„¶æš‚åœï¼Œåœæ­¢ä¿å­˜`);break}if(s.shouldStop){console.log(`[${o}] æ‰¹æ¬¡ ${i}: â›” ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œåœæ­¢ä¿å­˜`);break}}let f=0,S=!1;for(;f<=5&&!S;)try{await l(o,d,n,r),c++,S=!0;try{let{data:e}=await a().select("total_scenes_saved").eq("id",t).single(),o=e?.total_scenes_saved||0;await a().update({total_scenes_saved:o+1,updated_at:new Date().toISOString()}).eq("id",t)}catch(e){console.warn(`[${o}] æ‰¹æ¬¡ ${i}: æ›´æ–°è¿›åº¦å¤±è´¥ï¼ˆç»§ç»­ä¿å­˜ï¼‰:`,e)}f>0&&console.log(`[${o}] æ‰¹æ¬¡ ${i}: åœºæ™¯è¯ ${s+1} é‡è¯•æˆåŠŸ (${f}/5)`)}catch(l){let e=l instanceof Error?l.message:String(l),n=l?.isQualityTooLow===!0,t=l?.isDuplicate===!0;if(n||t){g++,h.push(`åœºæ™¯è¯ ${s+1}: ${e}`),console.warn(`[${o}] æ‰¹æ¬¡ ${i}: åœºæ™¯è¯ ${s+1} ${t?"é‡å¤å†…å®¹":"è´¨é‡è¿‡ä½"}ï¼Œå·²è·³è¿‡ä¿å­˜`),S=!0;break}f++;let r=e.includes("ECONNRESET")||e.includes("connection")||e.includes("timeout")||e.includes("ETIMEDOUT");if(f>5){$++;let n=`åœºæ™¯è¯ ${s+1}: ${e}`;h.push(n),console.error(`[${o}] æ‰¹æ¬¡ ${i}: ä¿å­˜åœºæ™¯è¯ ${s+1} æœ€ç»ˆå¤±è´¥ (${f}/5):`,e),r&&(console.warn(`[${o}] æ‰¹æ¬¡ ${i}: æ£€æµ‹åˆ°è¿æ¥é”™è¯¯ï¼Œç­‰å¾… 2 ç§’åç»§ç»­...`),await new Promise(e=>setTimeout(e,2e3)))}else{let n=1e3*f;r&&(n=2e3*f),console.warn(`[${o}] æ‰¹æ¬¡ ${i}: ä¿å­˜åœºæ™¯è¯ ${s+1} å¤±è´¥ï¼Œ${n}ms åé‡è¯• (${f}/5):`,e),await new Promise(e=>setTimeout(e,n))}}if(s<e.length-1){let e=150+50*Math.floor(c/100);await new Promise(o=>setTimeout(o,e))}if((s+1)%10==0)try{let{data:n}=await a().select("total_scenes_saved").eq("id",t).single(),r=n?.total_scenes_saved||0,l=g>0?`ï¼Œè·³è¿‡ ${g} æ¡ï¼ˆè´¨é‡è¿‡ä½ï¼‰`:"",c=$>0?`ï¼Œå¤±è´¥ ${$} æ¡`:"";console.log(`[${o}] æ‰¹æ¬¡ ${i}: å·²ä¿å­˜ ${s+1}/${e.length} æ¡åœºæ™¯è¯ï¼Œç´¯è®¡ä¿å­˜ ${r} æ¡${l}${c}`)}catch(e){console.warn(`[${o}] æ‰¹æ¬¡ ${i}: è®°å½•æ—¥å¿—å¤±è´¥:`,e)}}return{savedCount:c,failedCount:$,skippedCount:g,errors:h}}s.d(o,{generateAndSaveScenes:()=>n})}};