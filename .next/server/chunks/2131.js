"use strict";exports.id=2131,exports.ids=[2131,6527],exports.modules={53573:(e,r,t)=>{async function s(e,r,t,s){try{let{data:o,error:a}=await e.rpc("deduct_credits_from_wallet",{user_uuid:r,credits_needed:t,model_type:s});if(a)return console.error("Error deducting credits:",a),{success:!1,error:a.message};if(!o||!o.success)return{success:!1,error:o?.error||"Failed to deduct credits"};return{success:!0,bonusUsed:o.bonus_used||0,permanentUsed:o.permanent_used||0,remainingCredits:o.remaining_credits||0}}catch(e){return console.error("Error in deductCreditsFromWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function o(e,r,t=0,s=0,o,a=!1){try{let{data:i,error:n}=await e.rpc("add_credits_to_wallet",{user_uuid:r,permanent_amount:t,bonus_amount:s,bonus_expires_at:o||null,is_starter:a});if(n)return console.error("Error adding credits:",n),{success:!1,error:n.message};if(!i||!i.success)return{success:!1,error:i?.error||"Failed to add credits"};return{success:!0}}catch(e){return console.error("Error in addCreditsToWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}t.d(r,{A8:()=>s,S_:()=>o})},66527:(e,r,t)=>{t.d(r,{AP:()=>d,Fw:()=>i,Tb:()=>o,dp:()=>a,refundCreditsByVideoTaskId:()=>n});var s=t(53573);function o(e){switch(e){case"sora-2":default:return 10;case"veo-flash":return 50;case"veo-pro":return 250}}async function a(e,r,t,a,i){try{let n=i||"sora-2",d=o(n),c=await (0,s.A8)(e,r,d,n);if(!c.success)return{success:!1,error:c.error||"Insufficient credits"};let u={user_id:r,video_task_id:t,credits:d,description:a||`Video generation (${n})`,status:"completed",model_type:n},{data:l,error:g}=await e.from("consumption_records").insert(u).select().single();if(g)return console.error("Failed to create consumption record after wallet deduction:",g),{success:!0};return{success:!0,consumptionId:l.id}}catch(e){return console.error("Error in deductCredits:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e,r,t){try{let{data:o,error:a}=await e.from("consumption_records").select("*").eq("id",t).single();if(a||!o)return{success:!1,error:"Consumption record not found"};if("refunded"===o.status)return{success:!1,error:"Credits already refunded"};let i=o.credits||0;if(i<=0)return{success:!1,error:"Invalid credits amount to refund"};let n=await (0,s.S_)(e,r,i,0,null,!1);if(!n.success)return console.error("Failed to refund credits to wallet:",n.error),{success:!1,error:n.error||"Failed to refund credits"};let{error:d}=await e.from("consumption_records").update({status:"refunded",refunded_at:new Date().toISOString()}).eq("id",t);return d&&console.error("Failed to update consumption record:",d),{success:!0}}catch(e){return console.error("Error in refundCredits:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function n(e,r,t){try{let{data:s,error:o}=await e.from("consumption_records").select("*").eq("user_id",r).eq("video_task_id",t).eq("status","completed").single();if(o||!s)return{success:!1,error:"Consumption record not found"};return await i(e,r,s.id)}catch(e){return console.error("Error in refundCreditsByVideoTaskId:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e,r){try{let{data:t,error:o}=await e.from("recharge_records").insert({user_id:r,amount:3,credits:30,payment_method:"system",status:"completed",metadata:{type:"welcome_bonus"}}).select().single();if(o||!t)return console.error("Failed to create welcome bonus recharge record:",o),{success:!1,error:"Failed to create welcome bonus recharge record"};let a=await (0,s.S_)(e,r,30,0,null,!1);if(!a.success)return console.error("Failed to add welcome bonus to wallet:",a.error),{success:!1,error:a.error||"Failed to add welcome bonus to wallet"};return console.log(`[addWelcomeBonus] Successfully added 30 credits to wallet for user ${r}`),{success:!0,rechargeRecordId:t.id}}catch(e){return console.error("Error in addWelcomeBonus:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}},12131:(e,r,t)=>{t.d(r,{getOrCreateUser:()=>o});var s=t(66527);async function o(e,r){let t=String(r.user_metadata?.provider_id||r.user_metadata?.sub||r.app_metadata?.provider_id||r.id||r.id);console.log("[getOrCreateUser] Attempting to get/create user:",{googleId:t,userId:r.id,email:r.email,userMetadata:r.user_metadata});let{data:o,error:a}=await e.from("users").select("id, credits").eq("google_id",t).single();if(a&&"PGRST116"!==a.code){console.log("[getOrCreateUser] Query with credits failed, trying without credits field:",a.message);let{data:r,error:s}=await e.from("users").select("id").eq("google_id",t).single();if(r&&!s)return console.log("[getOrCreateUser] User found without credits field, using default 0"),{id:r.id,credits:0}}if(o&&!a)return console.log("[getOrCreateUser] User found:",o.id,"credits:",o.credits),{id:o.id,credits:o.credits??0};if(a?.code==="PGRST116"||!o){let o=r.email||r.user_metadata?.email||"",a=r.user_metadata?.full_name||r.user_metadata?.name||r.user_metadata?.display_name||null,i=r.user_metadata?.avatar_url||r.user_metadata?.picture||r.user_metadata?.avatar||null,n=o.trim();if(!n||""===n){let e=String(t).replace(/[^a-zA-Z0-9]/g,"_");n=`user_${e}@temp.local`}if(console.log("[getOrCreateUser] Creating new user:",{googleId:t,email:n,name:a,hasEmail:!!o}),o&&""!==o.trim()){let{data:r,error:s}=await e.from("users").select("id, google_id, credits").eq("email",o.trim()).single();if(r&&!s){if(r.google_id===t)return console.log("[getOrCreateUser] Found existing user by email:",r.id),{id:r.id,credits:r.credits};{console.log("[getOrCreateUser] Email exists with different google_id, updating...");let{error:s}=await e.from("users").update({google_id:t,last_login_at:new Date().toISOString()}).eq("id",r.id);if(!s)return{id:r.id,credits:r.credits}}}}let{data:d,error:c}=await e.from("users").insert({google_id:t,email:n,name:a,avatar_url:i,last_login_at:new Date().toISOString(),credits:0}).select("id, credits").single();if(c){if(console.error("[getOrCreateUser] Failed to create user:",{error:c,code:c.code,message:c.message,details:c.details,hint:c.hint,googleId:t,email:n}),"23505"===c.code){console.log("[getOrCreateUser] Unique constraint violation, retrying query...");let{data:r,error:s}=await e.from("users").select("id, credits").eq("google_id",t).single();if(r&&!s)return console.log("[getOrCreateUser] Found existing user after conflict:",r.id),r;if(n&&n.includes("@")){console.log("[getOrCreateUser] Trying to find user by email...");let{data:r,error:s}=await e.from("users").select("id, credits").eq("email",n).single();if(r&&!s){console.log("[getOrCreateUser] Found user by email, updating google_id...");let{error:s}=await e.from("users").update({google_id:t,last_login_at:new Date().toISOString()}).eq("id",r.id);if(!s)return r}}}return null}if(!d)return console.error("[getOrCreateUser] User creation returned no data"),null;console.log("[getOrCreateUser] User created successfully:",d.id);let u=await (0,s.AP)(e,d.id);return u.success?(console.log("[getOrCreateUser] Welcome bonus added successfully:",u.rechargeRecordId),d.credits=(d.credits||0)+30):console.error("[getOrCreateUser] Failed to add welcome bonus:",u.error),d}return console.error("[getOrCreateUser] Failed to get user:",{error:a,code:a?.code,message:a?.message}),null}}};