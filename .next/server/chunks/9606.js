"use strict";exports.id=9606,exports.ids=[9606],exports.modules={49606:(e,r,t)=>{function s(){let e=process.env.GRSAI_API_KEY;if(!e)throw Error("GRSAI_API_KEY 环境变量未配置。请在 .env.local 文件中设置 GRSAI_API_KEY。");return e}function a(){return process.env.GRSAI_HOST||"https://grsai.dakka.com.cn"}function o(){return"https://api.grsai.com"}async function i(e,r=0){let t;let o=1e3*(r+1),l=s(),c=a();0===r?console.log("[Grsai API] Creating video task:",{host:c,model:e.model,aspectRatio:e.aspectRatio,duration:e.duration,size:e.size,hasPrompt:!!e.prompt,promptLength:e.prompt?.length,hasUrl:!!e.url,webHook:e.webHook?"-1"===e.webHook?"polling":"webhook":"none",apiKeyPrefix:l.substring(0,10)+"..."}):console.log(`[Grsai API] Retrying video task (attempt ${r+1}/3):`,{host:c,retryCount:r,delay:o});let u=new AbortController,h=setTimeout(()=>u.abort(),6e4);try{t=await fetch(`${c}/v1/video/sora-video`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(e),signal:u.signal,keepalive:!0}),clearTimeout(h)}catch(t){if(clearTimeout(h),t instanceof Error&&("AbortError"===t.name||t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED")||t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo")||t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))&&r<3)return console.warn(`[Grsai API] Network error detected, retrying in ${o}ms...`,{error:t instanceof Error?t.message:String(t),retryCount:r+1,maxRetries:3}),await new Promise(e=>setTimeout(e,o)),i(e,r+1);if(t instanceof Error){if("AbortError"===t.name)throw Error(`Grsai API 请求超时（60秒），请检查网络连接或稍后重试`);if(t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED"))throw Error("Grsai API 连接失败，请检查网络连接或 API 服务是否可用");if(t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo"))throw Error("Grsai API 域名解析失败，请检查网络连接");if(t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))throw Error("Grsai API 连接被重置，可能是网络不稳定，请稍后重试")}throw Error(`Grsai API 请求失败: ${t instanceof Error?t.message:"未知错误"}`)}if(!t.ok){let e=await t.text(),r=`Grsai API 错误: ${t.status}`;console.error("[Grsai API] Request failed:",{status:t.status,statusText:t.statusText,url:`${c}/v1/video/sora-video`,errorText:e,headers:Object.fromEntries(t.headers.entries())});try{let t=JSON.parse(e);console.error("[Grsai API] Parsed error response:",t),t.msg?r+=` - ${t.msg}`:t.error?r+=` - ${t.error}`:t.message?r+=` - ${t.message}`:r+=` - ${JSON.stringify(t)}`}catch{r+=` - ${e}`}throw 401===t.status?r+=" (提示: 请检查 GRSAI_API_KEY 是否正确配置)":403===t.status?r+=" (提示: API Key 可能没有权限或已过期)":429===t.status?r+=" (提示: API 请求频率过高，请稍后重试)":(500===t.status||502===t.status||503===t.status)&&(r+=" (提示: API 服务暂时不可用，请稍后重试)"),Error(r)}if(console.log("[Grsai API] Request successful, processing response..."),"-1"===e.webHook)return await t.json();let m=t.headers.get("content-type");return m?.includes("text/event-stream")||m?.includes("application/x-ndjson")?await n(t):await t.json()}async function n(e){let r=e.body?.getReader();if(!r)throw Error("无法读取流式响应");let t=new TextDecoder,s=null;for(;;){let{done:e,value:a}=await r.read();if(e)break;for(let e of t.decode(a,{stream:!0}).split("\n").filter(e=>e.trim()))if(e.startsWith("data: "))try{let r=JSON.parse(e.slice(6));if(s=r,"succeeded"===r.status||"failed"===r.status)return r}catch{}}if(s)return s;throw Error("流式响应未返回有效数据")}async function l(e){let r=s(),t=a(),o=await fetch(`${t}/v1/draw/result`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({id:e})});if(!o.ok){let e=await o.text();throw Error(`Grsai API 错误: ${o.status} - ${e}`)}return await o.json()}async function c(e,r=0){let t;let o=1e3*(r+1),i=s(),n=a();0===r?console.log("[Grsai API] Creating Veo video task:",{host:n,model:e.model,aspectRatio:e.aspectRatio,hasPrompt:!!e.prompt,promptLength:e.prompt?.length,hasFirstFrame:!!e.firstFrameUrl,hasLastFrame:!!e.lastFrameUrl,referenceUrlsCount:e.urls?.length||0,webHook:e.webHook?"-1"===e.webHook?"polling":"webhook":"none",apiKeyPrefix:i.substring(0,10)+"..."}):console.log(`[Grsai API] Retrying Veo video task (attempt ${r+1}/3):`,{host:n,retryCount:r,delay:o});let l=new AbortController,h=setTimeout(()=>l.abort(),6e4);try{t=await fetch(`${n}/v1/video/veo`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(e),signal:l.signal,keepalive:!0}),clearTimeout(h)}catch(t){if(clearTimeout(h),t instanceof Error&&("AbortError"===t.name||t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED")||t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo")||t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))&&r<3)return console.warn(`[Grsai API] Network error detected, retrying in ${o}ms...`,{error:t instanceof Error?t.message:String(t),retryCount:r+1,maxRetries:3}),await new Promise(e=>setTimeout(e,o)),c(e,r+1);if(t instanceof Error){if("AbortError"===t.name)throw Error(`Grsai Veo API 请求超时（60秒），请检查网络连接或稍后重试`);if(t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED"))throw Error("Grsai Veo API 连接失败，请检查网络连接或 API 服务是否可用");if(t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo"))throw Error("Grsai Veo API 域名解析失败，请检查网络连接");if(t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))throw Error("Grsai Veo API 连接被重置，可能是网络不稳定，请稍后重试")}throw Error(`Grsai Veo API 请求失败: ${t instanceof Error?t.message:"未知错误"}`)}if(!t.ok){let e=await t.text(),r=`Grsai Veo API 错误: ${t.status}`;console.error("[Grsai API] Veo request failed:",{status:t.status,statusText:t.statusText,url:`${n}/v1/video/veo`,errorText:e,headers:Object.fromEntries(t.headers.entries())});try{let t=JSON.parse(e);console.error("[Grsai API] Parsed error response:",t),t.msg?r+=` - ${t.msg}`:t.error?r+=` - ${t.error}`:t.message?r+=` - ${t.message}`:r+=` - ${JSON.stringify(t)}`}catch{r+=` - ${e}`}throw 401===t.status?r+=" (提示: 请检查 GRSAI_API_KEY 是否正确配置)":403===t.status?r+=" (提示: API Key 可能没有权限或已过期)":429===t.status?r+=" (提示: API 请求频率过高，请稍后重试)":(500===t.status||502===t.status||503===t.status)&&(r+=" (提示: API 服务暂时不可用，请稍后重试)"),Error(r)}if(console.log("[Grsai API] Veo request successful, processing response..."),"-1"===e.webHook)return await t.json();let m=t.headers.get("content-type");return m?.includes("text/event-stream")||m?.includes("application/x-ndjson")?await u(t):await t.json()}async function u(e){let r=e.body?.getReader();if(!r)throw Error("无法读取流式响应");let t=new TextDecoder,s=null;for(;;){let{done:e,value:a}=await r.read();if(e)break;for(let e of t.decode(a,{stream:!0}).split("\n").filter(e=>e.trim()))if(e.startsWith("data: "))try{let r=JSON.parse(e.slice(6));if(s=r,"succeeded"===r.status||"failed"===r.status)return r}catch{}}if(s)return s;throw Error("流式响应未返回有效数据")}async function h(e,r=0){var a;let i;let n=Math.min(1e3*Math.pow(2,r),1e4),l=(a=e.model).includes("gemini-3-pro")?12e4:a.includes("gemini-3-flash")?9e4:6e4,c=s(),u=o();r>0&&console.log(`[Grsai Chat API] 重试请求 (尝试 ${r+1}/3):`,{host:u,model:e.model,retryCount:r,delay:n,timeout:l});let m=new AbortController,d=setTimeout(()=>m.abort(),l);try{let{rateLimiter:r}=await t.e(3669).then(t.bind(t,3669)),s=r.execute(()=>fetch(`${u}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(e),signal:m.signal,keepalive:!0})),a=new Promise((e,r)=>setTimeout(()=>r(Error(`请求超时（${l/1e3}秒）`)),l));i=await Promise.race([s,a]),clearTimeout(d)}catch(t){if(clearTimeout(d),t instanceof Error&&("AbortError"===t.name||t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED")||t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo")||t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))&&r<3)return console.warn(`[Grsai Chat API] 网络错误，${n}ms 后重试...`,{error:t instanceof Error?t.message:String(t),retryCount:r+1,maxRetries:3}),await new Promise(e=>setTimeout(e,n)),h(e,r+1);if(t instanceof Error){if("AbortError"===t.name)throw Error(`Grsai Chat API 请求超时（${l/1e3}秒），请检查网络连接或稍后重试`);if(t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED"))throw Error("Grsai Chat API 连接失败，请检查网络连接或 API 服务是否可用");if(t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo"))throw Error("Grsai Chat API 域名解析失败，请检查网络连接");if(t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))throw Error("Grsai Chat API 连接被重置，可能是网络不稳定，请稍后重试")}throw Error(`Grsai Chat API 请求失败: ${t instanceof Error?t.message:"未知错误"}`)}if(!i.ok){let t=await i.text();console.error("[Grsai Chat API] 请求失败:",{status:i.status,statusText:i.statusText,url:`${u}/v1/chat/completions`,errorText:t,model:e.model,messagesCount:e.messages.length,retryCount:r});let s=function(e,r,t,s){if(429===e)return{shouldRetry:t<3,retryDelay:Math.min(5e3*Math.pow(2,t),3e4),errorMessage:`API 请求频率过高（429），已重试 ${t+1} 次，请稍后重试`,message:"API 速率限制"};if(e>=500&&e<600)return{shouldRetry:t<3,retryDelay:500===e?Math.min(4e3*Math.pow(2,t),2e4):Math.min(2e3*Math.pow(2,t),1e4),errorMessage:`API 服务器错误（${e}），已重试 ${t+1} 次，请稍后重试`,message:`服务器错误 ${e}`};if(401===e||403===e){let t=`Grsai Chat API 错误: ${e}`;try{let e=JSON.parse(r);e.error?.message?t+=` - ${e.error.message}`:e.message&&(t+=` - ${e.message}`)}catch{t+=` - ${r.substring(0,200)}`}return 401===e?t+=" (提示: 请检查 GRSAI_API_KEY 是否正确配置)":t+=" (提示: API Key 可能没有权限或已过期)",{shouldRetry:!1,retryDelay:0,errorMessage:t,message:"认证错误"}}let a=`Grsai Chat API 错误: ${e}`;try{let e=JSON.parse(r);e.error?.message?a+=` - ${e.error.message}`:e.message?a+=` - ${e.message}`:a+=` - ${r.substring(0,200)}`}catch{a+=` - ${r.substring(0,200)}`}return{shouldRetry:!1,retryDelay:0,errorMessage:a,message:`客户端错误 ${e}`}}(i.status,t,r,0);if(s.shouldRetry&&r<3)return console.warn(`[Grsai Chat API] ${s.message}，${s.retryDelay}ms 后重试 (${r+1}/3)...`),await new Promise(e=>setTimeout(e,s.retryDelay)),h(e,r+1);throw Error(s.errorMessage)}let g=await i.json();if(!g.choices||0===g.choices.length)throw console.error("[Grsai Chat API] ⚠️⚠️⚠️ 严重问题：API 返回空 choices 数组！完整响应:",JSON.stringify(g,null,2)),Error("API 返回空 choices 数组，可能请求被拒绝或格式错误");if(!g.choices[0]?.message?.content)throw console.error("[Grsai Chat API] ⚠️⚠️⚠️ 严重问题：API 返回空 content！完整响应:",JSON.stringify(g,null,2)),Error("API 返回空 content，可能内容被过滤或拒绝");return console.log("[Grsai Chat API] 响应详情:",{model:g.model,hasChoices:!!g.choices,choicesCount:g.choices?.length||0,firstChoiceContentLength:g.choices?.[0]?.message?.content?.length||0,finishReason:g.choices?.[0]?.finish_reason}),g}async function*m(e,r=0){let t;let a=1e3*(r+1),i=s(),n=o();r>0&&console.log(`[Grsai Chat API Stream] 重试请求 (尝试 ${r+1}/3):`,{host:n,model:e.model,retryCount:r,delay:a});let l=new AbortController,c=setTimeout(()=>l.abort(),6e4);try{t=await fetch(`${n}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({...e,stream:!0}),signal:l.signal,keepalive:!0}),clearTimeout(c)}catch(t){if(clearTimeout(c),t instanceof Error&&("AbortError"===t.name||t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED")||t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo")||t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))&&r<3){console.warn(`[Grsai Chat API Stream] 网络错误，${a}ms 后重试...`,{error:t instanceof Error?t.message:String(t),retryCount:r+1,maxRetries:3}),await new Promise(e=>setTimeout(e,a)),yield*m(e,r+1);return}if(t instanceof Error){if("AbortError"===t.name)throw Error(`Grsai Chat API 流式请求超时（60秒），请检查网络连接或稍后重试`);if(t.message.includes("fetch failed")||t.message.includes("ECONNREFUSED"))throw Error("Grsai Chat API 连接失败，请检查网络连接或 API 服务是否可用");if(t.message.includes("ENOTFOUND")||t.message.includes("getaddrinfo"))throw Error("Grsai Chat API 域名解析失败，请检查网络连接");if(t.message.includes("ECONNRESET")||t.message.includes("socket hang up"))throw Error("Grsai Chat API 连接被重置，可能是网络不稳定，请稍后重试")}throw Error(`Grsai Chat API 流式请求失败: ${t instanceof Error?t.message:"未知错误"}`)}if(!t.ok){let s=await t.text();if(console.error("[Grsai Chat API Stream] 请求失败:",{status:t.status,statusText:t.statusText,model:e.model,messagesCount:e.messages.length,errorText:s.substring(0,500),retryCount:r}),t.status>=500&&t.status<600&&r<3){console.warn(`[Grsai Chat API Stream] 服务器错误 ${t.status}，${a}ms 后重试...`),await new Promise(e=>setTimeout(e,a)),yield*m(e,r+1);return}throw Error(`Grsai Chat API 错误: ${t.status} - ${s}`)}console.log("[Grsai Chat API Stream] 流式响应开始:",{status:t.status,model:e.model,contentType:t.headers.get("content-type")});let u=t.body?.getReader();if(!u)throw Error("无法读取流式响应");let h=new TextDecoder,d="",g=0,f=!1,E=null;try{for(;;){let{done:r,value:t}=await u.read();if(r)break;let s=(d+=h.decode(t,{stream:!0})).split("\n");for(let r of(d=s.pop()||"",s)){let t=r.trim();if(t&&"data: [DONE]"!==t&&t.startsWith("data: "))try{let r=JSON.parse(t.slice(6));if(g++,r.choices&&r.choices.length>0)f=!0,yield r;else{if(E||(E={chunk:r,rawLine:t.substring(0,500),chunkNumber:g}),console.error(`[Grsai Chat API Stream] ⚠️⚠️⚠️ Chunk #${g} 无choices！`,{model:e.model,hasChoices:!!r.choices,choicesLength:r.choices?.length||0,hasError:!!r.error,error:r.error,hasId:!!r.id,hasModel:!!r.model,fullChunk:JSON.stringify(r,null,2),rawLine:t.substring(0,300)}),r.error){let e=r.error.message||JSON.stringify(r.error);throw Error(`Grsai Chat API 返回错误: ${e}`)}yield r}}catch(e){if(console.error("[Grsai Chat API Stream] 解析流式响应失败:",{error:e instanceof Error?e.message:String(e),rawLine:t.substring(0,200),lineLength:t.length}),e instanceof Error&&e.message.includes("Grsai Chat API"))throw e}}}if(g>0&&!f&&console.error("[Grsai Chat API Stream] ⚠️⚠️⚠️ 所有chunk都没有choices！",{totalChunks:g,firstInvalidChunk:E?{chunkNumber:E.chunkNumber,hasError:!!E.chunk.error,error:E.chunk.error,fullChunk:JSON.stringify(E.chunk,null,2)}:null}),d.trim()&&"data: [DONE]"!==d.trim()){let e=d.trim();if(e.startsWith("data: "))try{let r=JSON.parse(e.slice(6));yield r}catch{}}}finally{u.releaseLock()}}t.d(r,{LV:()=>i,createChatCompletion:()=>h,gW:()=>o,getTaskResult:()=>l,ko:()=>c,z4:()=>m})}};