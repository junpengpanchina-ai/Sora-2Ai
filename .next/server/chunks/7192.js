"use strict";exports.id=7192,exports.ids=[7192],exports.modules={97192:(e,t,r)=>{r.d(t,{NA:()=>E,NF:()=>R,WP:()=>g,XW:()=>w,nH:()=>f,uploadVideoFromUrl:()=>S});var o=r(21841),n=r(90688);let i=process.env.R2_ACCOUNT_ID||"2776117bb412e09a1d30cbe886cd3935",s=process.env.R2_ACCESS_KEY_ID||"",c=process.env.R2_SECRET_ACCESS_KEY||"",a=process.env.R2_BUCKET_NAME||"sora2",l=process.env.R2_PUBLIC_URL||"https://pub-2868c824f92441499577980a0b61114c.r2.dev",d=process.env.R2_S3_ENDPOINT||`https://${i}.r2.cloudflarestorage.com`,u=null;function h(){if(u||!s||!c)return;let e=s.trim(),t=c.trim(),r=function(e){let t=e.trim();return 64===t.length&&/^[0-9a-fA-F]{64}$/i.test(t)&&console.log(`[R2] 检测到64字符十六进制密钥，尝试使用完整64字符`),t}(t);console.log("[R2] 初始化客户端:",{accessKeyLength:e.length,accessKeyPreview:e.substring(0,8)+"...",originalSecretLength:t.length,originalSecretPreview:t.substring(0,8)+"...",validSecretLength:r.length,validSecretPreview:r.substring(0,8)+"...",accountId:i,bucket:a,endpoint:d});try{u=new o.S3Client({region:"auto",endpoint:d,credentials:{accessKeyId:e,secretAccessKey:r}}),console.log("[R2] 客户端创建成功，密钥长度:",r.length)}catch(n){let o=n instanceof Error?n.message:String(n);if(console.error("[R2] 客户端创建失败:",{error:o,accessKeyId:e.substring(0,8)+"...",accessKeyLength:e.length,originalSecretLength:t.length,originalSecretPreview:t.substring(0,8)+"...",validSecretLength:r.length,validSecretPreview:r.substring(0,8)+"...",accountId:i,endpoint:d,bucket:a}),o.includes("length"))throw Error(`R2客户端创建失败: ${o}
原始密钥长度: ${t.length}字符
处理后密钥长度: ${r.length}字符（应该是32）
原始密钥预览: ${t.substring(0,16)}...
处理后密钥预览: ${r.substring(0,16)}...
Account ID: ${i}
Endpoint: ${d}

如果密钥长度不是32，请检查 getValidSecretAccessKey 函数的处理逻辑`);throw Error(`R2客户端创建失败: ${o}
配置详情: Access Key长度=${e.length}, Secret长度=${r.length}
Account ID=${i}, Endpoint=${d}
建议: 检查环境变量配置，确保R2_ACCESS_KEY_ID和R2_SECRET_ACCESS_KEY正确`)}}function g(e){let t=e.startsWith("/")?e.slice(1):e;return`${l}/${t}`}async function E(e,t=100){if(!u)try{h()}catch(r){console.error("[R2] 延迟初始化失败:",r);let e={hasAccountId:!!i,hasAccessKey:!!s,hasSecretKey:!!c,hasBucket:!!a,accessKeyLength:s?.length||0,secretKeyLength:c?.length||0,secretLooksLikeUrl:c&&(c.startsWith("http://")||c.startsWith("https://"))};if(e.secretLooksLikeUrl)throw Error("R2_SECRET_ACCESS_KEY 配置错误：这应该是一个密钥字符串，而不是URL。请检查你的环境变量配置。");if(!e.hasAccessKey||!e.hasSecretKey)throw Error("R2客户端未配置。请设置环境变量: R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, 和 R2_SECRET_ACCESS_KEY");let t=r instanceof Error?r.message:String(r);throw Error(`R2客户端初始化失败: ${t}`)}if(!u)throw Error("R2客户端初始化失败。请检查环境变量配置和密钥格式。");try{let{ListObjectsV2Command:o}=await Promise.resolve().then(r.t.bind(r,21841,23)),n=new o({Bucket:a,Prefix:e,MaxKeys:t});if(console.log("正在列出R2文件:",{bucket:a,prefix:e||"根目录",maxKeys:t,endpoint:d}),!u)throw Error("R2客户端未初始化");let i=await u.send(n),s=i.Contents?.map(e=>({key:e.Key,size:e.Size,lastModified:e.LastModified,url:e.Key?g(e.Key):null}))||[];return console.log(`成功获取 ${s.length} 个文件`),{files:s,isTruncated:i.IsTruncated,nextContinuationToken:i.NextContinuationToken}}catch(r){console.error("列出R2文件失败:",{error:r instanceof Error?r.message:String(r),stack:r instanceof Error?r.stack:void 0,bucket:a,prefix:e||"根目录",endpoint:d});let t=r instanceof Error?r.message:"Unknown error";if(t.includes("InvalidAccessKeyId")||t.includes("SignatureDoesNotMatch"))throw Error("R2凭证无效。请检查 R2_ACCESS_KEY_ID 和 R2_SECRET_ACCESS_KEY 是否正确。注意：R2_SECRET_ACCESS_KEY 应该是密钥字符串，不是URL。");if(t.includes("NoSuchBucket"))throw Error(`R2存储桶不存在: ${a}。请检查 R2_BUCKET_NAME 环境变量。`);throw Error(`列出文件失败: ${t}`)}}async function R(e,t=3600){if(!u)throw Error("R2 client not configured. Please set R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, and R2_SECRET_ACCESS_KEY");try{let r=new o.GetObjectCommand({Bucket:a,Key:e});return await (0,n.e)(u,r,{expiresIn:t})}catch(e){throw console.error("Failed to generate presigned URL:",e),Error(`Failed to generate presigned URL: ${e instanceof Error?e.message:"Unknown error"}`)}}async function f(e){if(!u)try{return(await fetch(g(e),{method:"HEAD"})).ok}catch{return!1}try{let{HeadObjectCommand:t}=await Promise.resolve().then(r.t.bind(r,21841,23)),o=new t({Bucket:a,Key:e});return await u.send(o),!0}catch(e){if(e?.name==="NotFound"||e?.$metadata?.httpStatusCode===404)return!1;throw e instanceof Error?e:Error("Unknown error while checking file existence")}}async function S(e,t){if(!u)try{h()}catch(e){throw console.error("[R2] Failed to initialize client for upload:",e),Error("R2 client not configured. Please set R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY")}if(!u)throw Error("R2 client initialization failed");try{console.log("[R2] Downloading original video from:",e);let r=await fetch(e,{headers:{Accept:"video/mp4,video/*;q=0.9,*/*;q=0.8","Accept-Encoding":"identity","Accept-Language":"en-US,en;q=0.9","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:"https://sora2aivideos.com/","Sec-Fetch-Dest":"video","Sec-Fetch-Mode":"no-cors","Sec-Fetch-Site":"cross-site"},redirect:"follow"});if(!r.ok){let t=await r.text().catch(()=>"Unable to read error response");if(console.error("[R2] ❌ Failed to download video:",{status:r.status,statusText:r.statusText,sourceUrl:e,errorText:t.substring(0,200),headers:Object.fromEntries(r.headers.entries())}),403===r.status)throw Error(`Access denied (403): The source video URL may have access restrictions or the server is blocking our requests. This might indicate the source is blocking automated downloads. Details: ${t.substring(0,100)}`);if(404===r.status)throw Error(`Video not found (404): The source video URL is no longer available. Details: ${t.substring(0,100)}`);if(429===r.status)throw Error(`Rate limited (429): Too many requests to source server. This might indicate the source is rate-limiting our downloads. Please try again later. Details: ${t.substring(0,100)}`);throw Error(`Failed to download video (${r.status}): ${r.statusText}. Details: ${t.substring(0,100)}`)}let n=r.headers.get("content-type")||"video/mp4",i=r.headers.get("content-length"),s=i?parseInt(i):null,c=await r.arrayBuffer(),l=Buffer.from(c),d=l.length,h={sourceUrl:e,contentType:n,expectedSize:s?`${(s/1024/1024).toFixed(2)} MB (${s} bytes)`:"unknown",actualSize:`${(d/1024/1024).toFixed(2)} MB (${d} bytes)`,sizeMatch:s?d===s:"unknown",r2Key:t};console.log("[R2] Video quality verification:",h),s&&d!==s?(console.warn("[R2] ⚠️ Video size mismatch - expected:",s,"bytes, got:",d,"bytes"),console.warn("[R2] This might indicate the video was compressed during download")):s&&d===s&&console.log("[R2] ✅ Video size matches - original quality preserved");let E=t.startsWith("/")?t.slice(1):t;console.log("[R2] Uploading video to R2:",E);let R=new o.PutObjectCommand({Bucket:a,Key:E,Body:l,ContentType:n,Metadata:{"source-url":e,"uploaded-at":new Date().toISOString(),"original-size":d.toString(),"content-type":n}});return await u.send(R),console.log("[R2] ✅ Video uploaded successfully to R2:",{key:E,size:`${(d/1024/1024).toFixed(2)} MB`,r2Url:g(E)}),g(E)}catch(r){throw console.error("[R2] Failed to upload video:",{error:r instanceof Error?r.message:String(r),sourceUrl:e,key:t}),Error(`Failed to upload video to R2: ${r instanceof Error?r.message:"Unknown error"}`)}}async function w(e){if(!u)try{h()}catch(e){throw console.error("[R2] Failed to initialize client for delete:",e),Error("R2 client not configured. Please set R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY")}if(!u)throw Error("R2 client initialization failed");try{let t=e.startsWith("/")?e.slice(1):e;console.log("[R2] Deleting file from R2:",t);let r=new o.DeleteObjectCommand({Bucket:a,Key:t});await u.send(r),console.log("[R2] ✅ File deleted successfully:",t)}catch(t){throw console.error("[R2] Failed to delete file:",{error:t instanceof Error?t.message:String(t),key:e}),Error(`Failed to delete file from R2: ${t instanceof Error?t.message:"Unknown error"}`)}}}};