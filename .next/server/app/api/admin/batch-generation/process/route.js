"use strict";(()=>{var e={};e.id=4260,e.ids=[4260],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},1247:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>m,patchFetch:()=>S,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_});var r={};s.r(r),s.d(r,{POST:()=>p,dynamic:()=>l,revalidate:()=>u});var a=s(49303),n=s(88716),o=s(60670),i=s(87070),c=s(23770);let l="force-dynamic",u=0;function d(){return process.env.NEXT_PUBLIC_SITE_URL||"http://sora2aivideos.com"}async function p(e){try{let{taskId:t}=await e.json();if(!t)return i.NextResponse.json({error:"缺少 taskId 参数"},{status:400});let r=await (0,c.createServiceClient)(),a=()=>r.from("batch_generation_tasks"),{data:n,error:o}=await a().select("*").eq("id",t).single();if(o||!n)return console.error(`[process] 获取任务失败:`,o),i.NextResponse.json({error:"任务不存在"},{status:404});if(n.should_stop||"cancelled"===n.status)return i.NextResponse.json({success:!0,message:"任务已取消"});if(n.is_paused){console.log(`[process] 任务 ${t} 已暂停，等待恢复...`);let e=0;for(;e<10;){await new Promise(e=>setTimeout(e,1e3));let{data:s}=await a().select("is_paused, should_stop, status").eq("id",t).single();if(s?.should_stop||s?.status==="cancelled")return console.log(`[process] 任务 ${t} 已终止，停止处理`),i.NextResponse.json({success:!0,message:"任务已终止"});if(s&&!s.is_paused){console.log(`[process] 任务 ${t} 已恢复，继续处理`);break}e++}let{data:s}=await a().select("is_paused, should_stop, status").eq("id",t).single();if(s?.is_paused)return i.NextResponse.json({success:!0,message:"任务已暂停，等待恢复"});if(s?.should_stop||s?.status==="cancelled")return i.NextResponse.json({success:!0,message:"任务已终止"})}"pending"===n.status&&await a().update({status:"processing",started_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t);let l=n.industries||[],u=n.current_industry_index||0;if(u>=l.length)return await a().update({status:"completed",progress:100,completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t),i.NextResponse.json({success:!0,message:"任务已完成"});let p=l[u],g=n.scenes_per_industry||100,h=n.use_case_type||"advertising-promotion",_=n.geo||"US";try{let{generateAndSaveScenes:e}=await s.e(1151).then(s.bind(s,61151));console.log(`[${p}] 开始生成 ${g} 条场景词（边生成边保存模式，GEO: ${_}）...`);let o=await e(p,g,h,t,r,_),c=o.scenes,f=o.savedCount,m=o.failedCount,S=o.errors;if(console.log(`[${p}] 生成和保存完成: 生成 ${c.length} 条, 成功保存 ${f} 条, 失败 ${m} 条`),0===c.length){console.error(`[${p}] ⚠️ 严重警告: 生成返回空数组！`),console.error(`[${p}] 这不应该发生，因为系统应该已经自动切换到 gemini-3-flash（联网搜索）`),console.error(`[${p}] 可能原因: 1) API 调用失败 2) JSON 解析失败 3) Fallback 逻辑未触发`),await a().update({last_error:`${p}: 生成返回 0 条场景词（异常情况，系统应该已自动切换到联网搜索模型）`,updated_at:new Date().toISOString()}).eq("id",t);let e=Math.round((u+1)/l.length*100);if(await a().update({current_industry_index:u+1,total_scenes_generated:(n.total_scenes_generated||0)+0,total_scenes_saved:(n.total_scenes_saved||0)+0,progress:e,updated_at:new Date().toISOString()}).eq("id",t),u+1<l.length){let e=`${d()}/api/admin/batch-generation/process`;fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskId:t})}).catch(e=>{console.error(`[process] 链式调用失败:`,e)})}return i.NextResponse.json({success:!0,message:`${p} 生成返回空数组，继续处理下一个行业`})}S.length>0&&S.length<=5?console.error(`[${p}] 保存错误详情:`,S):S.length>5&&console.error(`[${p}] 保存错误详情 (前5条):`,S.slice(0,5));let w=Math.round((u+1)/l.length*100),y=m>0?`${p}: ${m} 条场景词保存失败${S.length>0?` (${S[0]})`:""}`:null,{data:E}=await a().select("total_scenes_saved").eq("id",t).single(),R=E?.total_scenes_saved||0;if(await a().update({current_industry_index:u+1,total_scenes_generated:(n.total_scenes_generated||0)+c.length,total_scenes_saved:R,progress:w,updated_at:new Date().toISOString(),last_error:y}).eq("id",t),0===f&&c.length>0&&(console.error(`[${p}] ⚠️ 警告: 所有场景词保存失败！`),await a().update({last_error:`${p}: 所有 ${c.length} 条场景词保存失败，请检查数据库连接和错误日志`,updated_at:new Date().toISOString()}).eq("id",t)),u+1<l.length){let e=`${d()}/api/admin/batch-generation/process`;fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskId:t})}).catch(e=>{console.error(`[process] 链式调用失败:`,e),a().update({status:"failed",error_message:e instanceof Error?e.message:"链式调用失败",updated_at:new Date().toISOString()}).eq("id",t).catch(e=>{console.error(`[process] 更新任务状态失败:`,e)})})}else await a().update({status:"completed",progress:100,completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t);return i.NextResponse.json({success:!0,message:`行业 ${p} 处理完成`,currentIndex:u+1,totalIndustries:l.length})}catch(e){return console.error(`[${p}] 处理失败:`,e),await a().update({last_error:e instanceof Error?e.message:"未知错误",updated_at:new Date().toISOString()}).eq("id",t),i.NextResponse.json({success:!1,error:e instanceof Error?e.message:"未知错误"},{status:500})}}catch(e){return console.error("[process] 异常:",e),i.NextResponse.json({error:"处理失败",details:e instanceof Error?e.message:"未知错误"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/batch-generation/process/route",pathname:"/api/admin/batch-generation/process",filename:"route",bundlePath:"app/api/admin/batch-generation/process/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/admin/batch-generation/process/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:f}=g,m="/api/admin/batch-generation/process/route";function S(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},23770:(e,t,s)=>{s.r(t),s.d(t,{createServiceClient:()=>o});var r=s(24330);s(60166);var a=s(37857),n=s(77658);async function o(){let e="https://hgzpzsiafycwlqrkzbis.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY,s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q";if(!e)throw Error("缺少 Supabase 服务端配置，请设置 NEXT_PUBLIC_SUPABASE_URL");if(!t)throw Error("缺少 SUPABASE_SERVICE_ROLE_KEY，请在 .env.local 与部署环境中配置 Supabase Service Role Key");if(s&&t===s)throw Error("SUPABASE_SERVICE_ROLE_KEY 不能与 NEXT_PUBLIC_SUPABASE_ANON_KEY 相同，请复制 Supabase 项目的 Service Role Key");return(0,a.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1},global:{headers:{Connection:"keep-alive"},fetch:(e,t)=>(0,n.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})}})}(0,s(40618).h)([o]),(0,r.j)("c5e0ed9abe93e89f66e50896ba7be6694aef9aa6",o)},77658:(e,t,s)=>{s.d(t,{e:()=>n});var r=s(47065);function a(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),s=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===s||"ECONNRESET"===s}async function n(e,t,s={}){let n=s.timeoutMs??3e4;try{return await (0,r.J)(async()=>{let{signal:r,cleanup:o}=function(e,t){let s=new AbortController,r=setTimeout(()=>s.abort(),t),a=null;return e&&(e.aborted?(clearTimeout(r),s.abort()):(a=()=>s.abort(),e.addEventListener("abort",a,{once:!0}))),{signal:s.signal,cleanup:()=>{clearTimeout(r),e&&a&&e.removeEventListener("abort",a)}}}(t?.signal,n);try{let a=new Headers(t?.headers);return s.keepAlive&&a.set("Connection","keep-alive"),await fetch(e,{...t,signal:r,headers:a})}catch(e){throw a(e),e}finally{o()}},{maxRetries:s.maxRetries??3,retryDelay:s.retryDelay??500,exponentialBackoff:s.exponentialBackoff??!0,onRetry:s.onRetry??(()=>{})})}catch(e){if(s.returnErrorResponseOnFailure&&a(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,s)=>{s.d(t,{J:()=>a,delay:()=>o,withRetryQuery:()=>n});let r={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function a(e,t={}){let s;let a={...r,...t};for(let t=0;t<=a.maxRetries;t++)try{return await e()}catch(r){if(s=r,t===a.maxRetries)throw r;let e=a.exponentialBackoff?a.retryDelay*Math.pow(2,t):a.retryDelay;a.onRetry&&r instanceof Error&&a.onRetry(t+1,r),await new Promise(t=>setTimeout(t,e))}throw s}async function n(e,t={}){return a(async()=>{let t=await e();if(t.error){let e=t.error,s=e.message||String(e);if(s.includes("ECONNRESET")||s.includes("fetch failed")||s.includes("network")||s.includes("timeout")||s.includes("ETIMEDOUT")||s.includes("socket")||s.includes("TLS"))throw e}return t},t)}async function o(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,7289,5972,8341],()=>s(1247));module.exports=r})();