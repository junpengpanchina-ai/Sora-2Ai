"use strict";(()=>{var e={};e.id=3508,e.ids=[3508],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},91106:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>S,patchFetch:()=>w,requestAsyncStorage:()=>A,routeModule:()=>y,serverHooks:()=>I,staticGenerationAsyncStorage:()=>_});var s={};n.r(s),n.d(s,{GET:()=>f,POST:()=>p,dynamic:()=>d,revalidate:()=>m});var r=n(49303),o=n(88716),a=n(60670),i=n(87070),c=n(64363),l=n(49606);function u(e){let t=e.toLowerCase(),n=[],s=!1,r=!1,o=["成本","价格","售价","定价","费用","收费","价格对比","成本对比","cost","price","pricing","fee","charge","cost comparison","price comparison","价格分析","成本分析","定价策略","价格策略","pricing analysis","cost analysis","pricing strategy"].some(e=>!!t.includes(e)&&(n.push(e),!0)),a=["同行","竞争对手","竞品","对比","比较","vs","versus","competitor","competition","rival","compare","comparison","同行分析","竞品分析","竞争对手分析","competitor analysis","competitive analysis"].some(e=>!!t.includes(e)&&(n.push(e),!0)),i=["市场分析","行业分析","趋势分析","深度分析","综合分析","market analysis","industry analysis","trend analysis","deep analysis","comprehensive analysis","strategic analysis"].some(e=>!!t.includes(e)&&(n.push(e),!0));return(o||a)&&(o&&a||i)?(s=!0,(e.length>1e3||n.length>=3)&&(r=!0)):(o||a)&&(s=!0),{needsAdvancedModel:s,needsProModel:r,keywords:n}}var h=n(23770);let d="force-dynamic",m=0;async function p(e){try{let t=await (0,c.i7)();if(!t)return i.NextResponse.json({success:!1,error:"未授权"},{status:401});if(!process.env.GRSAI_API_KEY)return console.error("[Admin Chat] GRSAI_API_KEY 未配置"),i.NextResponse.json({success:!1,error:"API Key 未配置",debug:{suggestion:"请检查环境变量 GRSAI_API_KEY 是否已设置"}},{status:500});let{sessionId:n,message:s,images:r=[],model:o,stream:a=!0,saveHistory:d=!0}=await e.json();if(!s&&(!r||0===r.length))return i.NextResponse.json({success:!1,error:"消息内容或图片至少需要提供一个"},{status:400});let m=o;m||(m=function(e,t=[]){if(t.length>0){let t=u(e);return t.needsProModel?"gemini-3-pro":(t.needsAdvancedModel,"gemini-3-flash")}let n=u(e);return n.needsProModel?"gemini-3-pro":n.needsAdvancedModel?"gemini-3-flash":"gemini-2-flash"}(s||"",r));let p=[],f=`You are a helpful and professional AI assistant. You provide clear, concise, and helpful responses to user questions. 

Guidelines:
- Be friendly, professional, and conversational
- Provide accurate and useful information
- If you don't know something, admit it honestly
- Use clear language and structure your responses well
- Be concise but thorough
- Support both English and Chinese conversations naturally

You can help with:
- General questions and conversations
- Technical questions and explanations
- Problem-solving and analysis
- Content creation and editing
- Data analysis and insights
- And any other reasonable requests

Always aim to be helpful, accurate, and professional in your responses.`;p.push({role:"system",content:f});let y=[];if(n&&d){let e=await (0,h.createServiceClient)(),{data:t,error:s}=await e.from("admin_chat_messages").select("role, content, images").eq("session_id",n).order("created_at",{ascending:!0});if(!s&&t&&t.length>0){y=t;let e=[];for(let t of y){if("system"===t.role)continue;let n=t.content||"";t.images&&Array.isArray(t.images)&&t.images.length>0&&(n?n+=`

[包含 ${t.images.length} 张图片]`:n=`[包含 ${t.images.length} 张图片]`),e.push({role:t.role,content:n})}p.splice(1,0,...e)}}let A=s||"";r&&r.length>0&&(A?A+=`

[包含 ${r.length} 张图片]`:A=`[包含 ${r.length} 张图片，请分析这些图片]`,console.log(`[Admin Chat] 用户上传了 ${r.length} 张图片`)),p.push({role:"user",content:A});let _={model:m,stream:a,messages:p};if(("gemini-3-flash"===m||"gemini-3-pro"===m)&&(_.tools=[{type:"google_search_retrieval"}]),console.log("[Admin Chat] 发送请求:",{model:m,stream:a,messagesCount:p.length,systemPromptLength:p[0]?.role==="system"?p[0].content.length:0,userMessageLength:p[p.length-1]?.content?.length||0,hasTools:!!_.tools}),a){let e=new TextEncoder,s=new ReadableStream({async start(s){try{let o="",a=(0,l.z4)(_),i=0,c=null,u=!1,h=null;for await(let t of a){i++,t.error&&(u=!0,h=t.error.message||JSON.stringify(t.error),console.error("[Admin Chat Stream] API返回错误:",t.error)),t.choices?.[0]?.finish_reason&&(c=t.choices[0].finish_reason,console.log(`[Admin Chat Stream] 完成原因: ${c}`),("content_filter"===c||"safety"===c)&&(console.error("[Admin Chat Stream] ⚠️⚠️⚠️ 内容被过滤！",{finishReason:c,model:m,userMessage:p[p.length-1]?.content?.substring(0,100)}),u=!0,h=`内容被过滤（${c}），请尝试修改消息内容`)),(i<=3||!t.choices?.[0]?.delta?.content||c)&&console.log(`[Admin Chat Stream] Chunk #${i}:`,{hasChoices:!!t.choices,choicesLength:t.choices?.length||0,hasDelta:!!t.choices?.[0]?.delta,hasContent:!!t.choices?.[0]?.delta?.content,contentLength:t.choices?.[0]?.delta?.content?.length||0,finishReason:t.choices?.[0]?.finish_reason,model:t.model,fullChunk:i<=2?JSON.stringify(t,null,2):void 0});let n=`data: ${JSON.stringify(t)}

`;if(s.enqueue(e.encode(n)),t.choices&&t.choices.length>0){let e=t.choices[0].delta;e?.content&&(o+=e.content)}}if(console.log(`[Admin Chat Stream] 流式响应完成:`,{totalChunks:i,fullResponseLength:o.length,hasContent:o.length>0,finishReason:c,hasError:u,errorMessage:h}),0===o.length){let t=u&&h?h:"content_filter"===c||"safety"===c?`内容被过滤（${c}），请尝试修改消息内容`:"AI没有返回任何内容，可能是API响应格式异常";console.error("[Admin Chat Stream] ⚠️⚠️⚠️ 流式响应为空！",{model:m,messagesCount:p.length,finishReason:c,errorMessage:h,systemPrompt:p[0]?.role==="system"?p[0].content.substring(0,100):"无"});let n={error:{message:t,type:c||"empty_response",finishReason:c}};s.enqueue(e.encode(`data: ${JSON.stringify(n)}

`))}s.enqueue(e.encode("data: [DONE]\n\n")),s.close(),d&&n&&await g(n,t.id,p,o,m,r)}catch(t){let e=t instanceof Error?t.message:"未知错误";s.error(Error(e))}}});return new i.NextResponse(s,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}let I=await (0,l.createChatCompletion)(_);if(!I.choices||0===I.choices.length){let e=process.env.GRSAI_API_KEY,t=e?e.substring(0,10)+"...":"未配置",n=process.env.GRSAI_CHAT_HOST||"https://api.grsai.com";console.error("[Admin Chat] ⚠️⚠️⚠️ API 返回空 choices 数组！",{model:m,apiKeyConfigured:!!e,apiKeyPrefix:t,chatHost:n,responseStructure:{hasChoices:!!I.choices,choicesLength:I.choices?.length||0,hasId:!!I.id,hasModel:!!I.model,hasObject:!!I.object,fullResponseKeys:Object.keys(I||{})},requestInfo:{messageLength:s?.length||0,imagesCount:r?.length||0,hasHistory:y.length>0}});let o=I?.error;return i.NextResponse.json({success:!1,error:o?.message||"API 返回空 choices 数组，可能请求被拒绝或格式错误",debug:{model:m,apiKeyConfigured:!!e,apiKeyPrefix:t,chatHost:n,errorInfo:o,responseStructure:{hasChoices:!!I.choices,choicesLength:I.choices?.length||0,hasId:!!I.id,hasModel:!!I.model,fullResponse:void 0},suggestions:[e?null:"检查 GRSAI_API_KEY 环境变量是否已配置","检查 API Key 是否有效（未过期、有足够权限）","检查 API 服务是否可用（https://api.grsai.com）","检查请求内容是否被过滤或拒绝","查看服务器日志获取更多详细信息"].filter(Boolean)}},{status:500})}if(!I.choices[0]?.message?.content)return console.error("[Admin Chat] API 返回空 content！完整响应:",JSON.stringify(I,null,2)),i.NextResponse.json({success:!1,error:"API 返回空 content，可能内容被过滤或拒绝",debug:{model:m,responseStructure:{hasChoices:!!I.choices,choicesLength:I.choices?.length||0,hasContent:!!I.choices[0]?.message?.content,finishReason:I.choices[0]?.finish_reason,fullResponse:I}}},{status:500});let S=I.choices[0].message.content;return d&&n&&await g(n,t.id,p,S,m,r),i.NextResponse.json({success:!0,data:I,model:m})}catch(n){console.error("Admin Chat API 错误:",n);let e=n instanceof Error?n.message:"未知错误",t={message:e,errorType:n instanceof Error?n.constructor.name:typeof n};return(e.includes("choices")||e.includes("API"))&&(t.isApiError=!0,t.suggestion="请检查 GRSAI_API_KEY 是否正确配置，以及 API 服务是否可用"),(e.includes("database")||e.includes("table")||e.includes("relation"))&&(t.isDatabaseError=!0,t.suggestion="请检查数据库迁移是否已运行（041_create_admin_chat_history.sql）"),i.NextResponse.json({success:!1,error:e,debug:t},{status:500})}}async function g(e,t,n,s,r,o){try{let t=await (0,h.createServiceClient)(),a=n[n.length-1];if(a&&"user"===a.role){let n="";if("string"==typeof a.content)n=a.content;else if(Array.isArray(a.content)){let e=a.content.find(e=>"text"===e.type);n=e?.text||""}await t.from("admin_chat_messages").insert({session_id:e,role:"user",content:n,images:o.length>0?o:null,model:null})}s&&await t.from("admin_chat_messages").insert({session_id:e,role:"assistant",content:s,images:null,model:r}),await t.from("admin_chat_sessions").update({updated_at:new Date().toISOString()}).eq("id",e)}catch(e){console.error("保存聊天消息失败:",e)}}async function f(){try{let e=await (0,c.i7)();if(!e)return i.NextResponse.json({success:!1,error:"未授权"},{status:401});let t=await (0,h.createServiceClient)(),{data:n,error:s}=await t.from("admin_chat_sessions").select("*").eq("admin_user_id",e.id).order("updated_at",{ascending:!1}).limit(50);if(s)throw s;return i.NextResponse.json({success:!0,data:n})}catch(t){console.error("获取聊天会话失败:",t);let e=t instanceof Error?t.message:"未知错误";return i.NextResponse.json({success:!1,error:e},{status:500})}}let y=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/chat/route",pathname:"/api/admin/chat",filename:"route",bundlePath:"app/api/admin/chat/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/admin/chat/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:A,staticGenerationAsyncStorage:_,serverHooks:I}=y,S="/api/admin/chat/route";function w(){return(0,a.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:_})}},64363:(e,t,n)=>{n.d(t,{i7:()=>i});var s=n(60730),r=n(71615),o=n(84770);async function a(){try{let e=await (0,r.cookies)();return e.get("admin_session_token")?.value??null}catch(e){return console.error("[admin-auth] 获取 cookie 失败:",e),null}}async function i(){try{let e;let t=await a();if(!t)return null;try{e=await (0,s.e)()}catch(e){return console.error("[admin-auth] 创建 Supabase 客户端失败:",e),null}let n=(0,o.createHash)("sha256").update(t).digest("hex"),{data:i,error:c}=await e.rpc("admin_validate_session",{p_token_hash:n});if(c||!i){try{(await (0,r.cookies)()).delete("admin_session_token")}catch(e){console.warn("[admin-auth] 删除 cookie 失败:",e)}return null}return{id:i.id,username:i.username,is_super_admin:i.is_super_admin}}catch(e){return console.error("[admin-auth] validateAdminSession 异常:",e),null}}},60730:(e,t,n)=>{n.d(t,{e:()=>a});var s=n(85602),r=n(71615),o=n(77658);async function a(e){let t;let n=await (0,r.cookies)(),a=e??("function"==typeof r.headers?(()=>{try{return(0,r.headers)()}catch{return}})():void 0);a&&(t="function"==typeof a.get?a.get("authorization")??void 0:Array.isArray(a)?a.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(a).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let i={fetch:(e,t)=>(0,o.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return t&&(i.headers={Authorization:t}),(0,s.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:i,cookies:{getAll:()=>n.getAll(),setAll(e){try{e.forEach(({name:e,value:t,options:s})=>n.set(e,t,s))}catch{}}}})}},23770:(e,t,n)=>{n.r(t),n.d(t,{createServiceClient:()=>a});var s=n(24330);n(60166);var r=n(37857),o=n(77658);async function a(){let e="https://hgzpzsiafycwlqrkzbis.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY,n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q";if(!e)throw Error("缺少 Supabase 服务端配置，请设置 NEXT_PUBLIC_SUPABASE_URL");if(!t)throw Error("缺少 SUPABASE_SERVICE_ROLE_KEY，请在 .env.local 与部署环境中配置 Supabase Service Role Key");if(n&&t===n)throw Error("SUPABASE_SERVICE_ROLE_KEY 不能与 NEXT_PUBLIC_SUPABASE_ANON_KEY 相同，请复制 Supabase 项目的 Service Role Key");return(0,r.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1},global:{headers:{Connection:"keep-alive"},fetch:(e,t)=>(0,o.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})}})}(0,n(40618).h)([a]),(0,s.j)("c5e0ed9abe93e89f66e50896ba7be6694aef9aa6",a)},77658:(e,t,n)=>{n.d(t,{e:()=>o});var s=n(47065);function r(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),n=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===n||"ECONNRESET"===n}async function o(e,t,n={}){let o=n.timeoutMs??3e4;try{return await (0,s.J)(async()=>{let{signal:s,cleanup:a}=function(e,t){let n=new AbortController,s=setTimeout(()=>n.abort(),t),r=null;return e&&(e.aborted?(clearTimeout(s),n.abort()):(r=()=>n.abort(),e.addEventListener("abort",r,{once:!0}))),{signal:n.signal,cleanup:()=>{clearTimeout(s),e&&r&&e.removeEventListener("abort",r)}}}(t?.signal,o);try{let r=new Headers(t?.headers);return n.keepAlive&&r.set("Connection","keep-alive"),await fetch(e,{...t,signal:s,headers:r})}catch(e){throw r(e),e}finally{a()}},{maxRetries:n.maxRetries??3,retryDelay:n.retryDelay??500,exponentialBackoff:n.exponentialBackoff??!0,onRetry:n.onRetry??(()=>{})})}catch(e){if(n.returnErrorResponseOnFailure&&r(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,n)=>{n.d(t,{J:()=>r,delay:()=>a,withRetryQuery:()=>o});let s={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function r(e,t={}){let n;let r={...s,...t};for(let t=0;t<=r.maxRetries;t++)try{return await e()}catch(s){if(n=s,t===r.maxRetries)throw s;let e=r.exponentialBackoff?r.retryDelay*Math.pow(2,t):r.retryDelay;r.onRetry&&s instanceof Error&&r.onRetry(t+1,s),await new Promise(t=>setTimeout(t,e))}throw n}async function o(e,t={}){return r(async()=>{let t=await e();if(t.error){let e=t.error,n=e.message||String(e);if(n.includes("ECONNRESET")||n.includes("fetch failed")||n.includes("network")||n.includes("timeout")||n.includes("ETIMEDOUT")||n.includes("socket")||n.includes("TLS"))throw e}return t},t)}async function a(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),s=t.X(0,[8948,7289,5972,4967,8341,9606],()=>n(91106));module.exports=s})();