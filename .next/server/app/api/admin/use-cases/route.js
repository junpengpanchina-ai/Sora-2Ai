"use strict";(()=>{var e={};e.id=2818,e.ids=[2818],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},22889:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>E,staticGenerationAsyncStorage:()=>b});var r={};s.r(r),s.d(r,{GET:()=>h,POST:()=>_,dynamic:()=>c,revalidate:()=>d});var i=s(49303),n=s(88716),a=s(60670),o=s(87070),u=s(64363),l=s(23770);let c="force-dynamic",d=0,p=["advertising-promotion","social-media-content","product-demo-showcase","brand-storytelling","education-explainer","ugc-creator-content"];function y(e){return p.includes(e)}function f(e){return Array.isArray(e)?e.filter(e=>"string"==typeof e):"string"==typeof e?e.split(",").map(e=>e.trim()).filter(e=>e.length>0):[]}function m(e){return e&&"object"==typeof e?{message:"string"==typeof e.message?e.message:"string"==typeof e.error?e.error:"Unknown error",code:"string"==typeof e.code?e.code:void 0,details:"string"==typeof e.details?e.details:void 0,hint:"string"==typeof e.hint?e.hint:void 0,status:"number"==typeof e.status?e.status:void 0}:{message:"string"==typeof e?e:"Unknown error"}}async function h(e){try{if(!await (0,u.i7)())return console.error("[use-cases GET] 未授权访问"),o.NextResponse.json({error:"未授权，请先登录"},{status:401});let t=await (0,l.createServiceClient)(),{searchParams:s}=new URL(e.url),r=s.get("search")?.trim()??"",i=s.get("type")?.toLowerCase(),n=s.get("industry")?.trim()??null,a=s.get("status")?.toLowerCase(),c=s.get("quality_status")?.toLowerCase(),d=Math.min(Number(s.get("limit"))||50,1e3),p=Math.max(Number(s.get("offset"))||0,0),f=t.from("use_cases").select("id",{count:"exact",head:!0});if(i&&y(i)&&(f=f.eq("use_case_type",i)),n&&"all"!==n&&""!==n&&(f=f.eq("industry",n)),"published"===a?f=f.eq("is_published",!0):"draft"===a&&(f=f.eq("is_published",!1)),c&&"all"!==c&&("null"===c||"none"===c?f=f.is("quality_status",null):["pending","approved","rejected","needs_review"].includes(c)&&(f=f.eq("quality_status",c))),r){let e=r.replace(/[%_\\]/g,e=>`\\${e}`),t=`%${e}%`;f=f.or(`title.ilike.${t},description.ilike.${t},slug.ilike.${t}`)}let h=f,_=new Promise(e=>{setTimeout(()=>{e({count:null,error:{message:"查询超时（30秒）",code:"TIMEOUT"}})},3e4)}),{count:g,error:w}=await Promise.race([h,_]);w&&console.error("[use-cases GET] 获取总数错误:",w);let b=t.from("use_cases").select(`
        id,
        slug,
        title,
        h1,
        description,
        use_case_type,
        industry,
        featured_prompt_ids,
        related_use_case_ids,
        seo_keywords,
        is_published,
        quality_status,
        quality_issues,
        quality_score,
        quality_notes,
        reviewed_by_admin_id,
        reviewed_at,
        created_by_admin_id,
        created_at,
        updated_at
      `).order("updated_at",{ascending:!1}).range(p,p+d-1);if(i&&y(i)&&(b=b.eq("use_case_type",i)),n&&"all"!==n&&""!==n&&(b=b.eq("industry",n)),"published"===a?b=b.eq("is_published",!0):"draft"===a&&(b=b.eq("is_published",!1)),c&&"all"!==c&&("null"===c||"none"===c?b=b.is("quality_status",null):["pending","approved","rejected","needs_review"].includes(c)&&(b=b.eq("quality_status",c))),r){let e=r.replace(/[%_\\]/g,e=>`\\${e}`),t=`%${e}%`;b=b.or(`title.ilike.${t},description.ilike.${t},slug.ilike.${t}`)}let E=b,x=new Promise(e=>{setTimeout(()=>{e({data:null,error:{message:"查询超时（30秒）",code:"TIMEOUT"}})},3e4)}),{data:v,error:R}=await Promise.race([E,x]);if(R){let e=m(R);return console.error("[use-cases GET] Supabase 查询错误:",{...e}),o.NextResponse.json({error:"获取使用场景失败",details:e.message,code:e.code,hint:e.hint},{status:e.status&&e.status>=400?e.status:502})}let S=Array.isArray(v)?v:[],k="number"==typeof g?g:S.length;return o.NextResponse.json({success:!0,useCases:S,count:S.length,totalCount:k,limit:d,offset:p})}catch(s){console.error("[use-cases GET] 获取使用场景失败:",s);let e=m(s),t=s instanceof Error?s.stack:void 0;return console.error("[use-cases GET] 错误详情:",{...e}),console.error("[use-cases GET] 错误堆栈:",t),o.NextResponse.json({error:"获取使用场景失败",details:e.message||"未知错误",code:e.code,hint:e.hint},{status:500})}}async function _(e){try{let t=await (0,u.i7)();if(!t)return o.NextResponse.json({error:"未授权，请先登录"},{status:401});let s=await e.json().catch(()=>null);if(!s||"object"!=typeof s)return o.NextResponse.json({error:"请求体格式不正确"},{status:400});let r="string"==typeof s.slug?s.slug.trim():"",i="string"==typeof s.title?s.title.trim():"",n="string"==typeof s.h1?s.h1.trim():"",a="string"==typeof s.description?s.description.trim():"",c="string"==typeof s.content?s.content.trim():"",d="string"==typeof s.use_case_type?s.use_case_type.toLowerCase():"",p="boolean"==typeof s.isPublished?s.isPublished:"boolean"!=typeof s.is_published||s.is_published;if(!r)return o.NextResponse.json({error:"Slug 不能为空"},{status:400});if(!i)return o.NextResponse.json({error:"标题不能为空"},{status:400});if(!n)return o.NextResponse.json({error:"H1 不能为空"},{status:400});if(!a)return o.NextResponse.json({error:"描述不能为空"},{status:400});if(!c)return o.NextResponse.json({error:"内容不能为空"},{status:400});if(!y(d))return o.NextResponse.json({error:"使用场景类型不合法"},{status:400});let m=f(s.featured_prompt_ids),h=f(s.related_use_case_ids),_=f(s.seo_keywords),g="string"==typeof s.industry&&s.industry.trim()?s.industry.trim():null,w="string"==typeof s.quality_status&&["pending","approved","rejected","needs_review"].includes(s.quality_status)?s.quality_status:"pending",b=f(s.quality_issues),E="number"==typeof s.quality_score?Math.max(0,Math.min(100,s.quality_score)):null,x=await (0,l.createServiceClient)(),v=r,R=0;for(;R<100;){let{data:e,error:t}=await x.from("use_cases").select("slug").eq("slug",v).limit(1).maybeSingle();if(t||e)R++,v=`${r}-${R}`;else break}if(R>=100)throw Error(`无法生成唯一的 slug，已尝试 100 次`);let S={slug:v,title:i,h1:n,description:a,content:c,use_case_type:d,industry:g,featured_prompt_ids:m,related_use_case_ids:h,seo_keywords:_,is_published:p,quality_status:w,quality_issues:b.length>0?b:null,quality_score:E,created_by_admin_id:t.id},{data:k,error:I}=await x.from("use_cases").insert(S).select("*").single();if(I){if(console.error("[use-cases POST] Supabase 插入错误:",{code:I.code,message:I.message,details:I.details,hint:I.hint,insertPayload:{...S,content:S.content?.substring(0,100)+"..."}}),"23505"===I.code)throw Error(`Slug "${v}" 已存在，系统已尝试自动生成唯一 slug，但仍失败。请检查数据库或稍后重试。`);throw I}if(!k)throw console.error("[use-cases POST] 插入成功但未返回数据"),Error("创建使用场景失败：未返回数据");return console.log("[use-cases POST] 成功创建使用场景:",{id:k.id,slug:k.slug,title:k.title}),o.NextResponse.json({success:!0,useCase:k})}catch(i){console.error("[use-cases POST] 创建使用场景失败:",i);let e=i instanceof Error?i.message:"未知错误",t=i instanceof Error?i.stack:void 0,s=i&&"object"==typeof i&&"details"in i?i.details:void 0,r=i&&"object"==typeof i&&"code"in i?i.code:void 0;return console.error("[use-cases POST] 错误详情:",{message:e,code:r,details:s,stack:t}),o.NextResponse.json({error:"创建使用场景失败",details:e,code:r,hint:i&&"object"==typeof i&&"hint"in i?i.hint:void 0},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/use-cases/route",pathname:"/api/admin/use-cases",filename:"route",bundlePath:"app/api/admin/use-cases/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/admin/use-cases/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:b,serverHooks:E}=g,x="/api/admin/use-cases/route";function v(){return(0,a.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:b})}},64363:(e,t,s)=>{s.d(t,{i7:()=>o});var r=s(60730),i=s(71615),n=s(84770);async function a(){try{let e=await (0,i.cookies)();return e.get("admin_session_token")?.value??null}catch(e){return console.error("[admin-auth] 获取 cookie 失败:",e),null}}async function o(){try{let e;let t=await a();if(!t)return null;try{e=await (0,r.e)()}catch(e){return console.error("[admin-auth] 创建 Supabase 客户端失败:",e),null}let s=(0,n.createHash)("sha256").update(t).digest("hex"),{data:o,error:u}=await e.rpc("admin_validate_session",{p_token_hash:s});if(u||!o){try{(await (0,i.cookies)()).delete("admin_session_token")}catch(e){console.warn("[admin-auth] 删除 cookie 失败:",e)}return null}return{id:o.id,username:o.username,is_super_admin:o.is_super_admin}}catch(e){return console.error("[admin-auth] validateAdminSession 异常:",e),null}}},60730:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(85602),i=s(71615),n=s(77658);async function a(e){let t;let s=await (0,i.cookies)(),a=e??("function"==typeof i.headers?(()=>{try{return(0,i.headers)()}catch{return}})():void 0);a&&(t="function"==typeof a.get?a.get("authorization")??void 0:Array.isArray(a)?a.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(a).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let o={fetch:(e,t)=>(0,n.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return t&&(o.headers={Authorization:t}),(0,r.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:o,cookies:{getAll:()=>s.getAll(),setAll(e){try{e.forEach(({name:e,value:t,options:r})=>s.set(e,t,r))}catch{}}}})}},23770:(e,t,s)=>{s.r(t),s.d(t,{createServiceClient:()=>a});var r=s(24330);s(60166);var i=s(37857),n=s(77658);async function a(){let e="https://hgzpzsiafycwlqrkzbis.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY,s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q";if(!e)throw Error("缺少 Supabase 服务端配置，请设置 NEXT_PUBLIC_SUPABASE_URL");if(!t)throw Error("缺少 SUPABASE_SERVICE_ROLE_KEY，请在 .env.local 与部署环境中配置 Supabase Service Role Key");if(s&&t===s)throw Error("SUPABASE_SERVICE_ROLE_KEY 不能与 NEXT_PUBLIC_SUPABASE_ANON_KEY 相同，请复制 Supabase 项目的 Service Role Key");return(0,i.eI)(e,t,{auth:{persistSession:!1,autoRefreshToken:!1},global:{headers:{Connection:"keep-alive"},fetch:(e,t)=>(0,n.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})}})}(0,s(40618).h)([a]),(0,r.j)("c5e0ed9abe93e89f66e50896ba7be6694aef9aa6",a)},77658:(e,t,s)=>{s.d(t,{e:()=>n});var r=s(47065);function i(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),s=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===s||"ECONNRESET"===s}async function n(e,t,s={}){let n=s.timeoutMs??3e4;try{return await (0,r.J)(async()=>{let{signal:r,cleanup:a}=function(e,t){let s=new AbortController,r=setTimeout(()=>s.abort(),t),i=null;return e&&(e.aborted?(clearTimeout(r),s.abort()):(i=()=>s.abort(),e.addEventListener("abort",i,{once:!0}))),{signal:s.signal,cleanup:()=>{clearTimeout(r),e&&i&&e.removeEventListener("abort",i)}}}(t?.signal,n);try{let i=new Headers(t?.headers);return s.keepAlive&&i.set("Connection","keep-alive"),await fetch(e,{...t,signal:r,headers:i})}catch(e){throw i(e),e}finally{a()}},{maxRetries:s.maxRetries??3,retryDelay:s.retryDelay??500,exponentialBackoff:s.exponentialBackoff??!0,onRetry:s.onRetry??(()=>{})})}catch(e){if(s.returnErrorResponseOnFailure&&i(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,s)=>{s.d(t,{J:()=>i,delay:()=>a,withRetryQuery:()=>n});let r={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function i(e,t={}){let s;let i={...r,...t};for(let t=0;t<=i.maxRetries;t++)try{return await e()}catch(r){if(s=r,t===i.maxRetries)throw r;let e=i.exponentialBackoff?i.retryDelay*Math.pow(2,t):i.retryDelay;i.onRetry&&r instanceof Error&&i.onRetry(t+1,r),await new Promise(t=>setTimeout(t,e))}throw s}async function n(e,t={}){return i(async()=>{let t=await e();if(t.error){let e=t.error,s=e.message||String(e);if(s.includes("ECONNRESET")||s.includes("fetch failed")||s.includes("network")||s.includes("timeout")||s.includes("ETIMEDOUT")||s.includes("socket")||s.includes("TLS"))throw e}return t},t)}async function a(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,7289,5972,4967,8341],()=>s(22889));module.exports=r})();