"use strict";(()=>{var e={};e.id=8541,e.ids=[8541],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},38578:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f});var a={};n.r(a),n.d(a,{POST:()=>m,dynamic:()=>d,revalidate:()=>p});var r=n(49303),i=n(88716),s=n(60670),o=n(87070),u=n(84770),l=n(60730);let c=new Map,d="force-dynamic",p=0;async function m(e){let t=function(e){let t=e.headers.get("x-forwarded-for");return t?t.split(",")[0].trim():e.headers.get("x-real-ip")||"unknown"}(e);fetch("http://127.0.0.1:7242/ingest/ef411af9-a357-4528-93a0-017b8708eb6e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"app/api/auth/admin-login/route.ts:13",message:"Admin login attempt - ENTRY",data:{requestIp:t,userAgent:e.headers.get("user-agent")||"unknown",timestamp:new Date().toISOString()},timestamp:Date.now(),sessionId:"debug-session",runId:"post-fix",hypothesisId:"B"})}).catch(()=>{});let n=function(e,t){let n=Date.now(),a=`${t.keyPrefix||"rate-limit"}:${e}`,r=c.get(a);if(c.size>1e4)for(let[e,t]of c.entries())t.resetAt<n&&c.delete(e);if(!r||r.resetAt<n){let e={count:1,resetAt:n+t.windowMs};return c.set(a,e),{allowed:!0,remaining:t.maxRequests-1,resetAt:e.resetAt}}return r.count>=t.maxRequests?{allowed:!1,remaining:0,resetAt:r.resetAt}:(r.count++,c.set(a,r),{allowed:!0,remaining:t.maxRequests-r.count,resetAt:r.resetAt})}(t,{maxRequests:5,windowMs:9e5,keyPrefix:"admin-login"});if(fetch("http://127.0.0.1:7242/ingest/ef411af9-a357-4528-93a0-017b8708eb6e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"app/api/auth/admin-login/route.ts:23",message:"Admin login - Rate limit check",data:{requestIp:t,allowed:n.allowed,remaining:n.remaining,resetAt:new Date(n.resetAt).toISOString()},timestamp:Date.now(),sessionId:"debug-session",runId:"post-fix",hypothesisId:"B"})}).catch(()=>{}),!n.allowed){let e=Math.ceil((n.resetAt-Date.now())/1e3);return o.NextResponse.json({error:"请求过于频繁，请稍后再试",retryAfter:e},{status:429,headers:{"Retry-After":e.toString(),"X-RateLimit-Limit":"5","X-RateLimit-Remaining":"0","X-RateLimit-Reset":n.resetAt.toString()}})}try{let{username:a,password:r}=await e.json();if(fetch("http://127.0.0.1:7242/ingest/ef411af9-a357-4528-93a0-017b8708eb6e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"app/api/auth/admin-login/route.ts:50",message:"Admin login attempt - CREDENTIALS RECEIVED",data:{username:a?.substring(0,10)+"...",hasPassword:!!r,requestIp:t},timestamp:Date.now(),sessionId:"debug-session",runId:"post-fix",hypothesisId:"B"})}).catch(()=>{}),!a||!r)return o.NextResponse.json({error:"用户名和密码不能为空"},{status:400});let i=(0,u.randomUUID)()+(0,u.randomUUID)(),s=(0,u.createHash)("sha256").update(i).digest("hex"),c=new Date(Date.now()+6048e5).toISOString(),d=await (0,l.e)(),{data:p,error:m}=await d.rpc("admin_create_session",{p_username:a.trim(),p_password:r,p_token_hash:s,p_expires_at:c});if(m||!p)return fetch("http://127.0.0.1:7242/ingest/ef411af9-a357-4528-93a0-017b8708eb6e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"app/api/auth/admin-login/route.ts:67",message:"Admin login attempt - FAILED",data:{username:a?.substring(0,10)+"...",requestIp:t,error:m?.message},timestamp:Date.now(),sessionId:"debug-session",runId:"post-fix",hypothesisId:"B"})}).catch(()=>{}),o.NextResponse.json({error:"用户名或密码错误"},{status:401,headers:{"X-RateLimit-Limit":"5","X-RateLimit-Remaining":(n.remaining-1).toString(),"X-RateLimit-Reset":n.resetAt.toString()}});fetch("http://127.0.0.1:7242/ingest/ef411af9-a357-4528-93a0-017b8708eb6e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"app/api/auth/admin-login/route.ts:82",message:"Admin login attempt - SUCCESS",data:{username:a?.substring(0,10)+"...",requestIp:t},timestamp:Date.now(),sessionId:"debug-session",runId:"post-fix",hypothesisId:"B"})}).catch(()=>{});let h=o.NextResponse.json({success:!0});return h.cookies.set("admin_session_token",i,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:604800}),h}catch(e){return console.error("管理员登录接口异常:",e),o.NextResponse.json({error:e instanceof Error?e.message:"登录失败，请稍后重试"},{status:500})}}let h=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/admin-login/route",pathname:"/api/auth/admin-login",filename:"route",bundlePath:"app/api/auth/admin-login/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/auth/admin-login/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:y}=h,w="/api/auth/admin-login/route";function x(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},60730:(e,t,n)=>{n.d(t,{e:()=>s});var a=n(85602),r=n(71615),i=n(77658);async function s(e){let t;let n=await (0,r.cookies)(),s=e??("function"==typeof r.headers?(()=>{try{return(0,r.headers)()}catch{return}})():void 0);s&&(t="function"==typeof s.get?s.get("authorization")??void 0:Array.isArray(s)?s.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(s).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let o={fetch:(e,t)=>(0,i.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return t&&(o.headers={Authorization:t}),(0,a.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:o,cookies:{getAll:()=>n.getAll(),setAll(e){try{e.forEach(({name:e,value:t,options:a})=>n.set(e,t,a))}catch{}}}})}},77658:(e,t,n)=>{n.d(t,{e:()=>i});var a=n(47065);function r(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),n=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===n||"ECONNRESET"===n}async function i(e,t,n={}){let i=n.timeoutMs??3e4;try{return await (0,a.J)(async()=>{let{signal:a,cleanup:s}=function(e,t){let n=new AbortController,a=setTimeout(()=>n.abort(),t),r=null;return e&&(e.aborted?(clearTimeout(a),n.abort()):(r=()=>n.abort(),e.addEventListener("abort",r,{once:!0}))),{signal:n.signal,cleanup:()=>{clearTimeout(a),e&&r&&e.removeEventListener("abort",r)}}}(t?.signal,i);try{let r=new Headers(t?.headers);return n.keepAlive&&r.set("Connection","keep-alive"),await fetch(e,{...t,signal:a,headers:r})}catch(e){throw r(e),e}finally{s()}},{maxRetries:n.maxRetries??3,retryDelay:n.retryDelay??500,exponentialBackoff:n.exponentialBackoff??!0,onRetry:n.onRetry??(()=>{})})}catch(e){if(n.returnErrorResponseOnFailure&&r(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,n)=>{n.d(t,{J:()=>r,delay:()=>s,withRetryQuery:()=>i});let a={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function r(e,t={}){let n;let r={...a,...t};for(let t=0;t<=r.maxRetries;t++)try{return await e()}catch(a){if(n=a,t===r.maxRetries)throw a;let e=r.exponentialBackoff?r.retryDelay*Math.pow(2,t):r.retryDelay;r.onRetry&&a instanceof Error&&r.onRetry(t+1,a),await new Promise(t=>setTimeout(t,e))}throw n}async function i(e,t={}){return r(async()=>{let t=await e();if(t.error){let e=t.error,n=e.message||String(e);if(n.includes("ECONNRESET")||n.includes("fetch failed")||n.includes("network")||n.includes("timeout")||n.includes("ETIMEDOUT")||n.includes("socket")||n.includes("TLS"))throw e}return t},t)}async function s(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[8948,7289,5972,4967],()=>n(38578));module.exports=a})();