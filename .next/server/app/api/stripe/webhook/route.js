"use strict";(()=>{var e={};e.id=2757,e.ids=[2757,6299],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},20427:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>w,requestAsyncStorage:()=>h,routeModule:()=>k,serverHooks:()=>v,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{POST:()=>y,runtime:()=>d});var i=r(49303),s=r(88716),o=r(60670),a=r(87070),p=r(37857),l=r(76299),u=r(69206);let d="nodejs",c=(0,u.d)(),_=(0,p.eI)("https://hgzpzsiafycwlqrkzbis.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}});async function m(e){let{data:t,error:r}=await _.from("profiles").select("id").eq("email",e.toLowerCase()).maybeSingle();if(!r&&t?.id)return t.id;let{data:n}=await _.from("users").select("id").eq("email",e.toLowerCase()).maybeSingle();return n?.id??null}async function y(e){let t;let r=e.headers.get("stripe-signature");if(!r)return a.NextResponse.json({error:"Missing stripe-signature"},{status:400});let n=await e.text();try{t=c.webhooks.constructEvent(n,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(t){let e=t instanceof Error?t.message:"Unknown error";return a.NextResponse.json({error:`Webhook signature verification failed: ${e}`},{status:400})}if(!new Set(["checkout.session.completed","checkout.session.async_payment_succeeded"]).has(t.type))return a.NextResponse.json({received:!0});let i=t.data.object,s=i.metadata?.plan_id,o=s?l.v0[s]:null;if(!o){let e="string"==typeof i.payment_link?i.payment_link:null;e&&(o=(0,l.planFromPaymentLink)(e))}if(!o)return a.NextResponse.json({error:`Unknown plan (metadata.plan_id=${s}, payment_link=${i.payment_link})`},{status:400});let p=(i.customer_details?.email||i.customer_email||"").toLowerCase(),u=i.client_reference_id||i.metadata?.user_id||(p?await m(p):null);if(!u)return await _.from("pending_credit_grants").insert({stripe_event_id:t.id,stripe_session_id:i.id,payment_link_id:o.paymentLinkId,email:p,plan_id:o.planId,amount_total:i.amount_total??null,currency:i.currency??"usd"}),a.NextResponse.json({ok:!0,pending:!0});let d="string"==typeof i.payment_link?i.payment_link:o.paymentLinkId,{error:y}=await _.rpc("grant_credits_for_purchase",{p_user_id:u,p_plan_id:o.planId,p_payment_link_id:d,p_stripe_event_id:t.id,p_stripe_session_id:i.id,p_stripe_payment_intent_id:"string"==typeof i.payment_intent?i.payment_intent:null,p_email:p||null,p_amount_total:i.amount_total??null,p_currency:i.currency??"usd"});return y?(console.error("[webhook] grant_credits_for_purchase error:",y),a.NextResponse.json({error:y.message},{status:500})):a.NextResponse.json({ok:!0})}let k=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:v}=k,b="/api/stripe/webhook/route";function w(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:f})}},76299:(e,t,r)=>{r.d(t,{planFromPaymentLink:()=>i,v0:()=>n});let n={starter:{planId:"starter",displayName:"Starter Access",priceUsd:4.9,paymentLinkId:"plink_1SjMNLDqGbi6No9vUku66neA",permanentCredits:0,bonusCredits:200,bonusExpiresDays:7,allowVeoPro:!1,concurrency:1,dailyCaps:{sora:6,veo_fast:1}},creator:{planId:"creator",displayName:"Creator Pack",priceUsd:39,paymentLinkId:"plink_1SRxHLDqGbi6No9vhu7i5iud",permanentCredits:2e3,bonusCredits:600,bonusExpiresDays:14,allowVeoPro:!0,concurrency:2},studio:{planId:"studio",displayName:"Studio Pack",priceUsd:99,paymentLinkId:"plink_1SmxBiDqGbi6No9v4L6dFvvK",permanentCredits:6e3,bonusCredits:1500,bonusExpiresDays:30,allowVeoPro:!0,concurrency:3},pro:{planId:"pro",displayName:"Pro Pack",priceUsd:299,paymentLinkId:"plink_1SNF1zDqGbi6No9vqtJXYMhQ",permanentCredits:2e4,bonusCredits:4e3,bonusExpiresDays:60,allowVeoPro:!0,concurrency:5}};function i(e){return Object.values(n).find(t=>t.paymentLinkId===e)??null}},69206:(e,t,r)=>{r.d(t,{d:()=>s});var n=r(91988);let i=null;function s(){if(!i){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not set in environment variables");try{i=new n.Z(e,{apiVersion:"2025-10-29.clover"})}catch(e){throw console.error("[Stripe] Failed to initialize Stripe client:",e),Error(`Failed to initialize Stripe: ${e instanceof Error?e.message:"Unknown error"}`)}}return i}s()}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,7289,5972,1988],()=>r(20427));module.exports=n})();