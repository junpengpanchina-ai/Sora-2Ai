"use strict";(()=>{var e={};e.id=9634,e.ids=[9634],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},2586:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{POST:()=>y,dynamic:()=>p,revalidate:()=>m});var n=t(49303),a=t(88716),i=t(60670),o=t(60730),c=t(69206),u=t(87070),l=t(53573),d=t(49320);let p="force-dynamic",m=0;async function y(e){try{let r=await (0,o.e)(),{data:{user:t}}=await r.auth.getUser();if(!t)return u.NextResponse.json({error:"Unauthorized"},{status:401});let{recharge_id:s}=await e.json();if(!s)return u.NextResponse.json({error:"Missing recharge_id parameter"},{status:400});let{data:n,error:a}=await r.from("recharge_records").select("*").eq("id",s).single();if(a||!n)return u.NextResponse.json({error:"Recharge record not found",details:a?.message},{status:404});if("pending"!==n.status)return u.NextResponse.json({success:!0,message:`Recharge already ${n.status}`,recharge_status:n.status,recharge_record:n});let i=!1,p="unknown";if(n.payment_id)try{let e=(0,c.d)(),r=await e.checkout.sessions.retrieve(n.payment_id);p=r.payment_status,"paid"===r.payment_status&&(i=!0)}catch(r){let e=r instanceof Error?r.message:String(r);console.log("Not a session, checking other payment types...",e)}if(i){let e=parseFloat(n.amount?.toString()||"0"),t=(0,d.Y)(e);if(t){let e=(0,d.G)(t.bonusExpiresDays),s=await (0,l.S_)(r,n.user_id,t.permanentCredits,t.bonusCredits,e,t.isStarter);s.success?console.log(`[verify-payment] Added credits for tier ${t.planId}:`,{permanent:t.permanentCredits,bonus:t.bonusCredits,expiresDays:t.bonusExpiresDays,isStarter:t.isStarter}):console.error("Failed to add credits to wallet:",s.error)}else{console.warn(`[verify-payment] Unrecognized payment amount: $${e}, using fallback logic`);let t=n.credits??0;if(t>0){let e=await (0,l.S_)(r,n.user_id,t,0,null,!1);e.success||console.error("Failed to add credits to wallet (fallback):",e.error)}}return await r.from("recharge_records").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",s),u.NextResponse.json({success:!0,payment_verified:!0,recharge_status:"completed",message:"Payment verified and credits added"})}return u.NextResponse.json({success:!0,payment_verified:!1,payment_status:p,recharge_status:n.status,message:"Payment verification completed, but payment not yet confirmed"})}catch(e){return console.error("Failed to verify payment:",e),u.NextResponse.json({error:"Failed to verify payment",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/payment/verify-payment/route",pathname:"/api/payment/verify-payment",filename:"route",bundlePath:"app/api/payment/verify-payment/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/payment/verify-payment/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:w}=f,x="/api/payment/verify-payment/route";function _(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},49320:(e,r,t)=>{function s(e){if(.5>=Math.abs(e-4.9)){let e=new Date;return e.setDate(e.getDate()+7),{planId:"starter",permanentCredits:0,bonusCredits:200,bonusExpiresDays:7,isStarter:!0}}return .5>=Math.abs(e-39)?{planId:"creator",permanentCredits:2e3,bonusCredits:600,bonusExpiresDays:14,isStarter:!1}:.5>=Math.abs(e-99)?{planId:"studio",permanentCredits:6e3,bonusCredits:1500,bonusExpiresDays:30,isStarter:!1}:.5>=Math.abs(e-299)?{planId:"pro",permanentCredits:2e4,bonusCredits:4e3,bonusExpiresDays:60,isStarter:!1}:null}function n(e){let r=new Date;return r.setDate(r.getDate()+e),r.toISOString()}t.d(r,{G:()=>n,Y:()=>s})},53573:(e,r,t)=>{async function s(e,r,t,s){try{let{data:n,error:a}=await e.rpc("deduct_credits_from_wallet",{user_uuid:r,credits_needed:t,model_type:s});if(a)return console.error("Error deducting credits:",a),{success:!1,error:a.message};if(!n||!n.success)return{success:!1,error:n?.error||"Failed to deduct credits"};return{success:!0,bonusUsed:n.bonus_used||0,permanentUsed:n.permanent_used||0,remainingCredits:n.remaining_credits||0}}catch(e){return console.error("Error in deductCreditsFromWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function n(e,r,t=0,s=0,n,a=!1){try{let{data:i,error:o}=await e.rpc("add_credits_to_wallet",{user_uuid:r,permanent_amount:t,bonus_amount:s,bonus_expires_at:n||null,is_starter:a});if(o)return console.error("Error adding credits:",o),{success:!1,error:o.message};if(!i||!i.success)return{success:!1,error:i?.error||"Failed to add credits"};return{success:!0}}catch(e){return console.error("Error in addCreditsToWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}t.d(r,{A8:()=>s,S_:()=>n})},69206:(e,r,t)=>{t.d(r,{d:()=>a});var s=t(91988);let n=null;function a(){if(!n){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not set in environment variables");try{n=new s.Z(e,{apiVersion:"2025-10-29.clover"})}catch(e){throw console.error("[Stripe] Failed to initialize Stripe client:",e),Error(`Failed to initialize Stripe: ${e instanceof Error?e.message:"Unknown error"}`)}}return n}a()},60730:(e,r,t)=>{t.d(r,{e:()=>i});var s=t(85602),n=t(71615),a=t(77658);async function i(e){let r;let t=await (0,n.cookies)(),i=e??("function"==typeof n.headers?(()=>{try{return(0,n.headers)()}catch{return}})():void 0);i&&(r="function"==typeof i.get?i.get("authorization")??void 0:Array.isArray(i)?i.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(i).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let o={fetch:(e,r)=>(0,a.e)(e,r,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return r&&(o.headers={Authorization:r}),(0,s.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:o,cookies:{getAll:()=>t.getAll(),setAll(e){try{e.forEach(({name:e,value:r,options:s})=>t.set(e,r,s))}catch{}}}})}},77658:(e,r,t)=>{t.d(r,{e:()=>a});var s=t(47065);function n(e){if(!(e instanceof Error))return!1;let r=(e.message||"").toLowerCase(),t=e.cause?.code;return"AbortError"===e.name||r.includes("fetch failed")||r.includes("econnreset")||r.includes("etimedout")||r.includes("timeout")||r.includes("socket")||r.includes("tls")||r.includes("other side closed")||"UND_ERR_SOCKET"===t||"ECONNRESET"===t}async function a(e,r,t={}){let a=t.timeoutMs??3e4;try{return await (0,s.J)(async()=>{let{signal:s,cleanup:i}=function(e,r){let t=new AbortController,s=setTimeout(()=>t.abort(),r),n=null;return e&&(e.aborted?(clearTimeout(s),t.abort()):(n=()=>t.abort(),e.addEventListener("abort",n,{once:!0}))),{signal:t.signal,cleanup:()=>{clearTimeout(s),e&&n&&e.removeEventListener("abort",n)}}}(r?.signal,a);try{let n=new Headers(r?.headers);return t.keepAlive&&n.set("Connection","keep-alive"),await fetch(e,{...r,signal:s,headers:n})}catch(e){throw n(e),e}finally{i()}},{maxRetries:t.maxRetries??3,retryDelay:t.retryDelay??500,exponentialBackoff:t.exponentialBackoff??!0,onRetry:t.onRetry??(()=>{})})}catch(e){if(t.returnErrorResponseOnFailure&&n(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,r,t)=>{t.d(r,{J:()=>n,delay:()=>i,withRetryQuery:()=>a});let s={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function n(e,r={}){let t;let n={...s,...r};for(let r=0;r<=n.maxRetries;r++)try{return await e()}catch(s){if(t=s,r===n.maxRetries)throw s;let e=n.exponentialBackoff?n.retryDelay*Math.pow(2,r):n.retryDelay;n.onRetry&&s instanceof Error&&n.onRetry(r+1,s),await new Promise(r=>setTimeout(r,e))}throw t}async function a(e,r={}){return n(async()=>{let r=await e();if(r.error){let e=r.error,t=e.message||String(e);if(t.includes("ECONNRESET")||t.includes("fetch failed")||t.includes("network")||t.includes("timeout")||t.includes("ETIMEDOUT")||t.includes("socket")||t.includes("TLS"))throw e}return r},r)}async function i(e){return new Promise(r=>setTimeout(r,e))}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,7289,5972,4967,1988],()=>t(2586));module.exports=s})();