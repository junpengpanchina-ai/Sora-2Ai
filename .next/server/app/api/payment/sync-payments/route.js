"use strict";(()=>{var e={};e.id=7532,e.ids=[7532],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},26390:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>_});var a={};r.r(a),r.d(a,{POST:()=>f,dynamic:()=>p,revalidate:()=>y});var i=r(49303),n=r(88716),s=r(60670),o=r(60730),d=r(12131),c=r(69206),l=r(87070),u=r(53573),m=r(49320);let p="force-dynamic",y=0;async function f(){try{let t=await (0,o.e)(),{data:{user:r}}=await t.auth.getUser();if(!r)return l.NextResponse.json({error:"Unauthorized"},{status:401});let a=await (0,d.getOrCreateUser)(t,r);if(!a)return l.NextResponse.json({error:"User not found"},{status:404});let{data:i}=await t.from("users").select("email").eq("id",a.id).single(),n=i?.email||r.email;if(!n)return l.NextResponse.json({error:"User email not found"},{status:400});let s=(0,c.d)(),p=Math.floor(Date.now()/1e3)-604800,y=await s.checkout.sessions.list({limit:50,created:{gte:p}}),f=await s.paymentIntents.list({limit:50,created:{gte:p}}),h=[],g=[];async function e(e,r){if(!r||r<=0)return;let a=(0,m.Y)(r);if(a){let r=(0,m.G)(a.bonusExpiresDays),i=await (0,u.S_)(t,e,a.permanentCredits,a.bonusCredits,r,a.isStarter);i.success?console.log(`[sync-payments] Added credits for tier ${a.planId}:`,{permanent:a.permanentCredits,bonus:a.bonusCredits,expiresDays:a.bonusExpiresDays,isStarter:a.isStarter}):console.error("Failed to add credits to wallet:",i.error)}else{console.warn(`[sync-payments] Unrecognized payment amount: $${r}, using fallback logic`);let a=await (0,u.S_)(t,e,Math.round(100*r),0,null,!1);a.success||console.error("Failed to add credits to wallet (fallback):",a.error)}}for(let r of y.data){if("paid"!==r.payment_status)continue;let i=!1;if(r.customer_email===n)i=!0;else if(r.customer){if("string"==typeof r.customer)try{let e=await s.customers.retrieve(r.customer);!0!==e.deleted&&"email"in e&&e.email===n&&(i=!0)}catch{continue}else"object"==typeof r.customer&&"email"in r.customer&&r.customer.email===n&&(i=!0)}if(i)try{let{data:i}=await t.from("recharge_records").select("*").eq("payment_id",r.id).single(),n=r.amount_total?r.amount_total/100:0,s=new Date(1e3*r.created);if(!i){let i=new Date(s.getTime()-36e5),o=new Date(s.getTime()+36e5),{data:d}=await t.from("recharge_records").select("*").eq("user_id",a.id).eq("amount",n).gte("created_at",i.toISOString()).lte("created_at",o.toISOString()).order("created_at",{ascending:!1}).limit(1);if(d&&d.length>0){let i=d[0];await t.from("recharge_records").update({payment_id:r.id,status:"completed",completed_at:new Date().toISOString()}).eq("id",i.id),"completed"!==i.status&&await e(a.id,n),h.push({session_id:r.id,action:"matched_and_updated",recharge_id:i.id,amount:n});continue}}if(i)"completed"!==i.status?(await e(a.id,n),await t.from("recharge_records").update({status:"completed",completed_at:new Date().toISOString(),payment_id:r.id}).eq("id",i.id),h.push({session_id:r.id,action:"updated",recharge_id:i.id,amount:n})):i.payment_id&&!i.payment_id.startsWith("cs_")&&await t.from("recharge_records").update({payment_id:r.id}).eq("id",i.id);else{let i=r.amount_total?r.amount_total/100:0,n=Math.round(100*i),s=new Date(Date.now()-36e5),{data:o}=await t.from("recharge_records").select("*").eq("user_id",a.id).eq("amount",i).gte("created_at",s.toISOString()).limit(1);if(o&&o.length>0){let n=o[0];await t.from("recharge_records").update({payment_id:r.id,status:"completed",completed_at:new Date().toISOString()}).eq("id",n.id),"completed"!==n.status&&await e(a.id,i),h.push({session_id:r.id,action:"matched_existing",recharge_id:n.id,amount:i})}else{let{data:s,error:o}=await t.from("recharge_records").insert({user_id:a.id,amount:i,credits:n,payment_method:"stripe_payment_link",payment_id:r.id,status:"completed",completed_at:new Date().toISOString()}).select().single();s&&!o?(await e(a.id,i),h.push({session_id:r.id,action:"created",recharge_id:s.id,amount:i,credits:n})):g.push({session_id:r.id,error:o?.message??"Failed to create record"})}}}catch(e){g.push({session_id:r.id,error:e instanceof Error?e.message:"Unknown error"})}}for(let e of f.data)if("succeeded"===e.status){if(e.receipt_email!==n){if(!e.customer)continue;try{let t=await s.customers.retrieve(e.customer);if(!0===t.deleted||!("email"in t)||t.email!==n)continue}catch{continue}}try{let r=e.amount/100,i=new Date(1e3*e.created),{data:n}=await t.from("recharge_records").select("*").eq("payment_id",e.id).single();if(!n){let n=new Date(i.getTime()-36e5),s=new Date(i.getTime()+36e5),{data:o}=await t.from("recharge_records").select("*").eq("user_id",a.id).eq("amount",r).gte("created_at",n.toISOString()).lte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(1);if(o&&o.length>0){let i=o[0];if(await t.from("recharge_records").update({payment_id:e.id,status:"completed",completed_at:new Date().toISOString()}).eq("id",i.id),"completed"!==i.status){let{data:e}=await t.from("users").select("credits").eq("id",a.id).single(),r=(e?.credits??0)+i.credits;await t.from("users").update({credits:r}).eq("id",a.id)}h.push({payment_intent_id:e.id,action:"matched_and_updated",recharge_id:i.id,amount:r})}else{let i=Math.round(100*r),{data:n,error:s}=await t.from("recharge_records").insert({user_id:a.id,amount:r,credits:i,payment_method:"stripe_payment_link",payment_id:e.id,status:"completed",completed_at:new Date().toISOString()}).select().single();if(n&&!s){let{data:s}=await t.from("users").select("credits").eq("id",a.id).single(),o=(s?.credits??0)+i;await t.from("users").update({credits:o}).eq("id",a.id),h.push({payment_intent_id:e.id,action:"created",recharge_id:n.id,amount:r,credits:i})}}}}catch(t){g.push({payment_intent_id:e.id,error:t instanceof Error?t.message:"Unknown error"})}}return l.NextResponse.json({success:!0,synced_payments:h,errors:g,message:`Synced ${h.length} payment(s)`})}catch(e){return console.error("Failed to sync payments:",e),l.NextResponse.json({error:"Failed to sync payments",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/payment/sync-payments/route",pathname:"/api/payment/sync-payments",filename:"route",bundlePath:"app/api/payment/sync-payments/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/payment/sync-payments/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:w}=h,S="/api/payment/sync-payments/route";function x(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:_})}},49320:(e,t,r)=>{function a(e){if(.5>=Math.abs(e-4.9)){let e=new Date;return e.setDate(e.getDate()+7),{planId:"starter",permanentCredits:0,bonusCredits:200,bonusExpiresDays:7,isStarter:!0}}return .5>=Math.abs(e-39)?{planId:"creator",permanentCredits:2e3,bonusCredits:600,bonusExpiresDays:14,isStarter:!1}:.5>=Math.abs(e-99)?{planId:"studio",permanentCredits:6e3,bonusCredits:1500,bonusExpiresDays:30,isStarter:!1}:.5>=Math.abs(e-299)?{planId:"pro",permanentCredits:2e4,bonusCredits:4e3,bonusExpiresDays:60,isStarter:!1}:null}function i(e){let t=new Date;return t.setDate(t.getDate()+e),t.toISOString()}r.d(t,{G:()=>i,Y:()=>a})},69206:(e,t,r)=>{r.d(t,{d:()=>n});var a=r(91988);let i=null;function n(){if(!i){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not set in environment variables");try{i=new a.Z(e,{apiVersion:"2025-10-29.clover"})}catch(e){throw console.error("[Stripe] Failed to initialize Stripe client:",e),Error(`Failed to initialize Stripe: ${e instanceof Error?e.message:"Unknown error"}`)}}return i}n()},60730:(e,t,r)=>{r.d(t,{e:()=>s});var a=r(85602),i=r(71615),n=r(77658);async function s(e){let t;let r=await (0,i.cookies)(),s=e??("function"==typeof i.headers?(()=>{try{return(0,i.headers)()}catch{return}})():void 0);s&&(t="function"==typeof s.get?s.get("authorization")??void 0:Array.isArray(s)?s.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(s).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let o={fetch:(e,t)=>(0,n.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return t&&(o.headers={Authorization:t}),(0,a.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:o,cookies:{getAll:()=>r.getAll(),setAll(e){try{e.forEach(({name:e,value:t,options:a})=>r.set(e,t,a))}catch{}}}})}},77658:(e,t,r)=>{r.d(t,{e:()=>n});var a=r(47065);function i(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),r=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===r||"ECONNRESET"===r}async function n(e,t,r={}){let n=r.timeoutMs??3e4;try{return await (0,a.J)(async()=>{let{signal:a,cleanup:s}=function(e,t){let r=new AbortController,a=setTimeout(()=>r.abort(),t),i=null;return e&&(e.aborted?(clearTimeout(a),r.abort()):(i=()=>r.abort(),e.addEventListener("abort",i,{once:!0}))),{signal:r.signal,cleanup:()=>{clearTimeout(a),e&&i&&e.removeEventListener("abort",i)}}}(t?.signal,n);try{let i=new Headers(t?.headers);return r.keepAlive&&i.set("Connection","keep-alive"),await fetch(e,{...t,signal:a,headers:i})}catch(e){throw i(e),e}finally{s()}},{maxRetries:r.maxRetries??3,retryDelay:r.retryDelay??500,exponentialBackoff:r.exponentialBackoff??!0,onRetry:r.onRetry??(()=>{})})}catch(e){if(r.returnErrorResponseOnFailure&&i(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,r)=>{r.d(t,{J:()=>i,delay:()=>s,withRetryQuery:()=>n});let a={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function i(e,t={}){let r;let i={...a,...t};for(let t=0;t<=i.maxRetries;t++)try{return await e()}catch(a){if(r=a,t===i.maxRetries)throw a;let e=i.exponentialBackoff?i.retryDelay*Math.pow(2,t):i.retryDelay;i.onRetry&&a instanceof Error&&i.onRetry(t+1,a),await new Promise(t=>setTimeout(t,e))}throw r}async function n(e,t={}){return i(async()=>{let t=await e();if(t.error){let e=t.error,r=e.message||String(e);if(r.includes("ECONNRESET")||r.includes("fetch failed")||r.includes("network")||r.includes("timeout")||r.includes("ETIMEDOUT")||r.includes("socket")||r.includes("TLS"))throw e}return t},t)}async function s(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,7289,5972,4967,1988,2131],()=>r(26390));module.exports=a})();