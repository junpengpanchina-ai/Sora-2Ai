"use strict";(()=>{var e={};e.id=9103,e.ids=[9103,4525,6299],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},59649:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{POST:()=>d});var a=t(49303),o=t(88716),n=t(60670),i=t(87070),c=t(69206),l=t(60730),u=t(34525);async function d(e){try{let r,t;let s=e.headers.get("authorization");console.log("[create-plan-checkout] Request received",{hasAuthHeader:!!s,authHeaderPrefix:s?.substring(0,20)||"none",origin:e.headers.get("origin"),referer:e.headers.get("referer")});let a=await (0,l.e)(e.headers),{data:o,error:n}=await a.auth.getUser();if(console.log("[create-plan-checkout] Auth check",{hasUser:!!o.user,userId:o.user?.id,email:o.user?.email,authError:n?.message}),!o.user)return console.error("[create-plan-checkout] Unauthorized - no user",{authError:n?.message}),i.NextResponse.json({error:"Unauthorized, please login first"},{status:401});let{planId:d,deviceId:p}=await e.json();if(!d||"free"===d)return i.NextResponse.json({error:"Invalid plan ID"},{status:400});let m=u.PRICING_CONFIG.plans[d];if(!m)return i.NextResponse.json({error:"Plan not found"},{status:404});if("starter"===d){let r=e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||e.headers.get("x-real-ip")||e.headers.get("cf-connecting-ip")||null,t=null;if(r){let e=r.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/);e&&(t=`${e[1]}.${e[2]}.${e[3]}.0/24`)}let{data:s}=await a.from("purchases").select("id").eq("user_id",o.user.id).eq("plan_id","starter").eq("status","paid").limit(1).maybeSingle();if(s)return i.NextResponse.json({error:"Starter Access purchase not available",reason:"user_already_purchased_starter",details:"Starter Access is limited to one purchase per account."},{status:403});if(p){let{data:e}=await a.from("starter_purchase_guards").select("id").eq("device_id",p).limit(1).maybeSingle();if(e)return i.NextResponse.json({error:"Starter Access purchase not available",reason:"device_already_used_for_starter",details:"Starter Access is limited to one purchase per device."},{status:403})}if(t){let e=new Date(Date.now()-864e5).toISOString(),{data:r,error:s}=await a.from("starter_purchase_guards").select("id").eq("ip",t).gte("created_at",e);if(!s&&r&&r.length>=3)return i.NextResponse.json({error:"Starter Access purchase not available",reason:"too_many_starter_purchases_from_ip",details:"Too many Starter purchases from this IP address in the last 24 hours."},{status:403})}}let y="http://sora2aivideos.com";try{r=(0,c.d)(),console.log("[create-plan-checkout] Stripe client initialized")}catch(e){return console.error("[create-plan-checkout] Failed to initialize Stripe:",e),i.NextResponse.json({error:"Stripe configuration error",details:e instanceof Error?e.message:"Failed to initialize Stripe client"},{status:500})}let h={payment_method_types:["card"],line_items:[{price_data:{currency:"usd",product_data:{name:m.ui.title,description:m.ui.bullets?.join(". ")||""},unit_amount:Math.round(100*m.priceUsd)},quantity:1}],mode:"payment",success_url:`${y}/billing/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${y}/pricing?canceled=1`,customer_email:o.user.email||void 0,metadata:{user_id:o.user.id,plan_id:d,amount_usd:m.priceUsd.toString()}};console.log("[create-plan-checkout] Creating Stripe session",{planId:d,amount:m.priceUsd,baseUrl:y,customerEmail:o.user.email});try{t=await r.checkout.sessions.create(h)}catch(e){return console.error("[create-plan-checkout] Stripe API error:",{error:e,message:e.message,type:e.type,code:e.code,statusCode:e.statusCode,raw:e.raw}),i.NextResponse.json({error:"Failed to create checkout session",details:e.message||"Stripe API error",stripeErrorType:e.type,stripeErrorCode:e.code},{status:500})}return console.log("[create-plan-checkout] Checkout session created",{sessionId:t.id,checkoutUrl:t.url,userId:o.user.id,planId:d}),i.NextResponse.json({success:!0,checkout_url:t.url,session_id:t.id})}catch(e){return console.error("[create-plan-checkout] Error:",e,{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),i.NextResponse.json({error:"Failed to create checkout session",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/payment/create-plan-checkout/route",pathname:"/api/payment/create-plan-checkout",filename:"route",bundlePath:"app/api/payment/create-plan-checkout/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/payment/create-plan-checkout/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:h}=p,f="/api/payment/create-plan-checkout/route";function v(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},34525:(e,r,t)=>{t.d(r,{PRICING_CONFIG:()=>a});var s=t(76299);let a={currency:"USD",modelCosts:{sora:10,veo_fast:50,veo_pro:250},modelDisplay:{sora:"Sora",veo_fast:"Veo Fast",veo_pro:"Veo Pro"},signupGift:{bonusCredits:30,bonusExpiresInDays:7,note:"30 bonus credits expire in 7 days"},plans:{free:{priceUsd:0,permanentCredits:0,bonusCredits:0,bonusExpiresInDays:0,entitlements:{planId:"free",veoProEnabled:!1,priorityQueue:!1,maxConcurrency:1},caps:null,ui:{title:"Free",badge:"",cta:"Get started"}},starter:{priceUsd:s.v0.starter.priceUsd,permanentCredits:s.v0.starter.permanentCredits,bonusCredits:s.v0.starter.bonusCredits,bonusExpiresInDays:s.v0.starter.bonusExpiresDays,entitlements:{planId:s.v0.starter.planId,veoProEnabled:s.v0.starter.allowVeoPro,priorityQueue:!1,maxConcurrency:s.v0.starter.concurrency},caps:{soraPerDay:s.v0.starter.dailyCaps?.sora||6,veoFastPerDay:s.v0.starter.dailyCaps?.veo_fast||1,veoProPerDay:0},ui:{title:"Starter Access",badge:"Try the workflow (7 days)",cta:"Start with Starter",bullets:["Includes bonus credits for 7 days","Fair-use daily limits to keep the service reliable","Sora + Veo Fast available, Veo Pro locked"]},antiAbuse:{onePerUser:!0,onePerDevice:!0,onePerPaymentFingerprint:!0,maxStarterPerIpCidrPerDay:3}},creator:{priceUsd:s.v0.creator.priceUsd,permanentCredits:s.v0.creator.permanentCredits,bonusCredits:s.v0.creator.bonusCredits,bonusExpiresInDays:s.v0.creator.bonusExpiresDays,entitlements:{planId:s.v0.creator.planId,veoProEnabled:s.v0.creator.allowVeoPro,priorityQueue:!1,maxConcurrency:s.v0.creator.concurrency},caps:null,ui:{title:"Creator Pack",badge:"Recommended",cta:"Get Creator",bullets:["Permanent credits for ongoing creation","Unlocks Veo Pro for final exports","Better limits + smoother queue"]}},studio:{priceUsd:s.v0.studio.priceUsd,permanentCredits:s.v0.studio.permanentCredits,bonusCredits:s.v0.studio.bonusCredits,bonusExpiresInDays:s.v0.studio.bonusExpiresDays,entitlements:{planId:s.v0.studio.planId,veoProEnabled:s.v0.studio.allowVeoPro,priorityQueue:!0,maxConcurrency:s.v0.studio.concurrency},caps:null,ui:{title:"Studio Pack",badge:"Best value for Veo Pro",cta:"Get Studio",bullets:["Built for final exports and client work","More Veo Pro capacity per dollar","Priority queue + higher concurrency"]}},pro:{priceUsd:s.v0.pro.priceUsd,permanentCredits:s.v0.pro.permanentCredits,bonusCredits:s.v0.pro.bonusCredits,bonusExpiresInDays:s.v0.pro.bonusExpiresDays,entitlements:{planId:s.v0.pro.planId,veoProEnabled:s.v0.pro.allowVeoPro,priorityQueue:!0,maxConcurrency:s.v0.pro.concurrency},caps:null,ui:{title:"Pro Pack",badge:"For teams & heavy usage",cta:"Get Pro",bullets:["Highest value per credit","Best limits + fastest queue","Ideal for agencies and batch workflows"]}}},oneOffUpgrades:{veoProUpgrade:{priceUsd:14.9,bonusCredits:300,bonusExpiresInHours:48,ui:{title:"Veo Pro Upgrade",subtitle:"For the final export (48h)",cta:"Upgrade with Veo Pro"}}}}},76299:(e,r,t)=>{t.d(r,{planFromPaymentLink:()=>a,v0:()=>s});let s={starter:{planId:"starter",displayName:"Starter Access",priceUsd:4.9,paymentLinkId:"plink_1SjMNLDqGbi6No9vUku66neA",permanentCredits:0,bonusCredits:200,bonusExpiresDays:7,allowVeoPro:!1,concurrency:1,dailyCaps:{sora:6,veo_fast:1}},creator:{planId:"creator",displayName:"Creator Pack",priceUsd:39,paymentLinkId:"plink_1SRxHLDqGbi6No9vhu7i5iud",permanentCredits:2e3,bonusCredits:600,bonusExpiresDays:14,allowVeoPro:!0,concurrency:2},studio:{planId:"studio",displayName:"Studio Pack",priceUsd:99,paymentLinkId:"plink_1SmxBiDqGbi6No9v4L6dFvvK",permanentCredits:6e3,bonusCredits:1500,bonusExpiresDays:30,allowVeoPro:!0,concurrency:3},pro:{planId:"pro",displayName:"Pro Pack",priceUsd:299,paymentLinkId:"plink_1SNF1zDqGbi6No9vqtJXYMhQ",permanentCredits:2e4,bonusCredits:4e3,bonusExpiresDays:60,allowVeoPro:!0,concurrency:5}};function a(e){return Object.values(s).find(r=>r.paymentLinkId===e)??null}},69206:(e,r,t)=>{t.d(r,{d:()=>o});var s=t(91988);let a=null;function o(){if(!a){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not set in environment variables");try{a=new s.Z(e,{apiVersion:"2025-10-29.clover"})}catch(e){throw console.error("[Stripe] Failed to initialize Stripe client:",e),Error(`Failed to initialize Stripe: ${e instanceof Error?e.message:"Unknown error"}`)}}return a}o()},60730:(e,r,t)=>{t.d(r,{e:()=>n});var s=t(85602),a=t(71615),o=t(77658);async function n(e){let r;let t=await (0,a.cookies)(),n=e??("function"==typeof a.headers?(()=>{try{return(0,a.headers)()}catch{return}})():void 0);n&&(r="function"==typeof n.get?n.get("authorization")??void 0:Array.isArray(n)?n.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(n).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let i={fetch:(e,r)=>(0,o.e)(e,r,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return r&&(i.headers={Authorization:r}),(0,s.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:i,cookies:{getAll:()=>t.getAll(),setAll(e){try{e.forEach(({name:e,value:r,options:s})=>t.set(e,r,s))}catch{}}}})}},77658:(e,r,t)=>{t.d(r,{e:()=>o});var s=t(47065);function a(e){if(!(e instanceof Error))return!1;let r=(e.message||"").toLowerCase(),t=e.cause?.code;return"AbortError"===e.name||r.includes("fetch failed")||r.includes("econnreset")||r.includes("etimedout")||r.includes("timeout")||r.includes("socket")||r.includes("tls")||r.includes("other side closed")||"UND_ERR_SOCKET"===t||"ECONNRESET"===t}async function o(e,r,t={}){let o=t.timeoutMs??3e4;try{return await (0,s.J)(async()=>{let{signal:s,cleanup:n}=function(e,r){let t=new AbortController,s=setTimeout(()=>t.abort(),r),a=null;return e&&(e.aborted?(clearTimeout(s),t.abort()):(a=()=>t.abort(),e.addEventListener("abort",a,{once:!0}))),{signal:t.signal,cleanup:()=>{clearTimeout(s),e&&a&&e.removeEventListener("abort",a)}}}(r?.signal,o);try{let a=new Headers(r?.headers);return t.keepAlive&&a.set("Connection","keep-alive"),await fetch(e,{...r,signal:s,headers:a})}catch(e){throw a(e),e}finally{n()}},{maxRetries:t.maxRetries??3,retryDelay:t.retryDelay??500,exponentialBackoff:t.exponentialBackoff??!0,onRetry:t.onRetry??(()=>{})})}catch(e){if(t.returnErrorResponseOnFailure&&a(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,r,t)=>{t.d(r,{J:()=>a,delay:()=>n,withRetryQuery:()=>o});let s={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function a(e,r={}){let t;let a={...s,...r};for(let r=0;r<=a.maxRetries;r++)try{return await e()}catch(s){if(t=s,r===a.maxRetries)throw s;let e=a.exponentialBackoff?a.retryDelay*Math.pow(2,r):a.retryDelay;a.onRetry&&s instanceof Error&&a.onRetry(r+1,s),await new Promise(r=>setTimeout(r,e))}throw t}async function o(e,r={}){return a(async()=>{let r=await e();if(r.error){let e=r.error,t=e.message||String(e);if(t.includes("ECONNRESET")||t.includes("fetch failed")||t.includes("network")||t.includes("timeout")||t.includes("ETIMEDOUT")||t.includes("socket")||t.includes("TLS"))throw e}return r},r)}async function n(e){return new Promise(r=>setTimeout(r,e))}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,7289,5972,4967,1988],()=>t(59649));module.exports=s})();