"use strict";(()=>{var e={};e.id=149,e.ids=[149,6527],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},93977:e=>{e.exports=require("node:fs/promises")},38665:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>k,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var s={};t.r(s),t.d(s,{POST:()=>g,dynamic:()=>f,revalidate:()=>p});var o=t(49303),n=t(88716),a=t(60670),i=t(60730),c=t(66527),d=t(87070),u=t(91585),l=t(26033);let f="force-dynamic",p=0,m=u.Ry({id:u.Z_(),results:u.IX(u.Ry({url:u.Z_(),removeWatermark:u.O7().optional(),pid:u.Z_().optional()})).optional(),url:u.Z_().optional(),progress:u.Rx().min(0).max(100),status:u.Km(["running","succeeded","failed"]),failure_reason:u.Km(["output_moderation","input_moderation","error"]).optional(),error:u.Z_().optional()});async function g(e){try{let r,s,o;let n=await e.json(),a=m.parse(n),u=await (0,i.e)(),{data:l,error:f}=await u.from("video_tasks").select("*, model").eq("grsai_task_id",a.id).single();if(f||!l)return console.error("Task not found:",a.id,f),d.NextResponse.json({success:!0,message:"Task not found, but recorded"});let p={progress:a.progress,status:"running"===a.status?"processing":"succeeded"===a.status?"succeeded":"failed"===a.status?"failed":"processing"},g=l?.model?.startsWith("veo")||!1;if(g?r=a.url:(r=a.results?.[0]?.url,s=a.results?.[0]?.removeWatermark,o=a.results?.[0]?.pid),"succeeded"===a.status&&r){if("true"===process.env.R2_AUTO_UPLOAD_VIDEOS)try{let{uploadVideoFromUrl:e}=await Promise.all([t.e(688),t.e(7192)]).then(t.bind(t,97192)),s=`videos/${l.id}.mp4`;console.log("[video/callback] Starting video upload to R2:",{taskId:l.id,originalUrl:r,r2Key:s});let o=await e(r,s);p.video_url=o,console.log("[video/callback] ✅ Video successfully uploaded to R2 with original quality:",{taskId:l.id,r2Url:o,originalUrl:r,qualityCheck:"You can verify quality at /api/video/check-quality/"+l.id})}catch(e){console.warn("[video/callback] ⚠️ Failed to upload video to R2, using original URL:",{taskId:l.id,error:e instanceof Error?e.message:String(e),fallbackUrl:r}),p.video_url=r}else p.video_url=r,console.log("[video/callback] Using original API URL (R2_AUTO_UPLOAD_VIDEOS=false to save storage):",{taskId:l.id,originalUrl:r,note:"Video can be uploaded to R2 on-demand when needed"});g||(p.remove_watermark=s??!0,p.pid=o||null),p.completed_at=new Date().toISOString()}if("failed"===a.status){p.failure_reason=a.failure_reason||null,p.error_message=a.error||null,p.completed_at=new Date().toISOString();let e=await (0,c.refundCreditsByVideoTaskId)(u,l.user_id,l.id);e.success||console.error("Failed to refund credits:",e.error)}let{error:y}=await u.from("video_tasks").update(p).eq("id",l.id);if(y)return console.error("Failed to update task status:",y),d.NextResponse.json({error:"Failed to update task status",details:y.message},{status:500});return d.NextResponse.json({success:!0,message:"Callback processed successfully",task_id:l.id,status:a.status})}catch(e){if(console.error("Failed to process webhook callback:",e),e instanceof l.jm)return d.NextResponse.json({error:"Callback data validation failed",details:e.errors},{status:400});return d.NextResponse.json({success:!0,message:"Callback received, but error occurred during processing",error:e instanceof Error?e.message:"Unknown error"})}}let y=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/video/callback/route",pathname:"/api/video/callback",filename:"route",bundlePath:"app/api/video/callback/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/video/callback/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:_,serverHooks:h}=y,k="/api/video/callback/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},53573:(e,r,t)=>{async function s(e,r,t,s){try{let{data:o,error:n}=await e.rpc("deduct_credits_from_wallet",{user_uuid:r,credits_needed:t,model_type:s});if(n)return console.error("Error deducting credits:",n),{success:!1,error:n.message};if(!o||!o.success)return{success:!1,error:o?.error||"Failed to deduct credits"};return{success:!0,bonusUsed:o.bonus_used||0,permanentUsed:o.permanent_used||0,remainingCredits:o.remaining_credits||0}}catch(e){return console.error("Error in deductCreditsFromWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function o(e,r,t=0,s=0,o,n=!1){try{let{data:a,error:i}=await e.rpc("add_credits_to_wallet",{user_uuid:r,permanent_amount:t,bonus_amount:s,bonus_expires_at:o||null,is_starter:n});if(i)return console.error("Error adding credits:",i),{success:!1,error:i.message};if(!a||!a.success)return{success:!1,error:a?.error||"Failed to add credits"};return{success:!0}}catch(e){return console.error("Error in addCreditsToWallet:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}t.d(r,{A8:()=>s,S_:()=>o})},66527:(e,r,t)=>{t.d(r,{AP:()=>c,Fw:()=>a,Tb:()=>o,dp:()=>n,refundCreditsByVideoTaskId:()=>i});var s=t(53573);function o(e){switch(e){case"sora-2":default:return 10;case"veo-flash":return 50;case"veo-pro":return 250}}async function n(e,r,t,n,a){try{let i=a||"sora-2",c=o(i),d=await (0,s.A8)(e,r,c,i);if(!d.success)return{success:!1,error:d.error||"Insufficient credits"};let u={user_id:r,video_task_id:t,credits:c,description:n||`Video generation (${i})`,status:"completed",model_type:i},{data:l,error:f}=await e.from("consumption_records").insert(u).select().single();if(f)return console.error("Failed to create consumption record after wallet deduction:",f),{success:!0};return{success:!0,consumptionId:l.id}}catch(e){return console.error("Error in deductCredits:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function a(e,r,t){try{let{data:o,error:n}=await e.from("consumption_records").select("*").eq("id",t).single();if(n||!o)return{success:!1,error:"Consumption record not found"};if("refunded"===o.status)return{success:!1,error:"Credits already refunded"};let a=o.credits||0;if(a<=0)return{success:!1,error:"Invalid credits amount to refund"};let i=await (0,s.S_)(e,r,a,0,null,!1);if(!i.success)return console.error("Failed to refund credits to wallet:",i.error),{success:!1,error:i.error||"Failed to refund credits"};let{error:c}=await e.from("consumption_records").update({status:"refunded",refunded_at:new Date().toISOString()}).eq("id",t);return c&&console.error("Failed to update consumption record:",c),{success:!0}}catch(e){return console.error("Error in refundCredits:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function i(e,r,t){try{let{data:s,error:o}=await e.from("consumption_records").select("*").eq("user_id",r).eq("video_task_id",t).eq("status","completed").single();if(o||!s)return{success:!1,error:"Consumption record not found"};return await a(e,r,s.id)}catch(e){return console.error("Error in refundCreditsByVideoTaskId:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function c(e,r){try{let{data:t,error:o}=await e.from("recharge_records").insert({user_id:r,amount:3,credits:30,payment_method:"system",status:"completed",metadata:{type:"welcome_bonus"}}).select().single();if(o||!t)return console.error("Failed to create welcome bonus recharge record:",o),{success:!1,error:"Failed to create welcome bonus recharge record"};let n=await (0,s.S_)(e,r,30,0,null,!1);if(!n.success)return console.error("Failed to add welcome bonus to wallet:",n.error),{success:!1,error:n.error||"Failed to add welcome bonus to wallet"};return console.log(`[addWelcomeBonus] Successfully added 30 credits to wallet for user ${r}`),{success:!0,rechargeRecordId:t.id}}catch(e){return console.error("Error in addWelcomeBonus:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}},60730:(e,r,t)=>{t.d(r,{e:()=>a});var s=t(85602),o=t(71615),n=t(77658);async function a(e){let r;let t=await (0,o.cookies)(),a=e??("function"==typeof o.headers?(()=>{try{return(0,o.headers)()}catch{return}})():void 0);a&&(r="function"==typeof a.get?a.get("authorization")??void 0:Array.isArray(a)?a.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(a).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let i={fetch:(e,r)=>(0,n.e)(e,r,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return r&&(i.headers={Authorization:r}),(0,s.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:i,cookies:{getAll:()=>t.getAll(),setAll(e){try{e.forEach(({name:e,value:r,options:s})=>t.set(e,r,s))}catch{}}}})}},77658:(e,r,t)=>{t.d(r,{e:()=>n});var s=t(47065);function o(e){if(!(e instanceof Error))return!1;let r=(e.message||"").toLowerCase(),t=e.cause?.code;return"AbortError"===e.name||r.includes("fetch failed")||r.includes("econnreset")||r.includes("etimedout")||r.includes("timeout")||r.includes("socket")||r.includes("tls")||r.includes("other side closed")||"UND_ERR_SOCKET"===t||"ECONNRESET"===t}async function n(e,r,t={}){let n=t.timeoutMs??3e4;try{return await (0,s.J)(async()=>{let{signal:s,cleanup:a}=function(e,r){let t=new AbortController,s=setTimeout(()=>t.abort(),r),o=null;return e&&(e.aborted?(clearTimeout(s),t.abort()):(o=()=>t.abort(),e.addEventListener("abort",o,{once:!0}))),{signal:t.signal,cleanup:()=>{clearTimeout(s),e&&o&&e.removeEventListener("abort",o)}}}(r?.signal,n);try{let o=new Headers(r?.headers);return t.keepAlive&&o.set("Connection","keep-alive"),await fetch(e,{...r,signal:s,headers:o})}catch(e){throw o(e),e}finally{a()}},{maxRetries:t.maxRetries??3,retryDelay:t.retryDelay??500,exponentialBackoff:t.exponentialBackoff??!0,onRetry:t.onRetry??(()=>{})})}catch(e){if(t.returnErrorResponseOnFailure&&o(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,r,t)=>{t.d(r,{J:()=>o,delay:()=>a,withRetryQuery:()=>n});let s={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function o(e,r={}){let t;let o={...s,...r};for(let r=0;r<=o.maxRetries;r++)try{return await e()}catch(s){if(t=s,r===o.maxRetries)throw s;let e=o.exponentialBackoff?o.retryDelay*Math.pow(2,r):o.retryDelay;o.onRetry&&s instanceof Error&&o.onRetry(r+1,s),await new Promise(r=>setTimeout(r,e))}throw t}async function n(e,r={}){return o(async()=>{let r=await e();if(r.error){let e=r.error,t=e.message||String(e);if(t.includes("ECONNRESET")||t.includes("fetch failed")||t.includes("network")||t.includes("timeout")||t.includes("ETIMEDOUT")||t.includes("socket")||t.includes("TLS"))throw e}return r},r)}async function a(e){return new Promise(r=>setTimeout(r,e))}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,7289,5972,4967,1585],()=>t(38665));module.exports=s})();