"use strict";(()=>{var e={};e.id=8790,e.ids=[8790],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},93977:e=>{e.exports=require("node:fs/promises")},37921:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>f,dynamic:()=>c,revalidate:()=>p});var a=r(49303),i=r(88716),o=r(60670),n=r(60730),l=r(49606),u=r(40699),d=r(87070);let c="force-dynamic",p=0;async function f(e,{params:t}){try{let s=await (0,n.e)(e.headers),{data:{user:a}}=await s.auth.getUser();if(!a)return d.NextResponse.json({error:"Unauthorized, please login first"},{status:401});let i=t.id,o=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(i),c=i,p=null,f=null;if(o){let{data:e,error:t}=await s.from("video_tasks").select("grsai_task_id, status, progress, video_url, error_message, model").eq("id",i).single();if(t||!e)return d.NextResponse.json({success:!1,status:"failed",error:"Task not found in database",task_id:i},{status:404});if(f=e,"succeeded"===f.status&&f.video_url)return d.NextResponse.json({success:!0,status:"succeeded",progress:f.progress||100,video_url:f.video_url,task_id:i});if("failed"===f.status)return d.NextResponse.json({success:!1,status:"failed",error:f.error_message||"Generation failed",task_id:i});if(!f.grsai_task_id)return d.NextResponse.json({success:!1,status:"failed",error:"Grsai task ID not found, task may not have been created",task_id:i},{status:404});c=f.grsai_task_id,p=i}try{if(!c||""===c.trim()){if(console.error("[video/result] Invalid grsaiTaskId:",c),p){let{refundCreditsByVideoTaskId:e}=await r.e(6527).then(r.bind(r,66527)),{getOrCreateUser:t}=await r.e(2131).then(r.bind(r,12131)),i=await t(s,a);i&&await e(s,i.id,p),await s.from("video_tasks").update({status:"failed",error_message:"Invalid Grsai task ID",completed_at:new Date().toISOString()}).eq("id",p)}return d.NextResponse.json({success:!1,status:"failed",error:"Invalid task ID",task_id:p||i},{status:400})}console.log("[video/result] Fetching task result:",{grsaiTaskId:c,internalTaskId:p});let e=await (0,l.getTaskResult)(c);if(console.log("[video/result] Grsai API response:",{code:e.code,hasData:!!e.data}),0===e.code&&e.data){let t,i,o;let n=e.data,l=f?.model||null,m=l?.startsWith("veo")||!1;if(m?t=n.url:(t=n.results?.[0]?.url,i=n.results?.[0]?.removeWatermark,o=n.results?.[0]?.pid),"succeeded"===n.status&&t){let e=t,a=e,l="true"===process.env.R2_AUTO_UPLOAD_VIDEOS;if(p&&l)try{let{uploadVideoFromUrl:t}=await Promise.all([r.e(688),r.e(7192)]).then(r.bind(r,97192)),s=`videos/${p}.mp4`;console.log("[video/result] Starting video upload to R2:",{taskId:p,originalUrl:e,r2Key:s}),a=await t(e,s),console.log("[video/result] ✅ Video successfully uploaded to R2 with original quality:",{taskId:p,r2Url:a,originalUrl:e,qualityCheck:"You can verify quality at /api/video/check-quality/"+p})}catch(t){console.warn("[video/result] ⚠️ Failed to upload video to R2, using original URL:",{taskId:p,error:t instanceof Error?t.message:String(t),fallbackUrl:e})}if(p){let e={status:"succeeded",progress:n.progress,video_url:a,completed_at:new Date().toISOString()};m||void 0===i||(e.remove_watermark=i),!m&&o&&(e.pid=o),await s.from("video_tasks").update(e).eq("id",p)}let u={success:!0,status:"succeeded",progress:n.progress,video_url:a,task_id:p||c};return!m&&(u.remove_watermark=i??!0,o&&(u.pid=o)),d.NextResponse.json(u)}if("failed"!==n.status)return p&&await s.from("video_tasks").update({status:"processing",progress:n.progress}).eq("id",p),d.NextResponse.json({success:!0,status:"processing",progress:n.progress,task_id:p||c});{let e=(0,u._)({failureReason:n.failure_reason,error:n.error,fallback:"Video generation failed because the upstream service rejected the request."});if(p){let{refundCreditsByVideoTaskId:t}=await r.e(6527).then(r.bind(r,66527)),{getOrCreateUser:i}=await r.e(2131).then(r.bind(r,12131)),o=await i(s,a);o&&await t(s,o.id,p),await s.from("video_tasks").update({status:"failed",progress:n.progress,error_message:e.message,failure_reason:n.failure_reason||null,completed_at:new Date().toISOString()}).eq("id",p)}return d.NextResponse.json({success:!1,status:"failed",progress:n.progress,error:e.message,violation_type:e.violationType,task_id:p||c})}}if(-22===e.code){let e=(0,u._)({grsaiCode:-22,fallback:"Task not found in upstream service."});if(p){let{refundCreditsByVideoTaskId:t}=await r.e(6527).then(r.bind(r,66527)),{getOrCreateUser:i}=await r.e(2131).then(r.bind(r,12131)),o=await i(s,a);o&&await t(s,o.id,p),await s.from("video_tasks").update({status:"failed",error_message:e.message,completed_at:new Date().toISOString()}).eq("id",p)}return d.NextResponse.json({success:!1,status:"failed",error:e.message,violation_type:e.violationType,task_id:p||c},{status:404})}{let t=(0,u._)({msg:e.msg,fallback:"Failed to fetch task result from upstream service."});return d.NextResponse.json({success:!1,error:t.message,violation_type:t.violationType,task_id:p||c},{status:500})}}catch(e){if(console.error("[video/result] Failed to fetch Grsai task result:",{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,grsaiTaskId:c,internalTaskId:p}),p)try{let{refundCreditsByVideoTaskId:t}=await r.e(6527).then(r.bind(r,66527)),{getOrCreateUser:i}=await r.e(2131).then(r.bind(r,12131)),o=await i(s,a);o&&await t(s,o.id,p),await s.from("video_tasks").update({status:"failed",error_message:`Grsai API error: ${e instanceof Error?e.message:"Unknown error"}`,completed_at:new Date().toISOString()}).eq("id",p)}catch(e){console.error("[video/result] Failed to refund credits:",e)}return d.NextResponse.json({success:!1,status:"failed",error:"Failed to fetch task result from Grsai API",details:e instanceof Error?e.message:"Unknown error",task_id:p||c},{status:500})}}catch(e){return console.error("[video/result] Unexpected error:",{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),d.NextResponse.json({success:!1,error:"Failed to fetch task result",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/video/result/[id]/route",pathname:"/api/video/result/[id]",filename:"route",bundlePath:"app/api/video/result/[id]/route"},resolvedPagePath:"/Users/p/Documents/GitHub/Sora-2Ai/app/api/video/result/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:h}=m,v="/api/video/result/[id]/route";function k(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},40699:(e,t,r)=>{r.d(t,{_:()=>a});let s={input_moderation:"Prompt rejected: it contains violent, adult, hateful, or illegal content. Please rewrite it in neutral, policy-compliant language.",output_moderation:"The generated video triggered output guardrails (graphic violence, nudity, or other unsafe visuals). Try a simpler, safer description.",third_party:"Blocked by intellectual-property guardrails. Avoid referencing real brands, trademarks, celebrities, or copyrighted characters."};function a({failureReason:e,error:t,msg:r,fallback:a,httpStatus:i,grsaiCode:o}={}){let n=e?.toLowerCase();if(n&&s[n])return{message:s[n],violationType:n};if(t&&/third[-\s]?party|copyright|trademark/i.test(t))return{message:s.third_party,violationType:"third_party"};if("number"==typeof o&&-22===o)return{message:"The upstream task could not be found. This request has been cancelled and any credits have been refunded automatically."};if(404===i)return{message:"Upstream service returned 404 (task not found). The task was cancelled and your credits were refunded automatically."};let l=(t||r)?.trim();if(l&&/system error|system error please try again/i.test(l))return{message:"The video generation service encountered a system error. This is usually temporary. Please try again in a few minutes. Your credits have been automatically refunded."};if(l&&/failed to generate/i.test(l))return{message:l.includes("system error")?"The video generation service encountered a system error. Please try again in a few minutes. Your credits have been automatically refunded.":`Video generation failed. ${l}. Your credits have been automatically refunded.`};let u=a||"Video generation failed because the upstream service returned an unexpected error. Please try again in a few minutes. Your credits have been automatically refunded.";return l&&(u+=` Details: ${l}`),{message:u}}},60730:(e,t,r)=>{r.d(t,{e:()=>o});var s=r(85602),a=r(71615),i=r(77658);async function o(e){let t;let r=await (0,a.cookies)(),o=e??("function"==typeof a.headers?(()=>{try{return(0,a.headers)()}catch{return}})():void 0);o&&(t="function"==typeof o.get?o.get("authorization")??void 0:Array.isArray(o)?o.find(([e])=>"authorization"===e.toLowerCase())?.[1]:Object.entries(o).find(([e])=>"authorization"===e.toLowerCase())?.[1]??void 0);let n={fetch:(e,t)=>(0,i.e)(e,t,{timeoutMs:3e4,keepAlive:!0,maxRetries:5,retryDelay:500,exponentialBackoff:!0,returnErrorResponseOnFailure:!0})};return t&&(n.headers={Authorization:t}),(0,s.l)("https://hgzpzsiafycwlqrkzbis.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnenB6c2lhZnljd2xxcmt6YmlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk4NzIsImV4cCI6MjA3ODE5NTg3Mn0.WdpkrSXVZVZ64bY8NXG6Bpf-w59i305F7agny6wuj_Q",{global:n,cookies:{getAll:()=>r.getAll(),setAll(e){try{e.forEach(({name:e,value:t,options:s})=>r.set(e,t,s))}catch{}}}})}},77658:(e,t,r)=>{r.d(t,{e:()=>i});var s=r(47065);function a(e){if(!(e instanceof Error))return!1;let t=(e.message||"").toLowerCase(),r=e.cause?.code;return"AbortError"===e.name||t.includes("fetch failed")||t.includes("econnreset")||t.includes("etimedout")||t.includes("timeout")||t.includes("socket")||t.includes("tls")||t.includes("other side closed")||"UND_ERR_SOCKET"===r||"ECONNRESET"===r}async function i(e,t,r={}){let i=r.timeoutMs??3e4;try{return await (0,s.J)(async()=>{let{signal:s,cleanup:o}=function(e,t){let r=new AbortController,s=setTimeout(()=>r.abort(),t),a=null;return e&&(e.aborted?(clearTimeout(s),r.abort()):(a=()=>r.abort(),e.addEventListener("abort",a,{once:!0}))),{signal:r.signal,cleanup:()=>{clearTimeout(s),e&&a&&e.removeEventListener("abort",a)}}}(t?.signal,i);try{let a=new Headers(t?.headers);return r.keepAlive&&a.set("Connection","keep-alive"),await fetch(e,{...t,signal:s,headers:a})}catch(e){throw a(e),e}finally{o()}},{maxRetries:r.maxRetries??3,retryDelay:r.retryDelay??500,exponentialBackoff:r.exponentialBackoff??!0,onRetry:r.onRetry??(()=>{})})}catch(e){if(r.returnErrorResponseOnFailure&&a(e))return new Response(JSON.stringify({error:"fetch_failed",message:e instanceof Error?e.message:String(e)}),{status:503,headers:{"content-type":"application/json"}});throw e}}},47065:(e,t,r)=>{r.d(t,{J:()=>a,delay:()=>o,withRetryQuery:()=>i});let s={maxRetries:3,retryDelay:1e3,exponentialBackoff:!0,onRetry:()=>{}};async function a(e,t={}){let r;let a={...s,...t};for(let t=0;t<=a.maxRetries;t++)try{return await e()}catch(s){if(r=s,t===a.maxRetries)throw s;let e=a.exponentialBackoff?a.retryDelay*Math.pow(2,t):a.retryDelay;a.onRetry&&s instanceof Error&&a.onRetry(t+1,s),await new Promise(t=>setTimeout(t,e))}throw r}async function i(e,t={}){return a(async()=>{let t=await e();if(t.error){let e=t.error,r=e.message||String(e);if(r.includes("ECONNRESET")||r.includes("fetch failed")||r.includes("network")||r.includes("timeout")||r.includes("ETIMEDOUT")||r.includes("socket")||r.includes("TLS"))throw e}return t},t)}async function o(e){return new Promise(t=>setTimeout(t,e))}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,7289,5972,4967,9606],()=>r(37921));module.exports=s})();